<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="ä¸€ä¸ªç§˜å¯†ç©ºé—´" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>å¤§æ¨¡å‹å¾®è°ƒï¼šSFTï¼ˆLoRAã€Prefixï¼‰å’ŒRLHF |  LegendLeo Chen çš„ç©ºé—´</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/mylogo.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
<!-- å°é¢æ ‡é—ªçƒ -->
<link rel="stylesheet" href="/css/zhyBlogTitle.css">
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<!-- jqueryï¼Œæ‡’åŠ è½½ã€ç»Ÿè®¡ã€è¯´è¯´éœ€è¦çš„jquery -->
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-å¤§æ¨¡å‹å¾®è°ƒï¼šSFTï¼ˆLoRAã€Prefixï¼‰å’ŒRLHF"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  å¤§æ¨¡å‹å¾®è°ƒï¼šSFTï¼ˆLoRAã€Prefixï¼‰å’ŒRLHF
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2025/02/06/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83%EF%BC%9ASFT%EF%BC%88LoRA%E3%80%81Prefix%EF%BC%89%E5%92%8CRLHF/" class="article-date">
  <time datetime="2025-02-06T12:22:13.000Z" itemprop="datePublished">2025-02-06</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/">å¼ºåŒ–å­¦ä¹ </a> / <a class="article-category-link" href="/categories/%E6%95%99%E7%A8%8B/">æ•™ç¨‹</a> / <a class="article-category-link" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">æ·±åº¦å­¦ä¹ </a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> å­—æ•°ç»Ÿè®¡:</span>
            <span class="post-count">3.6k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> é˜…è¯»æ—¶é•¿â‰ˆ</span>
            <span class="post-count">17 åˆ†é’Ÿ</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p>æœ¬æ¬¡å€ŸåŠ©huggingfaceå¹³å°ä¸‹è½½å¤§æ¨¡å‹å’Œæ•°æ®é›†ï¼Œå¹¶åœ¨æœ¬åœ°å°è¯•è¿›è¡Œå¾®è°ƒï¼Œç›®çš„æ˜¯è·‘é€šå¹¶ä½“éªŒå¾®è°ƒè¿‡ç¨‹ã€‚å¾®è°ƒä½¿ç”¨çš„æ˜¯å‚æ•°é«˜æ•ˆå¾®è°ƒä¹Ÿå°±æ˜¯PEFTï¼Œç­–ç•¥æ˜¯æœ‰ç›‘ç£å¾®è°ƒSFTï¼ˆLoRAå’ŒPrefixï¼‰å’ŒRLHFã€‚<span id="more"></span><br><strong>æ³¨æ„ï¼šhuggingfaceä¸‹è½½éƒ½æ˜¯éœ€è¦ä»£ç†çš„ï¼Œæ–‡ä¸­å‡ºç°çš„pythonåº“è‡ªè¡Œç”¨pipå®‰è£…å³å¯ã€‚</strong></p>
<h1 id="ğŸ”¥æ¨¡å‹ä¸‹è½½"><a href="#ğŸ”¥æ¨¡å‹ä¸‹è½½" class="headerlink" title="ğŸ”¥æ¨¡å‹ä¸‹è½½"></a>ğŸ”¥æ¨¡å‹ä¸‹è½½</h1><p><a target="_blank" rel="noopener" href="https://huggingface.co/">huggingface</a>ä¸Šé€‰æ‹©æ¨¡å‹ï¼Œè¿™é‡Œä»¥Qwen&#x2F;Qwen2.5-3B-Instructä¸ºä¾‹ã€‚</p>
<ul>
<li><p>å¦‚ä¸‹å›¾å¯ä»¥ç›´æ¥åœ¨ç•Œé¢ä¸­çš„files and versionsä¸­ä¸‹è½½æ¨¡å‹ï¼ŒæŠŠæ‰€æœ‰æ–‡ä»¶ä¸‹è½½è¿›ä¸€ä¸ªæ–‡ä»¶å¤¹å³å¯ã€‚<br><img src="/2025/02/06/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83%EF%BC%9ASFT%EF%BC%88LoRA%E3%80%81Prefix%EF%BC%89%E5%92%8CRLHF/%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9.jpg" alt="huggingfaceæ¨¡å‹ç•Œé¢"></p>
</li>
<li><p>ä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œä¸€æ¬¡æ€§ä¸‹è½½ï¼Œå…ˆé€šè¿‡<code>pip install -U huggingface_hub</code>å®‰è£…å‘½ä»¤è¡Œå·¥å…·ï¼Œåœ¨cmdä¸­é€šè¿‡ä»¥ä¸‹æŒ‡ä»¤ç™»å½•huggingfaceå¹¶ä¸‹è½½æ¨¡å‹ï¼š</p>
</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">huggingface-cli login
huggingface-cli download --resume-download Qwen/Qwen2.5-3B-Instruct --local-dir D://ä½ çš„å­˜å‚¨è·¯å¾„
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>é¦–å…ˆç¬¬ä¸€å¥æŒ‡ä»¤ç™»å½•ï¼Œä¼šè®©ä½ è¾“å…¥huggingfaceä¸ªäººè´¦æˆ·ç•Œé¢çš„access tokensçš„ä»¤ç‰Œï¼Œè¾“å…¥åå³å¯é€šè¿‡ç¬¬äºŒæ¡æŒ‡ä»¤ä¸‹è½½æ¨¡å‹åˆ°æŒ‡å®šä½ç½®ã€‚</li>
</ul>
<h1 id="ğŸ”¥æ•°æ®é›†ä¸‹è½½"><a href="#ğŸ”¥æ•°æ®é›†ä¸‹è½½" class="headerlink" title="ğŸ”¥æ•°æ®é›†ä¸‹è½½"></a>ğŸ”¥æ•°æ®é›†ä¸‹è½½</h1><p><a target="_blank" rel="noopener" href="https://huggingface.co/">huggingface</a>ä¸Šé€‰æ‹©æ•°æ®é›†ï¼Œä»¥å¼±æ™ºå§æ•°æ®é›† LooksJuicy&#x2F;ruozhiba ä¸ºä¾‹ã€‚</p>
<ul>
<li>é€šè¿‡pythonçš„datasetsåº“å¯ä»¥ç›´æ¥ä¸‹è½½æºæ–‡ä»¶ï¼š</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> datasets <span class="token keyword">import</span> Dataset<span class="token punctuation">,</span> load_dataset<span class="token punctuation">,</span> load_from_disk
<span class="token keyword">import</span> os

<span class="token comment" spellcheck="true"># é…ç½®ä½ çš„ä»£ç†</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'HTTP_PROXY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'http://127.0.0.1:7890'</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'HTTPS_PROXY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'http://127.0.0.1:7890'</span>

dataset <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span><span class="token string">"LooksJuicy/ruozhiba"</span><span class="token punctuation">,</span> split<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">)</span>
dataset<span class="token punctuation">.</span>save_to_disk<span class="token punctuation">(</span><span class="token string">"./datasets/ruozhiba"</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ä¿å­˜åˆ°è¯¥ç›®å½•ä¸‹</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2025/02/06/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83%EF%BC%9ASFT%EF%BC%88LoRA%E3%80%81Prefix%EF%BC%89%E5%92%8CRLHF/%E6%95%B0%E6%8D%AE%E9%9B%86%E6%A0%BC%E5%BC%8F.jpg" alt="æ•°æ®é›†æ ¼å¼"></p>
<ul>
<li>è¿™æ ·åªæ˜¯ä¸‹è½½æºæ–‡ä»¶æ²¡æœ‰è¿›è¡Œå¤„ç†ï¼Œåœ¨å®˜ç½‘å¯ä»¥é¢„è§ˆæ–‡ä»¶å†…å®¹å¦‚ä¸Šï¼Œè¯¥æ•°æ®é›†ç”± instruction å’Œ output ç»„æˆï¼Œæ¯”è¾ƒç®€å•ã€‚</li>
<li>æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡å¦‚ä¸‹ä»£ç è¿›è¡Œé¢„å¤„ç†ï¼Œæ€è·¯å°±æ˜¯ç¼“å­˜æ•°æ®é›†æºæ–‡ä»¶å¹¶è½¬æ¢æˆå¯ä»¥ç”¨äºè®­ç»ƒçš„messageï¼ˆjsonæ ¼å¼ï¼‰ï¼Œæœ€åä¿å­˜åˆ°jsonæ–‡ä»¶å½“ä¸­ï¼Œè¿™æ¬¡ä¸åˆ’åˆ†æ•°æ®é›†ï¼Œç›´æ¥å…¨éƒ¨ç”¨äºè®­ç»ƒã€‚</li>
<li>ç¼“å­˜æ˜¯ä¸ä¼šè‡ªåŠ¨æ¸…æ‰çš„ï¼Œå¯ä»¥åœ¨Cç›˜çš„.cacheé‡Œé¢æ‰‹åŠ¨åˆ æ‰ã€‚</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> datasets <span class="token keyword">import</span> load_from_disk<span class="token punctuation">,</span> load_dataset
<span class="token keyword">import</span> os

<span class="token comment" spellcheck="true"># é…ç½®ä»£ç†</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'HTTP_PROXY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'http://127.0.0.1:7890'</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'HTTPS_PROXY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'http://127.0.0.1:7890'</span>
<span class="token comment" spellcheck="true"># ç³»ç»Ÿ promptï¼Œå¯ä»¥è‡ªè¡Œè®¾ç½®</span>
system_message <span class="token operator">=</span> <span class="token string">"å›ç­”é—®é¢˜"</span>

<span class="token comment" spellcheck="true"># è½¬æ¢ä¸º messages</span>
<span class="token keyword">def</span> <span class="token function">create_conversation</span><span class="token punctuation">(</span>sample<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">"messages"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> system_message<span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> sample<span class="token punctuation">[</span><span class="token string">"instruction"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> sample<span class="token punctuation">[</span><span class="token string">"output"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true"># ä» hub åŠ è½½æ•°æ®é›†</span>
dataset <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span><span class="token string">"LooksJuicy/ruozhiba"</span><span class="token punctuation">,</span> split<span class="token operator">=</span><span class="token string">"train"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># è½¬æ¢ dataset ä¸º OAI messages</span>
dataset <span class="token operator">=</span> dataset<span class="token punctuation">.</span>map<span class="token punctuation">(</span>create_conversation<span class="token punctuation">,</span> remove_columns<span class="token operator">=</span>dataset<span class="token punctuation">.</span>features<span class="token punctuation">,</span> batched<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>dataset<span class="token punctuation">[</span><span class="token number">345</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"messages"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># ä¿å­˜åˆ°ç£ç›˜</span>
dataset<span class="token punctuation">.</span>to_json<span class="token punctuation">(</span><span class="token string">"train_dataset.json"</span><span class="token punctuation">,</span> orient<span class="token operator">=</span><span class="token string">"records"</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="ğŸ”¥SFTï¼ˆLoRAï¼‰"><a href="#ğŸ”¥SFTï¼ˆLoRAï¼‰" class="headerlink" title="ğŸ”¥SFTï¼ˆLoRAï¼‰"></a>ğŸ”¥SFTï¼ˆLoRAï¼‰</h1><h2 id="è®­ç»ƒ"><a href="#è®­ç»ƒ" class="headerlink" title="è®­ç»ƒ"></a>è®­ç»ƒ</h2><ul>
<li>æœ‰äº†æ•°æ®é›†å’Œæ¨¡å‹ï¼Œå°±å¯ä»¥è¿›è¡Œå¾®è°ƒäº†ï¼Œé¦–å…ˆæ˜¯LoRAå¾®è°ƒï¼Œä½¿ç”¨transformersã€trlç­‰åº“è¿›è¡Œå¾®è°ƒã€‚</li>
<li>ä¸»è¦æµç¨‹å°±æ˜¯åŠ è½½æ•°æ®é›†ã€åŠ è½½æ¨¡å‹åŠå…¶åˆ†è¯å™¨ã€é…ç½®LoRAå‚æ•°ã€é…ç½®è®­ç»ƒå‚æ•°ï¼Œæœ€åå°±å¯ä»¥å®šä¹‰è®­ç»ƒå™¨è¿›è¡Œè®­ç»ƒäº†ã€‚æµç¨‹ä¸Šå’Œä¼ ç»Ÿæ·±åº¦å­¦ä¹ ä¸€æ ·ï¼Œåªä¸è¿‡å¯¹åº”çš„åº“éƒ½è¿›è¡Œäº†å°è£…ï¼Œä¸éœ€è¦æ‰‹åŠ¨ç¼–å†™è®­ç»ƒçš„å¸¸è§„æµç¨‹ã€‚</li>
<li>è¶…å‚æ•°å¯ä»¥è‡ªè¡Œè°ƒæ•´ï¼Œ<strong>å‡å°‘æ˜¾å­˜å ç”¨</strong>å¯ä»¥é™ä½æ‰¹æ¬¡å¤§å°<code>per_device_train_batch_size</code>å’Œæ¢¯åº¦ç§¯ç´¯<code>gradient_accumulation_steps</code>ï¼Œ<strong>å‡å°‘è®­ç»ƒæ€»æ—¶é•¿</strong>å¯ä»¥å‡å°‘è¿­ä»£æ•°<code>num_train_epochs</code>ï¼ˆå¯ä»¥å°äº1ï¼‰æˆ–è°ƒæ•´æ‰¹æ¬¡å¤§å°ã€‚å…¶ä»–å‚æ•°å¯ä»¥è‡ªè¡Œå°è¯•ã€‚</li>
<li>æ³¨æ„ï¼šç”Ÿæˆçš„LoRAæ¨¡å‹æ˜¯<strong>å¢é‡æ¨¡å‹</strong>ï¼Œä¹Ÿå°±æ˜¯ä¾èµ–åŸæ¨¡å‹å­˜åœ¨ï¼Œæ‰€ä»¥ç”Ÿæˆçš„æ¨¡å‹ä¸ä¼šå¾ˆå¤§ï¼Œå¦‚æœ‰éœ€è¦å¯ä»¥è‡ªè¡ŒæŸ¥æ‰¾æ–¹æ³•æ¥ä¿å­˜å®Œæ•´æ¨¡å‹ã€‚</li>
<li>ä»£ç å¦‚ä¸‹ï¼š</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token punctuation">,</span> os
<span class="token keyword">from</span> transformers <span class="token keyword">import</span> AutoTokenizer<span class="token punctuation">,</span> AutoModelForCausalLM<span class="token punctuation">,</span> BitsAndBytesConfig
<span class="token keyword">from</span> trl <span class="token keyword">import</span> SFTTrainer<span class="token punctuation">,</span> setup_chat_format
<span class="token keyword">from</span> peft <span class="token keyword">import</span> LoraConfig
<span class="token keyword">from</span> datasets <span class="token keyword">import</span> load_dataset
<span class="token keyword">from</span> transformers <span class="token keyword">import</span> TrainingArguments
<span class="token keyword">import</span> warnings
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"`tokenizer` is deprecated"</span><span class="token punctuation">)</span>
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"`use_cache=True` is incompatible"</span><span class="token punctuation">)</span>
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"torch.utils.checkpoint: please pass in use_reentrant"</span><span class="token punctuation">)</span>
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"Torch was not compiled with flash attention"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># è®¾ç½®è®¾å¤‡å’Œç¯å¢ƒ</span>
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># åŠ è½½æ•°æ®é›†</span>
dataset <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">,</span> data_files<span class="token operator">=</span><span class="token string">"train_dataset.jsonæ‰€åœ¨è·¯å¾„"</span><span class="token punctuation">,</span> split<span class="token operator">=</span><span class="token string">"train"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># åŠ è½½æ¨¡å‹å’Œåˆ†è¯å™¨</span>
model_id <span class="token operator">=</span> <span class="token string">"qwen2.5-3bæ¨¡å‹æ–‡ä»¶å¤¹çš„è·¯å¾„"</span>
bnb_config <span class="token operator">=</span> BitsAndBytesConfig<span class="token punctuation">(</span>
    load_in_4bit<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    bnb_4bit_use_double_quant<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    bnb_4bit_quant_type<span class="token operator">=</span><span class="token string">"nf4"</span><span class="token punctuation">,</span>
    bnb_4bit_compute_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>bfloat16
<span class="token punctuation">)</span>

model <span class="token operator">=</span> AutoModelForCausalLM<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>
    model_id<span class="token punctuation">,</span>
    device_map<span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">,</span>
    torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>bfloat16<span class="token punctuation">,</span>
    quantization_config<span class="token operator">=</span>bnb_config<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
tokenizer <span class="token operator">=</span> AutoTokenizer<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>model_id<span class="token punctuation">)</span>
tokenizer<span class="token punctuation">.</span>padding_side <span class="token operator">=</span> <span class="token string">'right'</span>

<span class="token comment" spellcheck="true"># é…ç½®LoRA</span>
peft_config <span class="token operator">=</span> LoraConfig<span class="token punctuation">(</span>
    lora_alpha<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>
    lora_dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
    r<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>
    bias<span class="token operator">=</span><span class="token string">"none"</span><span class="token punctuation">,</span>
    task_type<span class="token operator">=</span><span class="token string">"CAUSAL_LM"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># å®šä¹‰è®­ç»ƒå‚æ•°</span>
args <span class="token operator">=</span> TrainingArguments<span class="token punctuation">(</span>
    output_dir<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ä¿å­˜æ¨¡å‹çš„è·¯å¾„"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    num_train_epochs<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
    per_device_train_batch_size<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>
    gradient_accumulation_steps<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
    gradient_checkpointing<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    optim<span class="token operator">=</span><span class="token string">"adamw_torch_fused"</span><span class="token punctuation">,</span>
    logging_steps<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span>
    save_strategy<span class="token operator">=</span><span class="token string">"steps"</span><span class="token punctuation">,</span>
    save_steps<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
    learning_rate<span class="token operator">=</span><span class="token number">3e</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span>
    fp16<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># å¯ç”¨ fp16 æ··åˆç²¾åº¦è®­ç»ƒ</span>
    max_grad_norm<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
    warmup_ratio<span class="token operator">=</span><span class="token number">0.03</span><span class="token punctuation">,</span>
    lr_scheduler_type<span class="token operator">=</span><span class="token string">"constant"</span><span class="token punctuation">,</span>
    push_to_hub<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    report_to<span class="token operator">=</span><span class="token string">"tensorboard"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># åˆ›å»ºSFTTrainer</span>
trainer <span class="token operator">=</span> SFTTrainer<span class="token punctuation">(</span>
    model<span class="token operator">=</span>model<span class="token punctuation">,</span>
    args<span class="token operator">=</span>args<span class="token punctuation">,</span>
    train_dataset<span class="token operator">=</span>dataset<span class="token punctuation">,</span>
    peft_config<span class="token operator">=</span>peft_config<span class="token punctuation">,</span>
    tokenizer<span class="token operator">=</span>tokenizer<span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># å¼€å§‹è®­ç»ƒ</span>
trainer<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
trainer<span class="token punctuation">.</span>save_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><ul>
<li>è®­ç»ƒå®Œæˆåå°±å¯ä»¥è¿›è¡Œé—®ç­”ï¼Œé€šè¿‡ä»¥ä¸‹è„šæœ¬å®ç°ï¼Œæµ‹è¯•æ—¶ä¸ºäº†ä½¿å¾—æ¨¡å‹ç¨³å®šç”Ÿæˆç»“æœï¼Œå¯ä»¥å°†æ¸©åº¦å€¼<code>temperature</code>è°ƒå°ä¸€äº›ã€‚</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> transformers <span class="token keyword">import</span> pipeline

<span class="token comment" spellcheck="true"># åŠ è½½æ¨¡å‹</span>
pipe <span class="token operator">=</span> pipeline<span class="token punctuation">(</span><span class="token string">"text-generation"</span><span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">"å¾®è°ƒåçš„æ¨¡å‹æ–‡ä»¶å¤¹"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># æä¾›è¾“å…¥</span>
input_text <span class="token operator">=</span> <span class="token string">"ä¸ºä»€ä¹ˆæˆ‘çš„é“¶è¡Œå¡åœ¨é«˜å‹é”…é‡Œç…®äº†ä¸€æ™šä¸Šï¼Œè¿˜æ˜¯å†»ç»“çŠ¶æ€ï¼Ÿ"</span>

<span class="token comment" spellcheck="true"># è°ƒæ•´ç”Ÿæˆå‚æ•°</span>
output <span class="token operator">=</span> pipe<span class="token punctuation">(</span>
    input_text<span class="token punctuation">,</span>
    max_length<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># å¢åŠ ç”Ÿæˆçš„æœ€å¤§é•¿åº¦</span>
    num_return_sequences<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># ç”Ÿæˆå¤šä¸ªåºåˆ—</span>
    temperature<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2025/02/06/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83%EF%BC%9ASFT%EF%BC%88LoRA%E3%80%81Prefix%EF%BC%89%E5%92%8CRLHF/%E6%B5%8B%E8%AF%95.png" alt="æµ‹è¯•ç»“æœ"></p>
<ul>
<li>å¯ä»¥çœ‹åˆ°æ¨¡å‹æ˜¯å¯ä»¥åº”å¯¹å¼±æ™ºå§çš„é—®é¢˜ã€‚</li>
</ul>
<h1 id="ğŸ”¥SFTï¼ˆPrefixï¼‰"><a href="#ğŸ”¥SFTï¼ˆPrefixï¼‰" class="headerlink" title="ğŸ”¥SFTï¼ˆPrefixï¼‰"></a>ğŸ”¥SFTï¼ˆPrefixï¼‰</h1><ul>
<li>prefixå’Œloraåœ¨ä»£ç çš„åŒºåˆ«ä¸Šå¾ˆå°ï¼Œæ•ˆæœå·®ä¸å¤ªå¤šï¼Œæ‰€ä»¥å°±åªå±•ç¤ºä»£ç ã€‚</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token punctuation">,</span> os
<span class="token keyword">from</span> transformers <span class="token keyword">import</span> AutoTokenizer<span class="token punctuation">,</span> AutoModelForCausalLM<span class="token punctuation">,</span> BitsAndBytesConfig
<span class="token keyword">from</span> trl <span class="token keyword">import</span> SFTTrainer
<span class="token keyword">from</span> peft <span class="token keyword">import</span> PrefixTuningConfig
<span class="token keyword">from</span> datasets <span class="token keyword">import</span> load_dataset<span class="token punctuation">,</span> DatasetDict
<span class="token keyword">from</span> transformers <span class="token keyword">import</span> TrainingArguments
<span class="token keyword">import</span> warnings

warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"`tokenizer` is deprecated"</span><span class="token punctuation">)</span>
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"`use_cache=True` is incompatible"</span><span class="token punctuation">)</span>
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"torch.utils.checkpoint: please pass in use_reentrant"</span><span class="token punctuation">)</span>
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"Torch was not compiled with flash attention"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># è®¾ç½®è®¾å¤‡å’Œç¯å¢ƒ</span>
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># åŠ è½½æ•°æ®é›†</span>
dataset <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">,</span> data_files<span class="token operator">=</span><span class="token string">"./datasets/ruozhiba/train_dataset_1.json"</span><span class="token punctuation">,</span> split<span class="token operator">=</span><span class="token string">"train"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># åˆ’åˆ†è®­ç»ƒé›†å’ŒéªŒè¯é›†</span>
train_test_split <span class="token operator">=</span> dataset<span class="token punctuation">.</span>train_test_split<span class="token punctuation">(</span>test_size<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 10% çš„æ•°æ®ä½œä¸ºéªŒè¯é›†</span>
<span class="token comment" spellcheck="true"># åˆ›å»º DatasetDict</span>
dataset_dict <span class="token operator">=</span> DatasetDict<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"train"</span><span class="token punctuation">:</span> train_test_split<span class="token punctuation">[</span><span class="token string">"train"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"validation"</span><span class="token punctuation">:</span> train_test_split<span class="token punctuation">[</span><span class="token string">"test"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># åŠ è½½æ¨¡å‹å’Œåˆ†è¯å™¨</span>
model_id <span class="token operator">=</span> <span class="token string">"./models/qwen2.5-3b"</span>
bnb_config <span class="token operator">=</span> BitsAndBytesConfig<span class="token punctuation">(</span>
    load_in_4bit<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    bnb_4bit_use_double_quant<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    bnb_4bit_quant_type<span class="token operator">=</span><span class="token string">"nf4"</span><span class="token punctuation">,</span>
    bnb_4bit_compute_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>bfloat16
<span class="token punctuation">)</span>

model <span class="token operator">=</span> AutoModelForCausalLM<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>
    model_id<span class="token punctuation">,</span>
    device_map<span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">,</span>
    torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>bfloat16<span class="token punctuation">,</span>
    quantization_config<span class="token operator">=</span>bnb_config<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
tokenizer <span class="token operator">=</span> AutoTokenizer<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>model_id<span class="token punctuation">,</span> padding_side<span class="token operator">=</span><span class="token string">"right"</span><span class="token punctuation">,</span> truncation<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># é…ç½®Prefix Tuning</span>
prefix_config <span class="token operator">=</span> PrefixTuningConfig<span class="token punctuation">(</span>
    peft_type<span class="token operator">=</span><span class="token string">"PREFIX_TUNING"</span><span class="token punctuation">,</span>
    task_type<span class="token operator">=</span><span class="token string">"CAUSAL_LM"</span><span class="token punctuation">,</span>
    num_virtual_tokens<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true"># è™šæ‹Ÿå‰ç¼€çš„é•¿åº¦</span>
    token_dim<span class="token operator">=</span><span class="token number">2048</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true"># å‰ç¼€åµŒå…¥çš„ç»´åº¦ï¼ŒåŒåŸæ¨¡å‹</span>
    num_layers<span class="token operator">=</span><span class="token number">36</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true"># æ¨¡å‹éšè—å±‚æ•°ï¼ŒåŒåŸæ¨¡å‹</span>
    prefix_projection<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true"># æ˜¯å¦å¯¹å‰ç¼€è¿›è¡ŒæŠ•å½±</span>
    encoder_hidden_size<span class="token operator">=</span><span class="token number">2048</span>    <span class="token comment" spellcheck="true"># å‰ç¼€ç¼–ç å™¨çš„éšè—å±‚å¤§å°ï¼ŒåŒåŸæ¨¡å‹</span>
<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># å®šä¹‰è®­ç»ƒå‚æ•°</span>
args <span class="token operator">=</span> TrainingArguments<span class="token punctuation">(</span>
    output_dir<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"results/qwen2.5-finetuned-prefix"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    num_train_epochs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
    per_device_train_batch_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
    gradient_accumulation_steps<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
    gradient_checkpointing<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    optim<span class="token operator">=</span><span class="token string">"adamw_torch_fused"</span><span class="token punctuation">,</span>
    logging_steps<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span>
    save_strategy<span class="token operator">=</span><span class="token string">"steps"</span><span class="token punctuation">,</span>
    save_steps<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span>
    evaluation_strategy<span class="token operator">=</span><span class="token string">"steps"</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># æ·»åŠ è¯„ä¼°ç­–ç•¥</span>
    eval_steps<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># æ¯ 200 æ­¥è¯„ä¼°ä¸€æ¬¡</span>
    learning_rate<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span>
    fp16<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># å¯ç”¨ fp16 æ··åˆç²¾åº¦è®­ç»ƒï¼Œæå‡æ•ˆç‡</span>
    max_grad_norm<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
    warmup_ratio<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
    lr_scheduler_type<span class="token operator">=</span><span class="token string">"linear"</span><span class="token punctuation">,</span>
    push_to_hub<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    report_to<span class="token operator">=</span><span class="token string">"tensorboard"</span><span class="token punctuation">,</span>
    load_best_model_at_end<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># ç¡®ä¿åŠ è½½æœ€ä½³æ¨¡å‹</span>
    metric_for_best_model<span class="token operator">=</span><span class="token string">"loss"</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># ç›‘æ§éªŒè¯é›†æŸå¤±</span>
    greater_is_better<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># æŸå¤±è¶Šå°è¶Šå¥½</span>
<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># åˆ›å»ºSFTTrainer</span>
trainer <span class="token operator">=</span> SFTTrainer<span class="token punctuation">(</span>
    model<span class="token operator">=</span>model<span class="token punctuation">,</span>
    args<span class="token operator">=</span>args<span class="token punctuation">,</span>
    train_dataset<span class="token operator">=</span>dataset_dict<span class="token punctuation">[</span><span class="token string">"train"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    eval_dataset<span class="token operator">=</span>dataset_dict<span class="token punctuation">[</span><span class="token string">"validation"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># æ·»åŠ éªŒè¯é›†</span>
    peft_config<span class="token operator">=</span>prefix_config<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># ä½¿ç”¨PrefixTuningConfig</span>
    tokenizer<span class="token operator">=</span>tokenizer<span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># å¼€å§‹è®­ç»ƒ</span>
trainer<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
trainer<span class="token punctuation">.</span>save_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="ğŸ”¥RLHFï¼ˆGRPOï¼‰"><a href="#ğŸ”¥RLHFï¼ˆGRPOï¼‰" class="headerlink" title="ğŸ”¥RLHFï¼ˆGRPOï¼‰"></a>ğŸ”¥RLHFï¼ˆGRPOï¼‰</h1><p>æ¥ä¸‹æ¥å°±æ˜¯å¼ºåŒ–å­¦ä¹ æ–¹æ³•ï¼Œç”¨çš„æ˜¯GRPOç®—æ³•ã€‚</p>
<blockquote>
<p>GRPOçš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡ç»„å†…ç›¸å¯¹å¥–åŠ±æ¥ä¼˜åŒ–ç­–ç•¥æ¨¡å‹ï¼Œè€Œä¸æ˜¯ä¾èµ–ä¼ ç»Ÿçš„ä»·å€¼ç½‘ç»œï¼ˆcritic modelï¼‰ã€‚å…·ä½“æ¥è¯´ï¼Œå¯¹äºæ¯ä¸ªè¾“å…¥é—®é¢˜ï¼Œæ¨¡å‹ä¼šç”Ÿæˆä¸€ç»„å¯èƒ½çš„è¾“å‡ºï¼Œç„¶åé€šè¿‡è¿™äº›è¾“å‡ºä¹‹é—´çš„ç›¸å¯¹è¡¨ç°æ¥è¿›è¡Œä¼˜åŒ–ã€‚è¿™ç§æ–¹æ³•æ¶ˆé™¤äº†å¯¹ç‹¬ç«‹è¯„ä¼°å™¨çš„éœ€æ±‚ï¼Œä½¿å¾—è®­ç»ƒè¿‡ç¨‹æ›´åŠ é«˜æ•ˆã€‚å‡å°‘è®¡ç®—è´Ÿæ‹…ã€ç¨³å®šæ€§å’Œå¯æ§æ€§å¼ºã€‚</p>
</blockquote>
<h2 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><ul>
<li>ç”±äºä¸ªäººç”µè„‘æœ‰å¯èƒ½æ²¡æ³•åº”ä»˜qwen2.5-3bçš„RLHFå¾®è°ƒï¼Œæ‰€ä»¥å¯ä»¥æŒ‰ç…§ä¹‹å‰çš„æ–¹æ³•ä¸‹è½½<strong>Qwen&#x2F;Qwen2.5-0.5B-Instruct</strong>ï¼Œç„¶åæ•°æ®é›†ä½¿ç”¨<strong>openai&#x2F;gsm8k</strong>ï¼Œæ˜¯ä¸€ä¸ªè‹±æ–‡çš„æ•°å­¦é¢˜çš„æ•°æ®é›†ï¼Œåœ¨è¾“å‡ºæœ€æœ«å°¾é™„æœ‰æ­£ç¡®ç­”æ¡ˆã€‚</li>
</ul>
<h2 id="è®­ç»ƒ-1"><a href="#è®­ç»ƒ-1" class="headerlink" title="è®­ç»ƒ"></a>è®­ç»ƒ</h2><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> re
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> datasets <span class="token keyword">import</span> load_dataset<span class="token punctuation">,</span> Dataset
<span class="token keyword">from</span> transformers <span class="token keyword">import</span> AutoTokenizer<span class="token punctuation">,</span> AutoModelForCausalLM
<span class="token keyword">from</span> trl <span class="token keyword">import</span> GRPOConfig<span class="token punctuation">,</span> GRPOTrainer
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Union

SYSTEM_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
Respond in the following format:
&lt;reasoning>
...
&lt;/reasoning>
&lt;answer>
...
&lt;/answer>
"""</span>
XML_COT_FORMAT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""\
&lt;reasoning>
{reasoning}
&lt;/reasoning>
&lt;answer>
{answer}
&lt;/answer>
"""</span>

<span class="token comment" spellcheck="true"># æ•°æ®ã€æ•°æ®é›†å¤„ç†éƒ¨åˆ†</span>
<span class="token keyword">def</span> <span class="token function">extract_xml_answer</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> str<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> str<span class="token punctuation">:</span>       <span class="token comment" spellcheck="true"># è·å–llmçš„å›ç­”éƒ¨åˆ†</span>
    answer <span class="token operator">=</span> text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&lt;answer>"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    answer <span class="token operator">=</span> answer<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&lt;/answer>"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> answer<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">extract_hash_answer</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> str<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Union<span class="token punctuation">[</span>str<span class="token punctuation">,</span> None<span class="token punctuation">]</span><span class="token punctuation">:</span>   <span class="token comment" spellcheck="true"># è·å–æ­£ç¡®ç­”æ¡ˆ</span>
    <span class="token keyword">if</span> <span class="token string">"####"</span> <span class="token operator">not</span> <span class="token keyword">in</span> text<span class="token punctuation">:</span>
        <span class="token keyword">return</span> None
    <span class="token keyword">return</span> text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"####"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># uncomment middle messages for 1-shot prompting</span>
<span class="token keyword">def</span> <span class="token function">get_gsm8k_questions</span><span class="token punctuation">(</span>split <span class="token operator">=</span> <span class="token string">"train"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Dataset<span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># è·å¾—æ•°æ®é›†å¹¶åŠ å…¥prompt</span>
    data <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span><span class="token string">'openai/gsm8k'</span><span class="token punctuation">,</span> <span class="token string">'main'</span><span class="token punctuation">)</span><span class="token punctuation">[</span>split<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># type: ignore</span>
    data <span class="token operator">=</span> data<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true"># type: ignore</span>
        <span class="token string">'prompt'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'system'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> SYSTEM_PROMPT<span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token string">'question'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'answer'</span><span class="token punctuation">:</span> extract_hash_answer<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token string">'answer'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># type: ignore</span>
    <span class="token keyword">return</span> data <span class="token comment" spellcheck="true"># type: ignore</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>é¦–å…ˆå¯¼å…¥åº“åï¼Œè®¾ç½®å¥½promptæ¥å¼•å¯¼æ¨¡å‹æŒ‰<code>&lt;reasoning&gt;</code>å’Œ<code>&lt;answer&gt;</code>çš„xmlæ ¼å¼è¾“å‡ºæ¨å¯¼è¿‡ç¨‹å’Œç­”æ¡ˆï¼Œè¿™æ ·æ–¹ä¾¿æˆ‘ä»¬æå–å‡ºç­”æ¡ˆæ¥è¿›è¡Œå¥–åŠ±åˆ¤æ–­ã€‚</li>
<li>ç„¶åå°±æ˜¯å¤„ç†æ•°æ®é›†å’Œè¾“å‡ºæ–‡æœ¬çš„å‡½æ•°äº†ï¼Œ<code>extract_xml_answer</code>ç”¨äºå°†ç”Ÿæˆå¥½çš„æ–‡æœ¬æå–å‡ºç­”æ¡ˆï¼›<code>extract_hash_answer</code>åˆ™æ˜¯è·å–æ•°æ®é›†ä¸­çš„ç­”æ¡ˆï¼›<code>get_gsm8k_questions</code>åˆ™åŠ è½½æ•°æ®é›†ï¼Œå¹¶ä¸”èå…¥promptã€‚</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">correctness_reward_func</span><span class="token punctuation">(</span>prompts<span class="token punctuation">,</span> completions<span class="token punctuation">,</span> answer<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> list<span class="token punctuation">[</span>float<span class="token punctuation">]</span><span class="token punctuation">:</span>
    responses <span class="token operator">=</span> <span class="token punctuation">[</span>completion<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> completion <span class="token keyword">in</span> completions<span class="token punctuation">]</span>
    q <span class="token operator">=</span> prompts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span>
    extracted_responses <span class="token operator">=</span> <span class="token punctuation">[</span>extract_xml_answer<span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token keyword">for</span> r <span class="token keyword">in</span> responses<span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">,</span> f<span class="token string">"Question:\n{q}"</span><span class="token punctuation">,</span> f<span class="token string">"\nAnswer:\n{answer[0]}"</span><span class="token punctuation">,</span> f<span class="token string">"\nResponse:\n{responses[0]}"</span><span class="token punctuation">,</span> f<span class="token string">"\nExtracted:\n{extracted_responses[0]}"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">2.0</span> <span class="token keyword">if</span> r <span class="token operator">==</span> a <span class="token keyword">else</span> <span class="token number">0.0</span> <span class="token keyword">for</span> r<span class="token punctuation">,</span> a <span class="token keyword">in</span> zip<span class="token punctuation">(</span>extracted_responses<span class="token punctuation">,</span> answer<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">int_reward_func</span><span class="token punctuation">(</span>completions<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> list<span class="token punctuation">[</span>float<span class="token punctuation">]</span><span class="token punctuation">:</span>
    responses <span class="token operator">=</span> <span class="token punctuation">[</span>completion<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> completion <span class="token keyword">in</span> completions<span class="token punctuation">]</span>
    extracted_responses <span class="token operator">=</span> <span class="token punctuation">[</span>extract_xml_answer<span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token keyword">for</span> r <span class="token keyword">in</span> responses<span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">0.5</span> <span class="token keyword">if</span> r<span class="token punctuation">.</span>isdigit<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token number">0.0</span> <span class="token keyword">for</span> r <span class="token keyword">in</span> extracted_responses<span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">strict_format_reward_func</span><span class="token punctuation">(</span>completions<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> list<span class="token punctuation">[</span>float<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Reward function that checks if the completion has a specific format."""</span>
    pattern <span class="token operator">=</span> r<span class="token string">"^&lt;reasoning>\n.*?\n&lt;/reasoning>\n&lt;answer>\n.*?\n&lt;/answer>\n$"</span>
    responses <span class="token operator">=</span> <span class="token punctuation">[</span>completion<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token keyword">for</span> completion <span class="token keyword">in</span> completions<span class="token punctuation">]</span>
    matches <span class="token operator">=</span> <span class="token punctuation">[</span>re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token keyword">for</span> r <span class="token keyword">in</span> responses<span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">0.5</span> <span class="token keyword">if</span> match <span class="token keyword">else</span> <span class="token number">0.0</span> <span class="token keyword">for</span> match <span class="token keyword">in</span> matches<span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">soft_format_reward_func</span><span class="token punctuation">(</span>completions<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> list<span class="token punctuation">[</span>float<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Reward function that checks if the completion has a specific format."""</span>
    pattern <span class="token operator">=</span> r<span class="token string">"&lt;reasoning>.*?&lt;/reasoning>\s*&lt;answer>.*?&lt;/answer>"</span>
    responses <span class="token operator">=</span> <span class="token punctuation">[</span>completion<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token keyword">for</span> completion <span class="token keyword">in</span> completions<span class="token punctuation">]</span>
    matches <span class="token operator">=</span> <span class="token punctuation">[</span>re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token keyword">for</span> r <span class="token keyword">in</span> responses<span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token number">0.5</span> <span class="token keyword">if</span> match <span class="token keyword">else</span> <span class="token number">0.0</span> <span class="token keyword">for</span> match <span class="token keyword">in</span> matches<span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">count_xml</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> float<span class="token punctuation">:</span>
    count <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">if</span> text<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">"&lt;reasoning>\n"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        count <span class="token operator">+=</span> <span class="token number">0.125</span>
    <span class="token keyword">if</span> text<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">"\n&lt;/reasoning>\n"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        count <span class="token operator">+=</span> <span class="token number">0.125</span>
    <span class="token keyword">if</span> text<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">"\n&lt;answer>\n"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        count <span class="token operator">+=</span> <span class="token number">0.125</span>
        count <span class="token operator">-=</span> len<span class="token punctuation">(</span>text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n&lt;/answer>\n"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.001</span>
    <span class="token keyword">if</span> text<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">"\n&lt;/answer>"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        count <span class="token operator">+=</span> <span class="token number">0.125</span>
        count <span class="token operator">-=</span> <span class="token punctuation">(</span>len<span class="token punctuation">(</span>text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n&lt;/answer>"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.001</span>
    <span class="token keyword">return</span> count

<span class="token keyword">def</span> <span class="token function">xmlcount_reward_func</span><span class="token punctuation">(</span>completions<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> list<span class="token punctuation">[</span>float<span class="token punctuation">]</span><span class="token punctuation">:</span>
    contents <span class="token operator">=</span> <span class="token punctuation">[</span>completion<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token keyword">for</span> completion <span class="token keyword">in</span> completions<span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>count_xml<span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> contents<span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>æ¥ç€å°±æ˜¯4ä¸ªå¥–åŠ±å‡½æ•°ï¼Œåˆ†åˆ«ç”¨äº<strong>åˆ¤æ–­ç­”æ¡ˆæ˜¯å¦æ­£ç¡®ã€æ˜¯å¦å›ç­”æ•´æ•°ã€æ˜¯å¦æŒ‰æ ¼å¼ç”Ÿæˆç­”æ¡ˆï¼ˆä¸¥æ ¼å’Œå®½æ¾ä¸¤ç§ï¼‰</strong>ã€‚</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python">dataset <span class="token operator">=</span> get_gsm8k_questions<span class="token punctuation">(</span><span class="token punctuation">)</span>
model_name <span class="token operator">=</span> <span class="token string">"./models/qwen2.5-3b"</span>

output_dir<span class="token operator">=</span><span class="token string">"results/qwen2.5-finetuned_GRPO"</span>
run_name<span class="token operator">=</span><span class="token string">"Qwen-2.5B-GRPO-gsm8k"</span>

training_args <span class="token operator">=</span> GRPOConfig<span class="token punctuation">(</span>
    output_dir<span class="token operator">=</span>output_dir<span class="token punctuation">,</span>
    run_name<span class="token operator">=</span>run_name<span class="token punctuation">,</span>
    learning_rate<span class="token operator">=</span><span class="token number">5e</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">,</span>
    adam_beta1 <span class="token operator">=</span> <span class="token number">0.9</span><span class="token punctuation">,</span>
    adam_beta2 <span class="token operator">=</span> <span class="token number">0.99</span><span class="token punctuation">,</span>
    weight_decay <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
    warmup_ratio <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
    lr_scheduler_type<span class="token operator">=</span><span class="token string">'cosine'</span><span class="token punctuation">,</span>
    logging_steps<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
    bf16<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    per_device_train_batch_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
    gradient_accumulation_steps<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
    num_generations<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>
    max_prompt_length<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
    max_completion_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span>
    num_train_epochs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
    save_steps<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
    max_grad_norm<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
    log_on_each_node<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    use_vllm<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    vllm_gpu_memory_utilization<span class="token operator">=</span><span class="token punctuation">.</span><span class="token number">3</span><span class="token punctuation">,</span>
    vllm_device<span class="token operator">=</span><span class="token string">"cuda:0"</span><span class="token punctuation">,</span>
    report_to<span class="token operator">=</span><span class="token string">"none"</span> <span class="token comment" spellcheck="true">#I'm disabling Wandb.</span>
<span class="token punctuation">)</span>

model <span class="token operator">=</span> AutoModelForCausalLM<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>
    model_name<span class="token punctuation">,</span>
    torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>bfloat16<span class="token punctuation">,</span>
    device_map<span class="token operator">=</span>None
<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cuda"</span><span class="token punctuation">)</span>

tokenizer <span class="token operator">=</span> AutoTokenizer<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>model_name<span class="token punctuation">)</span>
tokenizer<span class="token punctuation">.</span>pad_token <span class="token operator">=</span> tokenizer<span class="token punctuation">.</span>eos_token

trainer <span class="token operator">=</span> GRPOTrainer<span class="token punctuation">(</span>
    model<span class="token operator">=</span>model<span class="token punctuation">,</span>
    processing_class<span class="token operator">=</span>tokenizer<span class="token punctuation">,</span>
    reward_funcs<span class="token operator">=</span><span class="token punctuation">[</span>
        xmlcount_reward_func<span class="token punctuation">,</span>
        soft_format_reward_func<span class="token punctuation">,</span>
        strict_format_reward_func<span class="token punctuation">,</span>
        int_reward_func<span class="token punctuation">,</span>
        correctness_reward_func<span class="token punctuation">]</span><span class="token punctuation">,</span>
    args<span class="token operator">=</span>training_args<span class="token punctuation">,</span>
    train_dataset<span class="token operator">=</span>dataset<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">#peft_config=peft_config</span>
<span class="token punctuation">)</span>
trainer<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>

trainer<span class="token punctuation">.</span>save_model<span class="token punctuation">(</span>output_dir<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>æœ€åæ˜¯è®­ç»ƒä¸»æµç¨‹ï¼Œè¿™å°±å’ŒSFTå·®ä¸å¤šäº†ï¼Œå°±æ˜¯åŠ è½½æ¨¡å‹å’Œæ•°æ®é›†ã€é…ç½®å¾®è°ƒå‚æ•°ã€å®šä¹‰GRPOç®—æ³•çš„è®­ç»ƒå™¨ï¼Œå°±å¯ä»¥è®­ç»ƒäº†ã€‚</li>
<li>æ‰€ä»¥æ•´ä½“ä»£ç å°±æ˜¯å¤šäº†å¥–åŠ±å‡½æ•°ï¼Œè¿˜æœ‰ä¸ºäº†æ–¹ä¾¿åˆ¤æ–­ç»“æœè¦ç”¨æç¤ºè¯å¼•å¯¼æ¨¡å‹ï¼Œæ¯•ç«Ÿæ ¸å¿ƒçš„GRPOç®—æ³•å·²ç»è¢«é›†æˆåˆ°åº“é‡Œäº†ï¼Œè°ƒç”¨å°±è¡Œã€‚</li>
</ul>
<h2 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h2><ul>
<li>ç”±äºè®­ç»ƒä¸å¤ªå¯èƒ½å…¨è·‘å®Œï¼Œæ‰€ä»¥è§‚å¯Ÿåˆ°äº†æœ‰æ”¹å–„å°±åœäº†ã€‚</li>
</ul>
<pre class="line-numbers language-txt"><code class="language-txt">-------------------- Question:
Ahmed and Emily are having a contest to see who can get the best grade in the class. There have been 9 assignments and Ahmed has a 91 in the class. Emily has a 92. The final assignment is worth the same amount as all the other assignments. Emily got a 90 on the final assignment. What is the minimum grade Ahmed needs to get to beat Emily if all grades are whole numbers? 
Answer:
100 
Response:
To determine the minimum grade Ahmed needs to get to beat Emily, we first need to calculate the total grade the class will have for all assignments. The class has 9 assignments, and Emily has already achieved a 92 in all assignments. Therefore, the total grade for Emily is already 92.

Since Emily's final assignment is worth the same amount as all the other assignments, Emily will score another 90 on that assignment. Let's denote Ahmed's score on the final assignment as \(x\). The total grade for Emily will then be:
\[ x + 90 = 92 + 90 = 182 \]
The total grade for Ahmed will be:
\[ 91 + x \]
To beat Emily, Ahmed needs to score more than 182. Therefore, we need to find the smallest integer \(x\) such that:
\[ 91 + x > 182 \]
Subtracting 91 from 
Extracted:
To determine the minimum grade Ahmed needs to get to beat Emily, â€¦â€¦ï¼ˆè¿™é‡Œæå–å‡½æ•°æå–ä¸å‡ºç­”æ¡ˆå°±ä¼šæŠŠæ•´ä¸ªç­”æ¡ˆæ‰“å‡ºæ¥ï¼Œå°±çœç•¥äº†ï¼‰
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>å¯ä»¥çœ‹åˆ°åˆšå¼€å§‹æ¨¡å‹åŸºæœ¬ä¸ä¼šæŒ‰æ ¼å¼å›ç­”ï¼Œå›ç­”é•¿åº¦ä¹Ÿè¶…é™åˆ¶äº†ï¼Œç­”æ¡ˆä¹Ÿå¾ˆå®¹æ˜“é”™ã€‚è¿™ç§æƒ…å†µä¼šæŒç»­æ¯”è¾ƒä¹…ï¼Œå› ä¸ºé•¿æ—¶é—´æ²¡æœ‰æ­£åé¦ˆï¼Œæ¨¡å‹éœ€è¦è¯¯æ‰“è¯¯æ’æ‰èƒ½å¾—åˆ°æ­£ç¡®çš„è¡Œä¸ºæ¥è·å¾—å¥–åŠ±ã€‚</li>
</ul>
<pre class="line-numbers language-xml"><code class="language-xml">-------------------- Question:
A basketball team won 35 out of the 50 games that they have played. They still have 25 games left to play for the season. How many of the remaining games must they win so that their percentage of wins in the entire season is 64%? 
Answer:
13 
Response:
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>reasoning</span><span class="token punctuation">></span></span>
To calculate the number of games the team must win to reach a 64% win rate across all games in the season, we can follow these steps:

1. Let's assume the total number of games in the season is \( x \). We know that the team has played \( x - 25 \) games, and they have won 35 out of those games. Therefore, the team has won \( \frac{35}{x - 25} \) games.

2. The team wants to achieve a 64% win rate across all 50 games. We can set up the following equation to represent this:
   \[
   \frac{35}{x - 25} \times 100 = 64 \times x
   \]

3. Solving this equation will give us the value of \( x \). However, since the specific value of \( x \) is not 
Extracted:
&lt;reasoning
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>æ¥ä¸‹æ¥æ¨¡å‹å°±å‡ºç°äº†æŒ‰æ ¼å¼ç­”é¢˜çš„æƒ…å†µï¼Œè™½ç„¶å¯èƒ½è¿˜ä¼šé•¿åº¦è¶…é™æˆ–è€…ç­”é”™ï¼Œä½†æ˜¯ä¸€æ—¦å‡ºç°è¿™ç§æƒ…å†µï¼Œå°±å¾ˆå®¹æ˜“æŒ‰æ ¼å¼ç­”é¢˜äº†ã€‚</li>
</ul>
<pre class="line-numbers language-xml"><code class="language-xml">-------------------- Question:
Dave bought 8 books about animals, 6 books about outer space, and 3 books about trains to keep him busy over the holidays. Each book cost $6. How much did Dave spend on the books? 
Answer:
102 
Response:
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>reasoning</span><span class="token punctuation">></span></span>
Dave bought a total of \(8 + 6 + 3 = 17\) books. Each book cost $6, so the total cost is \(17 \times 6 = \$102\).

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>reasoning</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>answer</span><span class="token punctuation">></span></span>102<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>answer</span><span class="token punctuation">></span></span> 
Extracted:
102
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>æœ€åè®­ç»ƒäº†å‡ ç™¾é¢˜ä¹‹åï¼Œæ¨¡å‹å°±å¯ä»¥ç¨³å®šåœ°æŒ‰æ ¼å¼å›ç­”é—®é¢˜ï¼Œå¹¶ä¸”å¯¹äºä¸å¤æ‚çš„é¢˜ç›®åŸºæœ¬éƒ½èƒ½åšå¯¹äº†ï¼ˆAnsweræ˜¯æ•°æ®é›†æ­£ç¡®ç­”æ¡ˆï¼ŒExtractedæ˜¯æ¨¡å‹å›ç­”ä¸­æå–çš„ç­”æ¡ˆï¼‰ã€‚è¯´æ˜RLHFæ˜¯æœ‰æ•ˆæœçš„ï¼Œå³ä¾¿åº”å¯¹ä¸æ€ä¹ˆæ™ºèƒ½çš„å°æ¨¡å‹ã€‚</li>
</ul>
<h1 id="ğŸ”¥æ€»ç»“"><a href="#ğŸ”¥æ€»ç»“" class="headerlink" title="ğŸ”¥æ€»ç»“"></a>ğŸ”¥æ€»ç»“</h1><ul>
<li>æœ¬æ¬¡é€šè¿‡LoRAå’ŒPrefixæ–¹æ³•ä½“éªŒäº†SFTå¾®è°ƒï¼Œé€šè¿‡GRPOç®—æ³•ä½“éªŒäº†RLHFå¾®è°ƒï¼Œç®—æ˜¯åˆæ­¥å°è¯•äº†æœ€ä¸»æµçš„PEFTå¾®è°ƒæ–¹æ¡ˆåŠå…¶æ–¹æ³•ã€‚</li>
<li>é€šè¿‡è¯¥æ–¹æ¡ˆå¯ä»¥æ¯”è¾ƒå®¹æ˜“åœ°ä¸Šæ‰‹å¾®è°ƒï¼Œä½†æ˜¯å¾®è°ƒæœ¬èº«è¿˜æ˜¯å¾ˆåƒç®—åŠ›çš„ï¼Œå³ä¾¿æ˜¯è¿™ç§å‚æ•°é«˜æ•ˆå¾®è°ƒå¯¹ä¸ªäººç”µè„‘ä¹Ÿç›¸å½“æ…¢ï¼Œæ•ˆæœä¹Ÿä¸ä¸€å®šå¥½ï¼Œåƒä¼ ç»Ÿæ·±åº¦å­¦ä¹ è®­ç»ƒä¸€æ ·ï¼Œä¹Ÿéœ€è¦å¾ˆå¤šè°ƒæ•´ï¼Œå¼ºåŒ–å­¦ä¹ å°±æ›´æ˜¯éœ€è¦æ›´å¤šçš„æ—¶é—´å’Œç®—åŠ›äº†ã€‚æ‰€ä»¥åªæ˜¯ç”¨äºå°è¯•å’Œä½“éªŒå¾®è°ƒè¿‡ç¨‹ï¼Œä¸°å¯Œç›¸å…³ç»éªŒï¼Œå¢å¼ºçŸ¥è¯†çš„ç†è§£ã€‚</li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        åˆ†äº«
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://legendleochen.top/2025/02/06/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83%EF%BC%9ASFT%EF%BC%88LoRA%E3%80%81Prefix%EF%BC%89%E5%92%8CRLHF/" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LLM/" rel="tag">LLM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LORA/" rel="tag">LORA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PEFT/" rel="tag">PEFT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RLHF/" rel="tag">RLHF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SFT/" rel="tag">SFT</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2025/02/17/%E4%B8%BB%E6%B5%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/" class="article-nav-link">
        <strong class="article-nav-caption">ä¸Šä¸€ç¯‡</strong>
        <div class="article-nav-title">
          
            ä¸»æµå¤§æ¨¡å‹æŠ€æœ¯ç¬”è®°
          
        </div>
      </a>
    
    
      <a href="/2025/01/04/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8F%8ARAG%E6%9E%B6%E6%9E%84%E7%9A%84%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/" class="article-nav-link">
        <strong class="article-nav-caption">ä¸‹ä¸€ç¯‡</strong>
        <div class="article-nav-title">å¤§æ¨¡å‹åŠRAGæ¶æ„çš„æœ¬åœ°éƒ¨ç½²</div>
      </a>
    
  </nav>

  
   
  
    
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2023-2025
        <i class="ri-heart-fill heart_icon"></i> LegendLeo Chen
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>è®¿é—®äººæ•°:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>æµè§ˆæ¬¡æ•°:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzzç»Ÿè®¡ -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/mylogo.png" alt="LegendLeo Chen çš„ç©ºé—´"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">ğŸš€ä¸»é¡µ</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">ğŸ’¾å½’æ¡£</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">ğŸ§­åˆ†ç±»</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">ğŸ·ï¸æ ‡ç­¾</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">ğŸ›¸å…³äº</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/analytics">ğŸ“Šç»Ÿè®¡</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="æœç´¢">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>è¯·æˆ‘å–æ¯å’–å•¡å§~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">æ”¯ä»˜å®</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">å¾®ä¿¡</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // sliderå±•å¼€çŠ¶æ€
                // todo: è¿™æ ·ä¸å¥½ï¼Œåé¢æ”¹æˆçŠ¶æ€
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // è·å¾—åŸå›¾å°ºå¯¸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // ç­‰å¾…ä¸¤ç§’é’Ÿåæ¢å¤
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // ç­‰å¾…ä¸¤ç§’é’Ÿåæ¢å¤
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=1491212&auto=1&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    

  </div>
  <!-- èƒŒæ™¯æ°”æ³¡ -->
  <!--
  <div class="balls-container">
    <div class="balls-particles">
      <span style="--i:11;"></span>
      <span style="--i:12;"></span>
      <span style="--i:24;"></span>
      <span style="--i:10;"></span>
      <span style="--i:14;"></span>
      <span style="--i:23;"></span>
      <span style="--i:18;"></span>
      <span style="--i:16;"></span>
      <span style="--i:19;"></span>
      <span style="--i:20;"></span>
      <span style="--i:22;"></span>
      <span style="--i:25;"></span>
      <span style="--i:18;"></span>
      <span style="--i:21;"></span>
      <span style="--i:13;"></span>
      <span style="--i:15;"></span>
      <span style="--i:26;"></span>
      <span style="--i:17;"></span>
      <span style="--i:13;"></span>
      <span style="--i:26;"></span>
      <span style="--i:28;"></span>
      <span style="--i:11;"></span>
      <span style="--i:12;"></span>
      <span style="--i:24;"></span>
      <span style="--i:10;"></span>
      <span style="--i:14;"></span>
      <span style="--i:23;"></span>
      <span style="--i:18;"></span>
      <span style="--i:16;"></span>
      <span style="--i:19;"></span>
      <span style="--i:20;"></span>
      <span style="--i:22;"></span>
      <span style="--i:25;"></span>
      <span style="--i:18;"></span>
      <span style="--i:21;"></span>
      <span style="--i:13;"></span>
      <span style="--i:15;"></span>
      <span style="--i:26;"></span>
      <span style="--i:17;"></span>
      <span style="--i:13;"></span>
      <span style="--i:26;"></span>
      <span style="--i:28;"></span>
    </div>
  </div>
  <style>
    *
    {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    .balls-container
    { 
      position: fixed;
      top: 0px;
      left: 0px;
      width: 100%;
      height: 100vh;
      overflow: hidden;
      opacity: 0.3;
    }
    
    .balls-particles
    {
      position: fixed;
      display: flex;
      z-index: 3;
      padding: 0 20px;
    }
    
    .balls-particles span
    {
      position: relative;
      bottom: 30px;
      width: 30px;
      height: 30px;
      background-color: #4fc3dc;
      box-shadow: 0 0 0 10px #4fc3dc44,
      0 0 50px #4fc3dc,
      -100px 0 #4fc3dc99,
      100px 0 #ff2d7599;
      margin: 0 4px;
      border-radius: 50%;
      animation: animate 15s ease infinite;
      animation-delay: calc(125s / var(--i));
      transform: translateY(120vh);
    }
    .balls-particles span:nth-child(even) {
      background-color: #ff2d75;
      box-shadow: 0 0 0 10px #ff267544,
      0 0 50px #ff2d75,
      -100px 0 #4fc3dc99,
      100px 0 #4fc3dc99;
      ;
    }
    
    @keyframes animate {
      0%
      {
        transform: translateY(120vh) scale(0) rotate(0deg);
      }
      20%
      {
        transform: translateY(100vh) scale(1) rotate(0deg);
      }
      100%
      {
        transform: translateY(-50vh) scale(0.5) rotate(360deg);
      }
    }
  </style> -->
  <!-- åœ°æœˆç³»ç»Ÿ -->
  <!-- <div class="earth-container" >
    <div class="planet"></div>
    <div class="satellite"></div>
   </div>
   <style>
    *{
      padding: 0;
      margin: 0;
      }
      .earth-container {
        width: 36.25em;
        height: 36.25em;
        position: absolute;
        top:5%;
        left: 93%;
        transform: translate(-50%, -50%);
        opacity: 0.3;
      }
      
      .planet{
        width: 15.62*3em;
        height: 15.62*3em;
        background-color: #02c0f5;
        border-radius: 50%;
        position: absolute;
        margin: auto;
        top:0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1;
      }
      
      .planet::before{
        content: '';
        width: 4em;
        height: 4em;
        background-color: #008fd6;
        position: absolute;
        top:10em;
        left: 8em;
        border-radius: 50%; 
        box-shadow: 15em 15em 0 2em #00d68b, 5em 8em 0 3em #10ade1;
      }
      
      .satellite{
        width: 5em;
        height: 5em;
        background-color: #dee517;
        border-radius: 50%;
        position: relative;
        left: -5em;
        bottom: -30em;
        animation: spin 5s infinite;
        z-index: 1;
      }
      
      @keyframes spin {
        49%{
          z-index: 1;
        }
        50%{
          bottom: 3em;
          left: 35em;
          z-index: -1;
        }
        100%{
          z-index: -1;
        }
      }
    </style> -->
<!-- ä¸‰è§’å½©å¸¦èƒŒæ™¯ -->
  <canvas id="evanyou-canvas" style="opacity: 0.3; position: fixed; top: 0px; left: 0px; z-index: -1; width: 100%; height: 100%; pointer-events: none;"></canvas>
  <script src="https://cdn.jsdelivr.net/gh/XXXZhy/Blog_Image/js/evanyou_canvas.js"></script>
</body>

</html>