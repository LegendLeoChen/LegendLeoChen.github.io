<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="ä¸€ä¸ªç§˜å¯†ç©ºé—´" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>SAM2å›¾åƒåˆ†å‰²æ¨¡å‹çš„å¾®è°ƒ |  LegendLeo Chen çš„ç©ºé—´</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/mylogo.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
<!-- å°é¢æ ‡é—ªçƒ -->
<link rel="stylesheet" href="/css/zhyBlogTitle.css">
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<!-- jqueryï¼Œæ‡’åŠ è½½ã€ç»Ÿè®¡ã€è¯´è¯´éœ€è¦çš„jquery -->
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-SAM2å›¾åƒåˆ†å‰²æ¨¡å‹çš„å¾®è°ƒ"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  SAM2å›¾åƒåˆ†å‰²æ¨¡å‹çš„å¾®è°ƒ
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/" class="article-date">
  <time datetime="2025-05-07T11:48:03.000Z" itemprop="datePublished">2025-05-07</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">æ·±åº¦å­¦ä¹ </a> / <a class="article-category-link" href="/categories/%E7%BC%96%E7%A8%8B/">ç¼–ç¨‹</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> å­—æ•°ç»Ÿè®¡:</span>
            <span class="post-count">5.6k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> é˜…è¯»æ—¶é•¿â‰ˆ</span>
            <span class="post-count">27 åˆ†é’Ÿ</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p>Segment Anything Model 2ï¼ˆSAM 2ï¼‰ä½œä¸ºMetaå…¬å¸å‘å¸ƒçš„Segment Anything Modelï¼ˆSAMï¼‰çš„å‡çº§ç‰ˆæœ¬ï¼Œåœ¨å›¾åƒå’Œè§†é¢‘åˆ†å‰²é¢†åŸŸå±•ç°å‡ºäº†æ˜¾è‘—çš„ä¼˜ç‚¹å’Œç‰¹æ€§ã€‚</p>
<p>æœ¬æ–‡å°†ä½¿ç”¨SAM2è¿›è¡Œé¢„æµ‹ã€è®­ç»ƒã€éªŒè¯ã€è¯„ä¼°ï¼Œä»»åŠ¡ä¸ºå›¾åƒåˆ†å‰²ã€‚å‚è€ƒä»“åº“å¦‚ä¸‹ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://github.com/sagieppel/fine-tune-train_segment_anything_2_in_60_lines_of_code">å¾®è°ƒä»£ç å‚è€ƒ</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/facebookresearch/sam2">SAM2æºç </a></p>
<span id="more"></span>
<h1 id="ğŸ”¥å‡†å¤‡å·¥ä½œ"><a href="#ğŸ”¥å‡†å¤‡å·¥ä½œ" class="headerlink" title="ğŸ”¥å‡†å¤‡å·¥ä½œ"></a>ğŸ”¥å‡†å¤‡å·¥ä½œ</h1><p>å‡è®¾é©±åŠ¨å’Œcudaï¼ˆæˆ‘çš„æ˜¯12.6ï¼‰å·²ç»æœ‰äº†ï¼Œå®‰è£…condaï¼Œåˆ°ä»¥ä¸‹é“¾æ¥ä¸‹è½½å®‰è£…ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive/?C=M&O=D">conda</a></p>
<p>å®‰è£…condaï¼Œé¡ºå¸¦ä¸‹è½½æƒé‡æ–‡ä»¶</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">bash</span> Anaconda3-2024.10-1-Linux-x86_64.sh
conda create -n leosam2 python<span class="token operator">=</span>3.10
conda activate leosam2
pip <span class="token function">install</span> -e <span class="token keyword">.</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">cd</span> checkpoints
./download_ckpts.sh
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ä¸ºVSCodeè®¾ç½®é¡¹ç›®å¯¹åº”å¯¹é…ç½®ï¼š</p>
<pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"python.autoComplete.extraPaths"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"/home/zigaa/leosam2/sam2"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"python.analysis.extraPaths"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"/home/zigaa/leosam2/sam2"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>
    <span class="token property">"configurations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Python è°ƒè¯•ç¨‹åº: é¢„æµ‹"</span><span class="token punctuation">,</span>
            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"debugpy"</span><span class="token punctuation">,</span>
            <span class="token property">"request"</span><span class="token operator">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span>
            <span class="token property">"program"</span><span class="token operator">:</span> <span class="token string">"/home/zigaa/leosam2/training/predict.py"</span><span class="token punctuation">,</span>
            <span class="token property">"console"</span><span class="token operator">:</span> <span class="token string">"integratedTerminal"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="ğŸ”¥æ•°æ®é›†"><a href="#ğŸ”¥æ•°æ®é›†" class="headerlink" title="ğŸ”¥æ•°æ®é›†"></a>ğŸ”¥æ•°æ®é›†</h1><p><img src="/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/LabPicsV1%E6%95%B0%E6%8D%AE%E9%9B%86.png" alt="LabPicsV1æ•°æ®é›†"></p>
<p><a target="_blank" rel="noopener" href="https://zenodo.org/records/3697452/files/LabPicsV1.zip?download=1">LabPicsV1æ•°æ®é›†</a></p>
<p>å…ˆé€‰ä¸€ä¸ªç›¸å¯¹ä¸å¤§æ•°æ®é›†LabPicsV1è¿›è¡Œè®­ç»ƒï¼Œç”¨äºè·‘é€šä»£ç å’Œè°ƒä¼˜æ–¹æ³•çš„å°è¯•ã€‚ä¸»è¦æ˜¯å¯¹å®¹å™¨åŠå…¶å†…éƒ¨çš„ææ–™ï¼ˆå›ºã€æ¶²ä½“ï¼‰è¿›è¡Œåˆ†å‰²ï¼Œå®ƒå…·æœ‰ä¸€å®šéš¾åº¦ä¸”ä½“é‡ä¸å¤§ï¼Œå¾ˆé€‚åˆåˆæ­¥å®éªŒã€‚</p>
<p>æ•°æ®æ ¼å¼å°±æ˜¯å›¾åƒåŠå…¶æ©ç ï¼Œéƒ½æ˜¯å›¾ç‰‡æ ¼å¼ï¼Œå…¶ä¸­æ©ç æœ‰æä¾›å®ä¾‹åˆ†å‰²çš„æ©ç ï¼Œå›¾åƒçš„ä¸‰é€šé“ä¸­ï¼Œé€šé“0å’Œé€šé“2åˆ†åˆ«æ ‡è®°çš„æ˜¯ææ–™å’Œå®¹å™¨ï¼Œæ‰€ä»¥éœ€è¦å°†å…¶åˆå¹¶å¤„ç†åè¾“å…¥åˆ°æ¨¡å‹ã€‚</p>
<h1 id="ğŸ”¥é¢„æµ‹"><a href="#ğŸ”¥é¢„æµ‹" class="headerlink" title="ğŸ”¥é¢„æµ‹"></a>ğŸ”¥é¢„æµ‹</h1><h2 id="ğŸš€æ™®é€šé¢„æµ‹"><a href="#ğŸš€æ™®é€šé¢„æµ‹" class="headerlink" title="ğŸš€æ™®é€šé¢„æµ‹"></a>ğŸš€æ™®é€šé¢„æµ‹</h2><p>è¯»å–æƒé‡å’Œå›¾ç‰‡ï¼Œå°±å¯ä»¥è¿›è¡Œåˆ†å‰²ï¼Œç»˜åˆ¶å‡ºæ•ˆæœã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> sam2<span class="token punctuation">.</span>build_sam <span class="token keyword">import</span> build_sam2
<span class="token keyword">from</span> sam2<span class="token punctuation">.</span>sam2_image_predictor <span class="token keyword">import</span> SAM2ImagePredictor
<span class="token keyword">import</span> sys

os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"using device: {device}"</span><span class="token punctuation">)</span>

np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show_mask</span><span class="token punctuation">(</span>mask<span class="token punctuation">,</span> ax<span class="token punctuation">,</span> random_color<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> borders <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> random_color<span class="token punctuation">:</span>
        color <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        color <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">144</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    h<span class="token punctuation">,</span> w <span class="token operator">=</span> mask<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    mask <span class="token operator">=</span> mask<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    mask_image <span class="token operator">=</span>  mask<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> color<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> borders<span class="token punctuation">:</span>
        <span class="token keyword">import</span> cv2
        contours<span class="token punctuation">,</span> _ <span class="token operator">=</span> cv2<span class="token punctuation">.</span>findContours<span class="token punctuation">(</span>mask<span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>RETR_EXTERNAL<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>CHAIN_APPROX_NONE<span class="token punctuation">)</span> 
        <span class="token comment" spellcheck="true"># Try to smooth contours</span>
        contours <span class="token operator">=</span> <span class="token punctuation">[</span>cv2<span class="token punctuation">.</span>approxPolyDP<span class="token punctuation">(</span>contour<span class="token punctuation">,</span> epsilon<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> closed<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token keyword">for</span> contour <span class="token keyword">in</span> contours<span class="token punctuation">]</span>
        mask_image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>drawContours<span class="token punctuation">(</span>mask_image<span class="token punctuation">,</span> contours<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> thickness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> 
    ax<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>mask_image<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show_points</span><span class="token punctuation">(</span>coords<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> ax<span class="token punctuation">,</span> marker_size<span class="token operator">=</span><span class="token number">375</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pos_points <span class="token operator">=</span> coords<span class="token punctuation">[</span>labels<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">]</span>
    neg_points <span class="token operator">=</span> coords<span class="token punctuation">[</span>labels<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">]</span>
    ax<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>pos_points<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pos_points<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'green'</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">'*'</span><span class="token punctuation">,</span> s<span class="token operator">=</span>marker_size<span class="token punctuation">,</span> edgecolor<span class="token operator">=</span><span class="token string">'white'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">1.25</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>neg_points<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> neg_points<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">'*'</span><span class="token punctuation">,</span> s<span class="token operator">=</span>marker_size<span class="token punctuation">,</span> edgecolor<span class="token operator">=</span><span class="token string">'white'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">1.25</span><span class="token punctuation">)</span>   

<span class="token keyword">def</span> <span class="token function">show_box</span><span class="token punctuation">(</span>box<span class="token punctuation">,</span> ax<span class="token punctuation">)</span><span class="token punctuation">:</span>
    x0<span class="token punctuation">,</span> y0 <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    w<span class="token punctuation">,</span> h <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    ax<span class="token punctuation">.</span>add_patch<span class="token punctuation">(</span>plt<span class="token punctuation">.</span>Rectangle<span class="token punctuation">(</span><span class="token punctuation">(</span>x0<span class="token punctuation">,</span> y0<span class="token punctuation">)</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> edgecolor<span class="token operator">=</span><span class="token string">'green'</span><span class="token punctuation">,</span> facecolor<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lw<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    

<span class="token keyword">def</span> <span class="token function">show_masks</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> masks<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> point_coords<span class="token operator">=</span>None<span class="token punctuation">,</span> box_coords<span class="token operator">=</span>None<span class="token punctuation">,</span> input_labels<span class="token operator">=</span>None<span class="token punctuation">,</span> borders<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>mask<span class="token punctuation">,</span> score<span class="token punctuation">)</span> <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>zip<span class="token punctuation">(</span>masks<span class="token punctuation">,</span> scores<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        show_mask<span class="token punctuation">(</span>mask<span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> borders<span class="token operator">=</span>borders<span class="token punctuation">)</span>
        <span class="token keyword">if</span> point_coords <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>
            <span class="token keyword">assert</span> input_labels <span class="token keyword">is</span> <span class="token operator">not</span> None
            show_points<span class="token punctuation">(</span>point_coords<span class="token punctuation">,</span> input_labels<span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> box_coords <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># boxes</span>
            show_box<span class="token punctuation">(</span>box_coords<span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> len<span class="token punctuation">(</span>scores<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>
            plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span>f<span class="token string">"Mask {i+1}, Score: {score:.3f}"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

image <span class="token operator">=</span> Image<span class="token punctuation">.</span>open<span class="token punctuation">(</span><span class="token string">'../notebooks/images/truck.jpg'</span><span class="token punctuation">)</span>
image <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>image<span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">"RGB"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

sam2_checkpoint <span class="token operator">=</span> <span class="token string">"../checkpoints/sam2_hiera_large.pt"</span>
model_cfg <span class="token operator">=</span> <span class="token string">"../sam2_configs/sam2_hiera_l.yaml"</span>

sam2_model <span class="token operator">=</span> build_sam2<span class="token punctuation">(</span>model_cfg<span class="token punctuation">,</span> sam2_checkpoint<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>

predictor <span class="token operator">=</span> SAM2ImagePredictor<span class="token punctuation">(</span>sam2_model<span class="token punctuation">)</span>

predictor<span class="token punctuation">.</span>set_image<span class="token punctuation">(</span>image<span class="token punctuation">)</span>

input_point <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">375</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
input_label <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
masks<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> logits <span class="token operator">=</span> predictor<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>
    point_coords<span class="token operator">=</span>input_point<span class="token punctuation">,</span>
    point_labels<span class="token operator">=</span>input_label<span class="token punctuation">,</span>
    multimask_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
sorted_ind <span class="token operator">=</span> np<span class="token punctuation">.</span>argsort<span class="token punctuation">(</span>scores<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
masks <span class="token operator">=</span> masks<span class="token punctuation">[</span>sorted_ind<span class="token punctuation">]</span>
scores <span class="token operator">=</span> scores<span class="token punctuation">[</span>sorted_ind<span class="token punctuation">]</span>
logits <span class="token operator">=</span> logits<span class="token punctuation">[</span>sorted_ind<span class="token punctuation">]</span>

show_masks<span class="token punctuation">(</span>image<span class="token punctuation">,</span> masks<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> point_coords<span class="token operator">=</span>input_point<span class="token punctuation">,</span> input_labels<span class="token operator">=</span>input_label<span class="token punctuation">,</span> borders<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é¢„æµ‹æ—¶æŠ¥äº†é”™ï¼Œæ˜¯å› ä¸ºæºç å¯¹ç‚¹ç§¯æ³¨æ„åŠ›çš„è®¡ç®—ä¹‹å‰è®¾ç½®äº†ä¸€äº›ä¼˜åŒ–é€‰é¡¹å¯¼è‡´qkvå¿…é¡»æ˜¯halfç²¾åº¦ï¼Œæ‰€ä»¥è¿™é‡Œæš‚ä¸”æ³¨é‡Šæ‰è¿™äº›é…ç½®ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python">        <span class="token comment" spellcheck="true"># Attention</span>
        <span class="token comment" spellcheck="true"># with torch.backends.cuda.sdp_kernel(</span>
        <span class="token comment" spellcheck="true">#     enable_flash=USE_FLASH_ATTN,</span>
        <span class="token comment" spellcheck="true">#     # if Flash attention kernel is off, then math kernel needs to be enabled</span>
        <span class="token comment" spellcheck="true">#     enable_math=(OLD_GPU and dropout_p > 0.0) or MATH_KERNEL_ON,</span>
        <span class="token comment" spellcheck="true">#     enable_mem_efficient=OLD_GPU,</span>
        <span class="token comment" spellcheck="true"># ):</span>
        out <span class="token operator">=</span> F<span class="token punctuation">.</span>scaled_dot_product_attention<span class="token punctuation">(</span>q<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">,</span> dropout_p<span class="token operator">=</span>dropout_p<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/%E6%99%AE%E9%80%9A%E9%A2%84%E6%B5%8B.png" alt="æ™®é€šé¢„æµ‹"></p>
<p>è¿™æ˜¯ç»™å®šä¸€ä¸ªç›®æ ‡ç‚¹ä½œä¸ºæç¤ºçš„é¢„æµ‹æ•ˆæœï¼Œå¯ä»¥çœ‹åˆ°å¯ä»¥ç¨³å®šåˆ†å‰²å‡ºç›®æ ‡ã€‚</p>
<h2 id="ğŸš€åˆ†å‰²ä¸€åˆ‡"><a href="#ğŸš€åˆ†å‰²ä¸€åˆ‡" class="headerlink" title="ğŸš€åˆ†å‰²ä¸€åˆ‡"></a>ğŸš€åˆ†å‰²ä¸€åˆ‡</h2><pre class="line-numbers language-python"><code class="language-python">sam2 <span class="token operator">=</span> build_sam2<span class="token punctuation">(</span>model_cfg<span class="token punctuation">,</span> sam2_checkpoint<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">,</span> apply_postprocessing<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># mask_generator = SAM2AutomaticMaskGenerator(sam2)</span>
mask_generator <span class="token operator">=</span> SAM2AutomaticMaskGenerator<span class="token punctuation">(</span>
    model<span class="token operator">=</span>sam2<span class="token punctuation">,</span>
    points_per_side<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>
    points_per_batch<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span>
    pred_iou_thresh<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
    stability_score_thresh<span class="token operator">=</span><span class="token number">0.92</span><span class="token punctuation">,</span>
    stability_score_offset<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
    crop_n_layers<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    box_nms_thresh<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
    crop_n_points_downscale_factor<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
    min_mask_region_area<span class="token operator">=</span><span class="token number">25.0</span><span class="token punctuation">,</span>
    use_m2m<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
masks <span class="token operator">=</span> mask_generator<span class="token punctuation">.</span>generate<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'{len(masks)}ä¸ªæ©ç '</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>masks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
show_anns<span class="token punctuation">(</span>masks<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥é€šè¿‡ä¸Šè¿°æ–¹æ³•åˆ†å‰²å…¨å›¾ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/%E5%88%86%E5%89%B2%E4%B8%80%E5%88%87.png" alt="åˆ†å‰²ä¸€åˆ‡"></p>
<h1 id="ğŸ”¥è®­ç»ƒï¼ˆå‚è€ƒï¼‰"><a href="#ğŸ”¥è®­ç»ƒï¼ˆå‚è€ƒï¼‰" class="headerlink" title="ğŸ”¥è®­ç»ƒï¼ˆå‚è€ƒï¼‰"></a>ğŸ”¥è®­ç»ƒï¼ˆå‚è€ƒï¼‰</h1><p>ç”¨çš„æ˜¯<a target="_blank" rel="noopener" href="https://github.com/sagieppel/fine-tune-train_segment_anything_2_in_60_lines_of_code">å¾®è°ƒä»£ç å‚è€ƒä»“åº“</a>çš„ä»£ç ã€‚è¿™æ˜¯æ¯”è¾ƒç®€å•çš„è®­ç»ƒè„šæœ¬ï¼Œé’ˆå¯¹çš„æ˜¯æ•°æ®é›†LabPicsV1ï¼Œä¸»è¦æ˜¯å¯¹å®¹å™¨åŠå…¶å†…éƒ¨çš„æ¶²ä½“è¿›è¡Œåˆ†å‰²ã€‚</p>
<p>è„šæœ¬æµç¨‹ï¼šè¯»å–æ•°æ®é›†è¿›è¡Œé¢„å¤„ç†-&gt;æ„å»ºæ¨¡å‹åŠ è½½æƒé‡-&gt;å®šä¹‰ä¼˜åŒ–å™¨-&gt;è®­ç»ƒå¾ªç¯ã€‚</p>
<p>è®­ç»ƒè¿‡ç¨‹å°±æ˜¯å¯¹SAM2çš„å„ä¸ªç»„ä»¶è¿›è¡Œå‰å‘ä¼ æ’­ã€‚</p>
<p><img src="/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/%E8%AE%AD%E7%BB%83%E7%94%BB%E9%9D%A2.png" alt="è®­ç»ƒ"></p>
<h1 id="ğŸ”¥è®­ç»ƒ"><a href="#ğŸ”¥è®­ç»ƒ" class="headerlink" title="ğŸ”¥è®­ç»ƒ"></a>ğŸ”¥è®­ç»ƒ</h1><p>æ¥ä¸‹æ¥å¼€å§‹è‡ªä¸»ç¼–å†™è®­ç»ƒè„šæœ¬ã€‚å¯¹äºæ¯ä¸ªå®ä¾‹ä»…ç”Ÿæˆå•ä¸ªmaskï¼Œèƒ½åˆ†å‰²å‡ºå›¾ä¸­çš„å…¨éƒ¨å®¹å™¨å³å¯ã€‚</p>
<h2 id="ğŸš€dataset-x2F-dataloader"><a href="#ğŸš€dataset-x2F-dataloader" class="headerlink" title="ğŸš€dataset&#x2F;dataloader"></a>ğŸš€dataset&#x2F;dataloader</h2><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">LabPicsDataset</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_dir<span class="token punctuation">,</span> transform<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>data_dir <span class="token operator">=</span> data_dir
        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transform
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_data<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_load_data</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        image_folder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_dir<span class="token punctuation">,</span> <span class="token string">"Simple/Train/Image"</span><span class="token punctuation">)</span>
        annotation_folder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_dir<span class="token punctuation">,</span> <span class="token string">"Simple/Train/Instance"</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>image_folder<span class="token punctuation">)</span><span class="token punctuation">:</span>
            image_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>image_folder<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
            annotation_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>annotation_folder<span class="token punctuation">,</span> name<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".png"</span><span class="token punctuation">)</span>
            data<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"image"</span><span class="token punctuation">:</span> image_path<span class="token punctuation">,</span> <span class="token string">"annotation"</span><span class="token punctuation">:</span> annotation_path<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> data

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        entry <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>entry<span class="token punctuation">[</span><span class="token string">"image"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># è¯»å–å›¾åƒå¹¶è½¬æ¢ä¸º RGB æ ¼å¼</span>
        annotation <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>entry<span class="token punctuation">[</span><span class="token string">"annotation"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># è¯»å–æ ‡æ³¨</span>

        <span class="token comment" spellcheck="true"># è°ƒæ•´å›¾åƒå¤§å°</span>
        r <span class="token operator">=</span> np<span class="token punctuation">.</span>min<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ç¼©æ”¾å› å­</span>
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token punctuation">(</span>int<span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        annotation <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>annotation<span class="token punctuation">,</span> <span class="token punctuation">(</span>int<span class="token punctuation">(</span>annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_NEAREST<span class="token punctuation">)</span>

        <span class="token keyword">if</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">:</span>
            image <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">-</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            annotation <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>annotation<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">-</span> annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">:</span>
            image <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">-</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            annotation <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>annotation<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">-</span> annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># åˆå¹¶ææ–™å’Œå®¹å™¨æ ‡æ³¨</span>
        mat_map <span class="token operator">=</span> annotation<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
        ves_map <span class="token operator">=</span> annotation<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
        mat_map<span class="token punctuation">[</span>mat_map <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> ves_map<span class="token punctuation">[</span>mat_map <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span>mat_map<span class="token punctuation">.</span>max<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># è·å–äºŒå€¼æ©ç å’Œç‚¹</span>
        inds <span class="token operator">=</span> np<span class="token punctuation">.</span>unique<span class="token punctuation">(</span>mat_map<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> len<span class="token punctuation">(</span>inds<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            ind <span class="token operator">=</span> inds<span class="token punctuation">[</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>len<span class="token punctuation">(</span>inds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token comment" spellcheck="true"># mask = (mat_map == ind).astype(np.uint8)</span>
            mask <span class="token operator">=</span> <span class="token punctuation">(</span>mat_map <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>           <span class="token comment" spellcheck="true"># å…¨éƒ¨maskåˆæˆä¸€ä¸ªï¼ˆå…¨éƒ¨é¢„æµ‹å‡ºæ¥ï¼‰</span>
            coords <span class="token operator">=</span> np<span class="token punctuation">.</span>argwhere<span class="token punctuation">(</span>mask <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            yx <span class="token operator">=</span> coords<span class="token punctuation">[</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>len<span class="token punctuation">(</span>coords<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            point <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>yx<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> yx<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># å¦‚æœæ²¡æœ‰æœ‰æ•ˆæ ‡æ³¨ï¼Œè¿”å›å…¨é›¶æ©ç å’Œéšæœºç‚¹</span>
            mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
            point <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">:</span>
            image <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span>

        <span class="token keyword">return</span> image<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>point<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é’ˆå¯¹è¿™ä¸ªæ•°æ®é›†åšçš„DataSetç±»ï¼Œè¯»å–æ ‡æ³¨æ–‡ä»¶å¯¹å®¹å™¨å’Œææ–™çš„é€šé“è¿›è¡Œåˆå¹¶å¾—åˆ°æ ‡æ³¨çš„maskï¼Œå•ä¸ªæ ·æœ¬åŒ…å«è¾“å…¥çš„åŸå›¾ï¼ˆ3*H*Wï¼‰ã€æ ‡æ³¨çš„maskï¼ˆH*Wï¼‰ã€æç¤ºç‚¹ï¼ˆåæ ‡åˆ—è¡¨ï¼‰ã€æç¤ºç‚¹ç±»å‹ï¼ˆæ­£&#x2F;è´Ÿï¼Œè¿™é‡Œæš‚æ—¶åªç”¨æ­£ï¼‰ã€‚</p>
<p>è¿™é‡Œ<code>maskÂ =Â (mat\_mapÂ &gt;Â 0).astype(np.uint8)</code>è¡¨ç¤ºçš„æ˜¯æŠŠè¯¥å›¾ä¸­æ‰€æœ‰çš„maskåˆå¹¶æˆåŒä¸€ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬ç›®å‰å¸Œæœ›æ¨¡å‹èƒ½ä¸€æ¬¡æ€§æ‰¾å‡ºæ‰€æœ‰ç›®æ ‡ï¼ˆä¸å¤ªéœ€è¦å®ä¾‹çº§åˆ«çš„åˆ†å‰²ï¼Œå®ä¾‹åˆ†å‰²æ¨ç†é€Ÿåº¦ä¹Ÿä¼šå¾ˆæ…¢ï¼‰ï¼Œè€Œå¦‚æœæ¯æ¬¡éƒ½éšæœºé€‰ä¸€ä¸ªmaskè®©å®ƒé¢„æµ‹ä¼šè®©æ¨¡å‹é¢„æµ‹æ··ä¹±ã€‚</p>
<h2 id="ğŸš€æŸå¤±å‡½æ•°"><a href="#ğŸš€æŸå¤±å‡½æ•°" class="headerlink" title="ğŸš€æŸå¤±å‡½æ•°"></a>ğŸš€æŸå¤±å‡½æ•°</h2><p><strong>DiceÂ Loss</strong>ï¼Œæ˜¯ä¸€ç§å¸¸ç”¨äºåˆ†å‰²ä»»åŠ¡çš„æŸå¤±å‡½æ•°ï¼Œç‰¹åˆ«é€‚ç”¨äºå¤„ç†åˆ†å‰²æ©ç ï¼ˆmasksï¼‰çš„äºŒå€¼åˆ†ç±»é—®é¢˜ã€‚DiceÂ æŸå¤±ç±»ä¼¼äºå¹¿ä¹‰çš„äº¤å¹¶æ¯”ï¼ˆIoUï¼‰ï¼Œç”¨äºè¡¡é‡é¢„æµ‹æ©ç å’ŒçœŸå®æ©ç ä¹‹é—´çš„ç›¸ä¼¼åº¦ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">dice_loss</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">,</span> loss_on_multimask<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Dice Loss
    """</span>
    inputs <span class="token operator">=</span> inputs<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> loss_on_multimask<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># inputs and targets are [N, M, H, W] where M corresponds to multiple predicted masks</span>
        <span class="token keyword">assert</span> inputs<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">and</span> targets<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span>
        <span class="token comment" spellcheck="true"># flatten spatial dimension while keeping multimask channel dimension</span>
        inputs <span class="token operator">=</span> inputs<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        targets <span class="token operator">=</span> targets<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        numerator <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>inputs <span class="token operator">*</span> targets<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        inputs <span class="token operator">=</span> inputs<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        targets <span class="token operator">=</span> targets<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        numerator <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>inputs <span class="token operator">*</span> targets<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    denominator <span class="token operator">=</span> inputs<span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> targets<span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    loss <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span>numerator <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>denominator <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> loss_on_multimask<span class="token punctuation">:</span>
        <span class="token keyword">return</span> loss <span class="token operator">/</span> num_objects
    <span class="token keyword">return</span> loss<span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> num_objects
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>FocalÂ Loss</strong>ï¼Œåœ¨äº¤å‰ç†µçš„åŸºç¡€ä¸Šè¿›è¡Œæ”¹è¿›çš„ä¸€ç§æŸå¤±ï¼Œé€‚åˆå¯†é›†é¢„æµ‹ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">sigmoid_focal_loss</span><span class="token punctuation">(</span>
    inputs<span class="token punctuation">,</span>
    targets<span class="token punctuation">,</span>
    num_objects<span class="token punctuation">,</span>
    alpha<span class="token punctuation">:</span> float <span class="token operator">=</span> <span class="token number">0.25</span><span class="token punctuation">,</span>
    gamma<span class="token punctuation">:</span> float <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    loss_on_multimask<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Focal Loss 
    """</span>
    prob <span class="token operator">=</span> inputs<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ce_loss <span class="token operator">=</span> F<span class="token punctuation">.</span>binary_cross_entropy_with_logits<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">"none"</span><span class="token punctuation">)</span>
    p_t <span class="token operator">=</span> prob <span class="token operator">*</span> targets <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> prob<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> targets<span class="token punctuation">)</span>
    loss <span class="token operator">=</span> ce_loss <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> p_t<span class="token punctuation">)</span> <span class="token operator">**</span> gamma<span class="token punctuation">)</span>

    <span class="token keyword">if</span> alpha <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        alpha_t <span class="token operator">=</span> alpha <span class="token operator">*</span> targets <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> alpha<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> targets<span class="token punctuation">)</span>
        loss <span class="token operator">=</span> alpha_t <span class="token operator">*</span> loss

    <span class="token keyword">if</span> loss_on_multimask<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># loss is [N, M, H, W] where M corresponds to multiple predicted masks</span>
        <span class="token keyword">assert</span> loss<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span>
        <span class="token keyword">return</span> loss<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> num_objects  <span class="token comment" spellcheck="true"># average over spatial dims</span>
    <span class="token keyword">return</span> loss<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> num_objects
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>dIoUÂ Loss</strong>ï¼ŒdæŒ‡çš„æ˜¯å·®å€¼ï¼Œæ¨¡å‹ä¼šé¢„æµ‹ä¸€ä¸ªIoUï¼Œè¯¥æŸå¤±å°±æ˜¯åæ˜ è¿™ä¸ªé¢„æµ‹å€¼çš„æŸå¤±ï¼Œï¼ˆIoUæ˜¯è®¡ç®—äº¤é›†å’Œå¹¶é›†ä¹‹æ¯”ï¼Œåæ˜ é¢„æµ‹maskä¸åŸmaskçš„é‡åˆç¨‹åº¦ï¼‰ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">diou_loss</span><span class="token punctuation">(</span>
    inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> pred_ious<span class="token punctuation">,</span> num_objects<span class="token punctuation">,</span> loss_on_multimask<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> use_l1_loss<span class="token operator">=</span><span class="token boolean">False</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    äº¤å¹¶æ¯”æŸå¤±
    Args:
        inputs: A float tensor of arbitrary shape.
                The predictions for each example.
        targets: A float tensor with the same shape as inputs. Stores the binary
                 classification label for each element in inputs
                (0 for the negative class and 1 for the positive class).
        pred_ious: A float tensor containing the predicted dIoUs scores per mask
        num_objects: Number of objects in the batch
        loss_on_multimask: True if multimask prediction is enabled
        use_l1_loss: Whether to use L1 loss is used instead of MSE loss
    Returns:
        dIoU loss tensor
    """</span>
    <span class="token keyword">assert</span> inputs<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">and</span> targets<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span>
    pred_mask <span class="token operator">=</span> inputs<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span>
    gt_mask <span class="token operator">=</span> targets<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span>
    area_i <span class="token operator">=</span> torch<span class="token punctuation">.</span>sum<span class="token punctuation">(</span>pred_mask <span class="token operator">&amp;</span> gt_mask<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>float<span class="token punctuation">(</span><span class="token punctuation">)</span>
    area_u <span class="token operator">=</span> torch<span class="token punctuation">.</span>sum<span class="token punctuation">(</span>pred_mask <span class="token operator">|</span> gt_mask<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>float<span class="token punctuation">(</span><span class="token punctuation">)</span>
    actual_ious <span class="token operator">=</span> area_i <span class="token operator">/</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>area_u<span class="token punctuation">,</span> min<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> use_l1_loss<span class="token punctuation">:</span>
        loss <span class="token operator">=</span> F<span class="token punctuation">.</span>l1_loss<span class="token punctuation">(</span>pred_ious<span class="token punctuation">,</span> actual_ious<span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">"none"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        loss <span class="token operator">=</span> F<span class="token punctuation">.</span>mse_loss<span class="token punctuation">(</span>pred_ious<span class="token punctuation">,</span> actual_ious<span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">"none"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> loss_on_multimask<span class="token punctuation">:</span>
        <span class="token keyword">return</span> loss <span class="token operator">/</span> num_objects
    <span class="token keyword">return</span> loss<span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> num_objects
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>IoUÂ Loss</strong>ï¼Œä¸‹é¢è¿™ä¸ªå°±æ˜¯æ­£å„¿å…«ç»çš„IoUæŸå¤±ï¼Œç›´æ¥åæ˜ é¢„æµ‹maskä¸åŸmaskçš„é‡åˆç¨‹åº¦ï¼Œè¿™é‡Œæˆ‘å°†å…¶æ˜ å°„åˆ°tanhï¼ˆå€¼åŸŸ0-1ï¼‰å½“ä¸­ï¼Œä¹˜ä»¥3æ˜¯ä¸ºäº†æ˜ å°„IoUåˆ°ä¸­é—´æ¢¯åº¦æ¯”è¾ƒå¤§çš„éƒ¨åˆ†ï¼Œä»¥æ›´å¥½åŒºåˆ†ä¸åŒçš„é¢„æµ‹æ•ˆæœã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">iou_loss</span><span class="token punctuation">(</span>
    inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">,</span> loss_on_multimask<span class="token operator">=</span><span class="token boolean">False</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    äº¤å¹¶æ¯”æŸå¤±
    Args:
        inputs: A float tensor of arbitrary shape.
                The predictions for each example.
        targets: A float tensor with the same shape as inputs. Stores the binary
                 classification label for each element in inputs
                (0 for the negative class and 1 for the positive class).
        num_objects: Number of objects in the batch
        loss_on_multimask: True if multimask prediction is enabled
    Returns:
        IoU loss tensor
    """</span>
    <span class="token keyword">assert</span> inputs<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">and</span> targets<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span>
    pred_mask <span class="token operator">=</span> inputs<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span>
    gt_mask <span class="token operator">=</span> targets<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span>
    area_i <span class="token operator">=</span> torch<span class="token punctuation">.</span>sum<span class="token punctuation">(</span>pred_mask <span class="token operator">&amp;</span> gt_mask<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>float<span class="token punctuation">(</span><span class="token punctuation">)</span>
    area_u <span class="token operator">=</span> torch<span class="token punctuation">.</span>sum<span class="token punctuation">(</span>pred_mask <span class="token operator">|</span> gt_mask<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>float<span class="token punctuation">(</span><span class="token punctuation">)</span>
    actual_ious <span class="token operator">=</span> area_i <span class="token operator">/</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>area_u<span class="token punctuation">,</span> min<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>
    loss <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span>tanh<span class="token punctuation">(</span>actual_ious <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> loss_on_multimask<span class="token punctuation">:</span>
        <span class="token keyword">return</span> loss <span class="token operator">/</span> num_objects
    <span class="token keyword">return</span> loss<span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> num_objects
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯¹ä¸Šé¢çš„æŸå¤±åŠ æƒæ±‚å’Œå°±æ˜¯<strong>æ€»çš„æŸå¤±</strong>äº†ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">total_loss</span><span class="token punctuation">(</span>
    inputs<span class="token punctuation">,</span>
    targets<span class="token punctuation">,</span>
    pred_ious<span class="token punctuation">,</span>
    num_objects<span class="token punctuation">,</span>
    alpha<span class="token punctuation">:</span> float <span class="token operator">=</span> <span class="token number">0.25</span><span class="token punctuation">,</span>
    gamma<span class="token punctuation">:</span> float <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    loss_on_multimask<span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    use_l1_loss<span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    dice_weight<span class="token punctuation">:</span> float <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    focal_weight<span class="token punctuation">:</span> float <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    diou_weight<span class="token punctuation">:</span> float <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    iou_weight<span class="token punctuation">:</span> float <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Tuple<span class="token punctuation">[</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span> Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>

    <span class="token comment" spellcheck="true"># Compute individual losses</span>
    dice <span class="token operator">=</span> dice_loss<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">,</span> loss_on_multimask<span class="token punctuation">)</span>
    focal <span class="token operator">=</span> sigmoid_focal_loss<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span> loss_on_multimask<span class="token punctuation">)</span>
    diou <span class="token operator">=</span> diou_loss<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> pred_ious<span class="token punctuation">,</span> num_objects<span class="token punctuation">,</span> loss_on_multimask<span class="token punctuation">,</span> use_l1_loss<span class="token punctuation">)</span>
    iou <span class="token operator">=</span> iou_loss<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">,</span> loss_on_multimask<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># Combine losses with weights</span>
    total <span class="token operator">=</span> dice_weight <span class="token operator">*</span> dice <span class="token operator">+</span> focal_weight <span class="token operator">*</span> focal <span class="token operator">+</span> diou_weight <span class="token operator">*</span> diou <span class="token operator">+</span> iou <span class="token operator">*</span> iou_weight

    <span class="token keyword">return</span> total<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"dice"</span><span class="token punctuation">:</span> dice_weight <span class="token operator">*</span> dice<span class="token punctuation">,</span> <span class="token string">"focal"</span><span class="token punctuation">:</span> focal_weight <span class="token operator">*</span> focal<span class="token punctuation">,</span> <span class="token string">"diou"</span><span class="token punctuation">:</span> diou_weight <span class="token operator">*</span> diou<span class="token punctuation">,</span> <span class="token string">"iou"</span><span class="token punctuation">:</span> iou_weight <span class="token operator">*</span> iou<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ğŸš€è®­ç»ƒè„šæœ¬"><a href="#ğŸš€è®­ç»ƒè„šæœ¬" class="headerlink" title="ğŸš€è®­ç»ƒè„šæœ¬"></a>ğŸš€è®­ç»ƒè„šæœ¬</h2><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>amp <span class="token keyword">import</span> GradScaler<span class="token punctuation">,</span> autocast
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>tensorboard <span class="token keyword">import</span> SummaryWriter

<span class="token keyword">from</span> sam2<span class="token punctuation">.</span>build_sam <span class="token keyword">import</span> build_sam2
<span class="token keyword">from</span> sam2<span class="token punctuation">.</span>sam2_image_predictor <span class="token keyword">import</span> SAM2ImagePredictor
<span class="token keyword">from</span> training<span class="token punctuation">.</span>loss_fn <span class="token keyword">import</span> total_loss
<span class="token keyword">from</span> training<span class="token punctuation">.</span>dataset <span class="token keyword">import</span> LabPicsDataset
<span class="token keyword">import</span> sys

os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="å‰å‘ä¼ æ’­"><a href="#å‰å‘ä¼ æ’­" class="headerlink" title="å‰å‘ä¼ æ’­"></a>å‰å‘ä¼ æ’­</h3><p>å°±æ˜¯é€æ­¥åœ°å°†æ•°æ®é›†çš„batchè¾“å…¥åˆ°æ¨¡å‹çš„å„ä¸ªéƒ¨åˆ†è¿›è¡Œä¼ æ’­ï¼Œå¯ä»¥è®¾å®šæœ‰&#x2F;æ— æç¤ºçš„æ¨ç†æ–¹æ³•ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">forward_net</span><span class="token punctuation">(</span>predictor<span class="token punctuation">,</span> image_list<span class="token punctuation">,</span> use_prompt<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> input_point<span class="token operator">=</span>None<span class="token punctuation">,</span> input_label<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">:</span>
    predictor<span class="token punctuation">.</span>set_image_batch<span class="token punctuation">(</span>image_list<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># åº”ç”¨å›¾åƒç¼–ç å™¨</span>
    <span class="token keyword">if</span> use_prompt<span class="token punctuation">:</span>
        mask_input<span class="token punctuation">,</span> unnorm_coords<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> unnorm_box <span class="token operator">=</span> predictor<span class="token punctuation">.</span>_prep_prompts<span class="token punctuation">(</span>input_point<span class="token punctuation">,</span> input_label<span class="token punctuation">,</span> box<span class="token operator">=</span>None<span class="token punctuation">,</span> mask_logits<span class="token operator">=</span>None<span class="token punctuation">,</span> normalize_coords<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true"># æœ‰æç¤º</span>
        sparse_embeddings<span class="token punctuation">,</span> dense_embeddings <span class="token operator">=</span> predictor<span class="token punctuation">.</span>model<span class="token punctuation">.</span>sam_prompt_encoder<span class="token punctuation">(</span>points<span class="token operator">=</span><span class="token punctuation">(</span>unnorm_coords<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">,</span> boxes<span class="token operator">=</span>None<span class="token punctuation">,</span> masks<span class="token operator">=</span>None<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        sparse_embeddings<span class="token punctuation">,</span> dense_embeddings <span class="token operator">=</span> predictor<span class="token punctuation">.</span>model<span class="token punctuation">.</span>sam_prompt_encoder<span class="token punctuation">(</span>points<span class="token operator">=</span>None<span class="token punctuation">,</span> boxes<span class="token operator">=</span>None<span class="token punctuation">,</span> masks<span class="token operator">=</span>None<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># æ— æç¤º</span>
    
    high_res_features <span class="token operator">=</span> <span class="token punctuation">[</span>feat_level<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">for</span> feat_level <span class="token keyword">in</span> predictor<span class="token punctuation">.</span>_features<span class="token punctuation">[</span><span class="token string">"high_res_feats"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    low_res_masks<span class="token punctuation">,</span> prd_scores<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _ <span class="token operator">=</span> predictor<span class="token punctuation">.</span>model<span class="token punctuation">.</span>sam_mask_decoder<span class="token punctuation">(</span>
        image_embeddings<span class="token operator">=</span>predictor<span class="token punctuation">.</span>_features<span class="token punctuation">[</span><span class="token string">"image_embed"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        image_pe<span class="token operator">=</span>predictor<span class="token punctuation">.</span>model<span class="token punctuation">.</span>sam_prompt_encoder<span class="token punctuation">.</span>get_dense_pe<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        sparse_prompt_embeddings<span class="token operator">=</span>sparse_embeddings<span class="token punctuation">,</span>
        dense_prompt_embeddings<span class="token operator">=</span>dense_embeddings<span class="token punctuation">,</span>
        multimask_output<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        repeat_image<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        high_res_features<span class="token operator">=</span>high_res_features
    <span class="token punctuation">)</span>
    prd_masks <span class="token operator">=</span> predictor<span class="token punctuation">.</span>_transforms<span class="token punctuation">.</span>postprocess_masks<span class="token punctuation">(</span>low_res_masks<span class="token punctuation">,</span> predictor<span class="token punctuation">.</span>_orig_hw<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># å°†æ©ç ä¸Šé‡‡æ ·åˆ°åŸå§‹å›¾åƒåˆ†è¾¨ç‡</span>
    <span class="token keyword">return</span> prd_masks<span class="token punctuation">,</span> prd_scores<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>prd_masks<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="è®­ç»ƒå‡½æ•°"><a href="#è®­ç»ƒå‡½æ•°" class="headerlink" title="è®­ç»ƒå‡½æ•°"></a>è®­ç»ƒå‡½æ•°</h3><p>è®­ç»ƒä¸€ä¸ªepochçš„å‡½æ•°ï¼Œå‰å‘ä¼ æ’­+æŸå¤±è®¡ç®—+åå‘ä¼ æ’­+æ¢¯åº¦æ›´æ–°+å¯è§†åŒ–+å­¦ä¹ ç‡æ›´æ–°ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train_epoch</span><span class="token punctuation">(</span>predictor<span class="token punctuation">,</span> train_dataloader<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> scaler<span class="token punctuation">,</span> scheduler<span class="token punctuation">,</span> writer<span class="token punctuation">,</span> use_prompt<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> accumulation_steps<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    step <span class="token operator">=</span> len<span class="token punctuation">(</span>train_dataloader<span class="token punctuation">)</span> <span class="token operator">*</span> epoch
    <span class="token keyword">for</span> batch_idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>image<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> input_point<span class="token punctuation">,</span> input_label<span class="token punctuation">)</span> <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>train_dataloader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        gt_mask <span class="token operator">=</span> mask<span class="token punctuation">.</span>float<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        step <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">with</span> autocast<span class="token punctuation">(</span><span class="token string">'cuda'</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>bfloat16<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># æ··åˆç²¾åº¦è®­ç»ƒ</span>
            prd_masks<span class="token punctuation">,</span> prd_scores<span class="token punctuation">,</span> prd_mask <span class="token operator">=</span> forward_net<span class="token punctuation">(</span>predictor<span class="token punctuation">,</span> image<span class="token punctuation">,</span> use_prompt<span class="token punctuation">,</span> input_point <span class="token keyword">if</span> use_prompt <span class="token keyword">else</span> None<span class="token punctuation">,</span> input_label <span class="token keyword">if</span> use_prompt <span class="token keyword">else</span> None<span class="token punctuation">)</span>
            loss<span class="token punctuation">,</span> losses <span class="token operator">=</span> total_loss<span class="token punctuation">(</span>inputs<span class="token operator">=</span>prd_masks<span class="token punctuation">,</span> targets<span class="token operator">=</span>gt_mask<span class="token punctuation">,</span> pred_ious<span class="token operator">=</span>prd_scores<span class="token punctuation">,</span> num_objects<span class="token operator">=</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                    dice_weight<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">,</span> focal_weight<span class="token operator">=</span><span class="token number">12.0</span><span class="token punctuation">,</span> diou_weight<span class="token operator">=</span><span class="token number">5.0</span><span class="token punctuation">,</span> iou_weight<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">)</span>

        loss <span class="token operator">=</span> loss <span class="token operator">/</span> accumulation_steps

        <span class="token comment" spellcheck="true"># åå‘ä¼ æ’­/æ¢¯åº¦ç´¯ç§¯</span>
        predictor<span class="token punctuation">.</span>model<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        scaler<span class="token punctuation">.</span>scale<span class="token punctuation">(</span>loss<span class="token punctuation">)</span><span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>batch_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> accumulation_steps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            scaler<span class="token punctuation">.</span>step<span class="token punctuation">(</span>optimizer<span class="token punctuation">)</span>
            scaler<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># å¯è§†åŒ–</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>batch_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">50</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Epoch {epoch}, Batch {batch_idx + 1}, Loss: {loss.item() * accumulation_steps: 3f},"</span><span class="token punctuation">,</span> 
                  f<span class="token string">"Dice Loss: {losses['dice'].item(): 2f}, Focal Loss: {losses['focal'].item(): 2f}, dIOU Loss: {losses['diou'].item(): 2f}, IOU Loss: {losses['iou'].item(): 2f}"</span><span class="token punctuation">)</span>
        writer<span class="token punctuation">.</span>add_scalar<span class="token punctuation">(</span><span class="token string">'train/total loss'</span><span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> accumulation_steps<span class="token punctuation">,</span> step<span class="token punctuation">)</span>
        writer<span class="token punctuation">.</span>add_scalar<span class="token punctuation">(</span><span class="token string">'lr'</span><span class="token punctuation">,</span> optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'lr'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> step<span class="token punctuation">)</span>
        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> losses<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            writer<span class="token punctuation">.</span>add_scalar<span class="token punctuation">(</span>f<span class="token string">'train/{key}loss'</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> step<span class="token punctuation">)</span>
            
    scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true"># æ¯ä»£ç»“æŸå­¦ä¹ ç‡æ›´æ–°</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="éªŒè¯å‡½æ•°"><a href="#éªŒè¯å‡½æ•°" class="headerlink" title="éªŒè¯å‡½æ•°"></a>éªŒè¯å‡½æ•°</h3><p>éªŒè¯æ•´ä¸ªæµ‹è¯•é›†ï¼ŒéªŒè¯æ—¶éœ€è¦å…³é—­æ¢¯åº¦ï¼Œæµç¨‹å°±æ˜¯å‰å‘ä¼ æ’­+æŸå¤±è®¡ç®—+å¯è§†åŒ–ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">validate</span><span class="token punctuation">(</span>predictor<span class="token punctuation">,</span> val_dataloader<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> writer<span class="token punctuation">,</span> use_prompt<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    predictor<span class="token punctuation">.</span>model<span class="token punctuation">.</span>sam_mask_decoder<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    total_val_loss <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> batch_idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>image<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> input_point<span class="token punctuation">,</span> input_label<span class="token punctuation">)</span> <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>val_dataloader<span class="token punctuation">)</span><span class="token punctuation">:</span>    
            gt_mask <span class="token operator">=</span> mask<span class="token punctuation">.</span>float<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            prd_masks<span class="token punctuation">,</span> prd_scores<span class="token punctuation">,</span> prd_mask <span class="token operator">=</span> forward_net<span class="token punctuation">(</span>predictor<span class="token punctuation">,</span> image<span class="token punctuation">,</span> use_prompt<span class="token punctuation">,</span> input_point <span class="token keyword">if</span> use_prompt <span class="token keyword">else</span> None<span class="token punctuation">,</span> input_label <span class="token keyword">if</span> use_prompt <span class="token keyword">else</span> None<span class="token punctuation">)</span>
            val_loss<span class="token punctuation">,</span> val_losses <span class="token operator">=</span> total_loss<span class="token punctuation">(</span>inputs<span class="token operator">=</span>prd_masks<span class="token punctuation">,</span> targets<span class="token operator">=</span>gt_mask<span class="token punctuation">,</span> pred_ious<span class="token operator">=</span>prd_scores<span class="token punctuation">,</span> num_objects<span class="token operator">=</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                    dice_weight<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">,</span> focal_weight<span class="token operator">=</span><span class="token number">12.0</span><span class="token punctuation">,</span> diou_weight<span class="token operator">=</span><span class="token number">5.0</span><span class="token punctuation">,</span> iou_weight<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">)</span>
            total_val_loss <span class="token operator">+=</span> val_loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
    total_val_loss <span class="token operator">/=</span> len<span class="token punctuation">(</span>val_dataloader<span class="token punctuation">)</span>
    predictor<span class="token punctuation">.</span>model<span class="token punctuation">.</span>sam_mask_decoder<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Epoch {epoch + 1}, Val Loss: {total_val_loss:.3f}"</span><span class="token punctuation">)</span>
    writer<span class="token punctuation">.</span>add_scalar<span class="token punctuation">(</span><span class="token string">'val/total_loss'</span><span class="token punctuation">,</span> total_val_loss<span class="token punctuation">,</span> epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="è®­ç»ƒæµç¨‹"><a href="#è®­ç»ƒæµç¨‹" class="headerlink" title="è®­ç»ƒæµç¨‹"></a>è®­ç»ƒæµç¨‹</h3><pre class="line-numbers language-python"><code class="language-python">device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span><span class="token punctuation">)</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span>
batch_size <span class="token operator">=</span> <span class="token number">32</span>
model_scale_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"b+"</span><span class="token punctuation">:</span> <span class="token string">"base_plus"</span><span class="token punctuation">,</span> <span class="token string">"l"</span><span class="token punctuation">:</span> <span class="token string">"large"</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">:</span> <span class="token string">"small"</span><span class="token punctuation">}</span>
model_scale <span class="token operator">=</span> <span class="token string">"l"</span>

<span class="token comment" spellcheck="true"># æ•°æ®é›†å’Œæ•°æ®åŠ è½½å™¨</span>
train_dataset <span class="token operator">=</span> LabPicsDataset<span class="token punctuation">(</span><span class="token string">"../assets/LabPicsV1/Simple/Train/"</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
train_dataloader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
val_dataset <span class="token operator">=</span> LabPicsDataset<span class="token punctuation">(</span><span class="token string">"../assets/LabPicsV1/Simple/Test"</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
val_dataloader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>val_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># åŠ è½½æ¨¡å‹</span>
sam2_checkpoint <span class="token operator">=</span> f<span class="token string">"../checkpoints/sam2_hiera_{model_scale_dict[model_scale]}.pt"</span>
model_cfg <span class="token operator">=</span> f<span class="token string">"../sam2_configs/sam2_hiera_{model_scale}.yaml"</span>
sam2_model <span class="token operator">=</span> build_sam2<span class="token punctuation">(</span>model_cfg<span class="token punctuation">,</span> sam2_checkpoint<span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">"cuda"</span><span class="token punctuation">)</span>
predictor <span class="token operator">=</span> SAM2ImagePredictor<span class="token punctuation">(</span>sam2_model<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># predictor.model.load_state_dict(torch.load("./output/exp2/model_epoch_40.pt"))</span>

<span class="token comment" spellcheck="true"># è®¾ç½®è®­ç»ƒå‚æ•°</span>
predictor<span class="token punctuation">.</span>model<span class="token punctuation">.</span>sam_mask_decoder<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>
predictor<span class="token punctuation">.</span>model<span class="token punctuation">.</span>sam_prompt_encoder<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
predictor<span class="token punctuation">.</span>model<span class="token punctuation">.</span>image_encoder<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>AdamW<span class="token punctuation">(</span>params<span class="token operator">=</span>predictor<span class="token punctuation">.</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">4e</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>
scheduler <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>lr_scheduler<span class="token punctuation">.</span>CosineAnnealingLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> T_max<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> eta_min<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span>
scaler <span class="token operator">=</span> GradScaler<span class="token punctuation">(</span><span class="token string">'cuda'</span><span class="token punctuation">)</span>
writer <span class="token operator">=</span> SummaryWriter<span class="token punctuation">(</span>log_dir<span class="token operator">=</span><span class="token string">"output"</span><span class="token punctuation">)</span>
use_prompt <span class="token operator">=</span> <span class="token boolean">False</span>
epoches <span class="token operator">=</span> <span class="token number">500</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"train on"</span><span class="token punctuation">)</span>   
<span class="token comment" spellcheck="true"># è®­ç»ƒå¾ªç¯</span>
<span class="token keyword">for</span> epoch <span class="token keyword">in</span> range<span class="token punctuation">(</span>epoches<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># è®­ç»ƒç¯èŠ‚</span>
    train_epoch<span class="token punctuation">(</span>predictor<span class="token punctuation">,</span> train_dataloader<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> scaler<span class="token punctuation">,</span> scheduler<span class="token punctuation">,</span> writer<span class="token punctuation">,</span> use_prompt<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># éªŒè¯ç¯èŠ‚</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        validate<span class="token punctuation">(</span>predictor<span class="token punctuation">,</span> val_dataloader<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> writer<span class="token punctuation">,</span> use_prompt<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">20</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># æ¯20ä¸ª epoch ä¿å­˜ä¸€æ¬¡æ¨¡å‹</span>
        torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>predictor<span class="token punctuation">.</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token string">"./output/model_epoch_{epoch + 1}.pt"</span><span class="token punctuation">)</span>

writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è®­ç»ƒæµç¨‹å’Œå…¶ä»–æ·±åº¦å­¦ä¹ æ¨¡å‹ç±»ä¼¼ï¼Œä½¿ç”¨äº†ä¸€äº›è®­ç»ƒæŠ€å·§ã€‚</p>
<h3 id="æŠ€æœ¯"><a href="#æŠ€æœ¯" class="headerlink" title="æŠ€æœ¯"></a>æŠ€æœ¯</h3><p><img src="/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/%E4%BD%99%E5%BC%A6%E5%AD%A6%E4%B9%A0%E7%8E%87.png" alt="ä½™å¼¦å­¦ä¹ ç‡"></p>
<ul>
<li>å†»ç»“ï¼šå†»ç»“äº†<code>imageÂ encoder</code>å’Œ<code>promptÂ encoder</code>ï¼Œå› ä¸ºç¼–ç å™¨å·²ç»å­¦ä¹ åˆ°ä¸é”™çš„å›¾ç‰‡å’Œæç¤ºæŠ½ç‰¹å¾èƒ½åŠ›äº†ï¼Œå†»ç»“å®ƒä»¬å¯ä»¥åŠ å¿«è®¡ç®—ã€‚</li>
<li>ä½™å¼¦å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼šå­¦ä¹ ç‡å°†éšç€epochæŒ‰ä½™å¼¦æ›²çº¿ä¸‹é™åä¸Šå‡ï¼Œæœ€å€¼æ˜¯ä¼˜åŒ–å™¨<code>optimizer</code>å¡«å…¥çš„<code>lr</code>å’Œè°ƒåº¦å™¨<code>scheduler</code>å¡«å…¥çš„<code>eta_min</code>ï¼Œ<code>T_max</code>æŒ‡çš„æ˜¯ä½™å¼¦çš„åŠä¸ªå‘¨æœŸï¼ˆæœ€å¤§å€¼é™åˆ°æœ€å°å€¼ï¼‰ã€‚</li>
<li>æ··åˆç²¾åº¦è®­ç»ƒï¼š<code>Â withÂ autocast(&#39;cuda&#39;,Â torch.float16):</code>å¯ä»¥ä½¿å¾—å‰å‘ä¼ æ’­æ—¶ä½¿ç”¨FP16ç²¾åº¦ï¼ŒåŠ å¿«é€Ÿåº¦ã€‚åå‘ä¼ æ’­æ¢¯åº¦æ›´æ–°æ—¶æ¢å¤åˆ°FP32ç²¾åº¦ä¿è¯å‡†ç¡®æ€§ã€‚</li>
<li>å¯è§†åŒ–ï¼šå®ç°äº†ç”¨tensorboardå¯¹è®­ç»ƒè¿‡ç¨‹çš„å˜é‡ï¼ˆæŸå¤±ã€å­¦ä¹ ç‡ç­‰ï¼‰è¿›è¡Œå¯è§†åŒ–ï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œåœ¨ç»ˆç«¯è¿è¡Œ<code>tensorboardÂ --logdir=æ—¥å¿—ç›¸å¯¹ä½ç½®</code>ï¼Œç„¶åæµè§ˆå™¨è¿›å…¥ç»™ä½ çš„IPåœ°å€å°±å¯ä»¥çœ‹åˆ°ä»¥ä¸‹ç•Œé¢ã€‚</li>
<li>æ¢¯åº¦ç´¯ç§¯ï¼šä¸ºäº†åœ¨å¤„ç†å¤§æ¨¡å‹æˆ–æœ‰é™çš„Â GPUÂ å†…å­˜æ—¶ï¼Œæ¨¡æ‹Ÿå¤§æ‰¹æ¬¡çš„è®­ç»ƒæ•ˆæœï¼Œå¤šæ¬¡åå‘ä¼ æ’­å¾—åˆ°çš„æ¢¯åº¦ç§¯ç´¯<code>accumulation_steps</code>æ­¥åå†è¿›è¡Œæ›´æ–°ã€‚</li>
</ul>
<h1 id="ğŸ”¥è¯„ä¼°"><a href="#ğŸ”¥è¯„ä¼°" class="headerlink" title="ğŸ”¥è¯„ä¼°"></a>ğŸ”¥è¯„ä¼°</h1><h2 id="ğŸš€è¯„ä»·æŒ‡æ ‡"><a href="#ğŸš€è¯„ä»·æŒ‡æ ‡" class="headerlink" title="ğŸš€è¯„ä»·æŒ‡æ ‡"></a>ğŸš€è¯„ä»·æŒ‡æ ‡</h2><p><strong>IoU</strong>ï¼Œå‰é¢æŸå¤±å‡½æ•°é‡Œé¢æåˆ°è¿‡ï¼Œåªä¸è¿‡ä¸éœ€è¦æ˜ å°„åˆ°tanhäº†ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    è®¡ç®—äº¤å¹¶æ¯”ï¼ˆIoUï¼‰
    :param inputs: é¢„æµ‹çš„åˆ†å‰²ç»“æœï¼Œå½¢çŠ¶ä¸º [H, W]
    :param targets: çœŸå®çš„åˆ†å‰²æ ‡ç­¾ï¼Œå½¢çŠ¶ä¸º [H, W]
    :param num_objects: mask ä¸ªæ•°ï¼ˆç±»åˆ«æ•°ï¼‰
    :return: IoU å€¼
    """</span>
    iou_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_objects <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># å‡è®¾èƒŒæ™¯æ˜¯ 0ï¼Œä» 1 å¼€å§‹è®¡ç®—å„ä¸ªå¯¹è±¡çš„ IoU</span>
        pred_mask <span class="token operator">=</span> <span class="token punctuation">(</span>inputs <span class="token operator">==</span> i<span class="token punctuation">)</span>
        true_mask <span class="token operator">=</span> <span class="token punctuation">(</span>targets <span class="token operator">==</span> i<span class="token punctuation">)</span>
        intersection <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_and<span class="token punctuation">(</span>pred_mask<span class="token punctuation">,</span> true_mask<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
        union <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_or<span class="token punctuation">(</span>pred_mask<span class="token punctuation">,</span> true_mask<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> union <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            iou_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># å¦‚æœ union ä¸º 0ï¼ŒIoU å®šä¹‰ä¸º 1ï¼ˆç‰¹æ®Šæƒ…å†µå¤„ç†ï¼‰</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            iou_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>intersection <span class="token operator">/</span> union<span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>iou_list<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>DICE</strong>ï¼Œå‰é¢ä¹Ÿç”¨è¿‡ï¼Œæ•ˆæœæ¥è¿‘IoUã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">dice</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    è®¡ç®— Dice ç³»æ•°
    :param inputs: é¢„æµ‹çš„åˆ†å‰²ç»“æœï¼Œå½¢çŠ¶ä¸º [H, W]
    :param targets: çœŸå®çš„åˆ†å‰²æ ‡ç­¾ï¼Œå½¢çŠ¶ä¸º [H, W]
    :param num_objects: mask ä¸ªæ•°ï¼ˆç±»åˆ«æ•°ï¼‰
    :return: Dice ç³»æ•°
    """</span>
    dice_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_objects <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># å‡è®¾èƒŒæ™¯æ˜¯ 0ï¼Œä» 1 å¼€å§‹è®¡ç®—å„ä¸ªå¯¹è±¡çš„ Dice</span>
        pred_mask <span class="token operator">=</span> <span class="token punctuation">(</span>inputs <span class="token operator">==</span> i<span class="token punctuation">)</span>
        true_mask <span class="token operator">=</span> <span class="token punctuation">(</span>targets <span class="token operator">==</span> i<span class="token punctuation">)</span>
        intersection <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_and<span class="token punctuation">(</span>pred_mask<span class="token punctuation">,</span> true_mask<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
        dice_value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">.</span> <span class="token operator">*</span> intersection<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pred_mask<span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> true_mask<span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        dice_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dice_value<span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>dice_list<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>åƒç´ å‡†ç¡®åº¦ï¼ˆPAï¼‰</strong>ï¼Œè®¡ç®—æ¯ä¸ªåƒç´ æ˜¯å¦é¢„æµ‹å‡†ç¡®ï¼Œæ˜¯æ¯”è¾ƒåŸºç¡€çš„ä¸€ä¸ªæŒ‡æ ‡ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">pixel_accuracy</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    è®¡ç®—åƒç´ å‡†ç¡®åº¦
    :param inputs: é¢„æµ‹çš„åˆ†å‰²ç»“æœï¼Œå½¢çŠ¶ä¸º [H, W]
    :param targets: çœŸå®çš„åˆ†å‰²æ ‡ç­¾ï¼Œå½¢çŠ¶ä¸º [H, W]
    :param num_objects: mask ä¸ªæ•°ï¼ˆç±»åˆ«æ•°ï¼‰ï¼ˆè™½ç„¶è¿™é‡Œç”¨ä¸åˆ°ï¼Œä½†ä¿æŒæ¥å£ä¸€è‡´ï¼‰
    :return: åƒç´ å‡†ç¡®åº¦
    """</span>
    correct <span class="token operator">=</span> <span class="token punctuation">(</span>inputs <span class="token operator">==</span> targets<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
    total <span class="token operator">=</span> inputs<span class="token punctuation">.</span>size
    <span class="token keyword">return</span> correct <span class="token operator">/</span> total
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>BoundaryÂ F1-score</strong>ï¼Œè¡¡é‡åˆ†å‰²åŒºåŸŸçš„è¾¹ç•Œçš„é¢„æµ‹è´¨é‡ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">boundary_f1_score</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    è®¡ç®—è¾¹ç•Œ F1 åˆ†æ•°
    :param inputs: é¢„æµ‹çš„åˆ†å‰²ç»“æœï¼Œå½¢çŠ¶ä¸º [H, W]
    :param targets: çœŸå®çš„åˆ†å‰²æ ‡ç­¾ï¼Œå½¢çŠ¶ä¸º [H, W]
    :param num_objects: mask ä¸ªæ•°ï¼ˆç±»åˆ«æ•°ï¼‰
    :return: è¾¹ç•Œ F1 åˆ†æ•°
    """</span>
    <span class="token comment" spellcheck="true"># åˆ›å»ºä¸€ä¸ªç»“æ„å…ƒç´ ç”¨äºè¾¹ç•Œæ£€æµ‹ï¼ˆè¿™é‡Œä½¿ç”¨ 3x3 çš„åå­—ç»“æ„ï¼‰</span>
    struct <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                       <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                       <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    f1_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_objects <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># å¯¹æ¯ä¸ªå¯¹è±¡è®¡ç®—è¾¹ç•Œ F1 åˆ†æ•°</span>
        <span class="token comment" spellcheck="true"># è·å–é¢„æµ‹å’ŒçœŸå®çš„ç›®æ ‡æ©ç </span>
        pred_mask <span class="token operator">=</span> <span class="token punctuation">(</span>inputs <span class="token operator">==</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        true_mask <span class="token operator">=</span> <span class="token punctuation">(</span>targets <span class="token operator">==</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

        <span class="token comment" spellcheck="true"># è®¡ç®—è¾¹ç•Œ</span>
        pred_boundary <span class="token operator">=</span> binary_dilation<span class="token punctuation">(</span>pred_mask<span class="token punctuation">,</span> struct<span class="token punctuation">)</span> <span class="token operator">^</span> binary_erosion<span class="token punctuation">(</span>pred_mask<span class="token punctuation">,</span> struct<span class="token punctuation">)</span>
        true_boundary <span class="token operator">=</span> binary_dilation<span class="token punctuation">(</span>true_mask<span class="token punctuation">,</span> struct<span class="token punctuation">)</span> <span class="token operator">^</span> binary_erosion<span class="token punctuation">(</span>true_mask<span class="token punctuation">,</span> struct<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># è®¡ç®— TPã€FPã€FN</span>
        tp <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_and<span class="token punctuation">(</span>pred_boundary<span class="token punctuation">,</span> true_boundary<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
        fp <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_and<span class="token punctuation">(</span>pred_boundary<span class="token punctuation">,</span> np<span class="token punctuation">.</span>logical_not<span class="token punctuation">(</span>true_boundary<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
        fn <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_and<span class="token punctuation">(</span>np<span class="token punctuation">.</span>logical_not<span class="token punctuation">(</span>pred_boundary<span class="token punctuation">)</span><span class="token punctuation">,</span> true_boundary<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># è®¡ç®—ç²¾ç¡®åº¦å’Œå¬å›ç‡</span>
        <span class="token keyword">if</span> tp <span class="token operator">+</span> fp <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            precision <span class="token operator">=</span> <span class="token number">0.0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            precision <span class="token operator">=</span> tp <span class="token operator">/</span> <span class="token punctuation">(</span>tp <span class="token operator">+</span> fp<span class="token punctuation">)</span>

        <span class="token keyword">if</span> tp <span class="token operator">+</span> fn <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            recall <span class="token operator">=</span> <span class="token number">0.0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            recall <span class="token operator">=</span> tp <span class="token operator">/</span> <span class="token punctuation">(</span>tp <span class="token operator">+</span> fn<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># è®¡ç®— F1 åˆ†æ•°</span>
        <span class="token keyword">if</span> precision <span class="token operator">+</span> recall <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            f1 <span class="token operator">=</span> <span class="token number">0.0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            f1 <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>precision <span class="token operator">*</span> recall<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>precision <span class="token operator">+</span> recall<span class="token punctuation">)</span>

        f1_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>f1<span class="token punctuation">)</span>

    <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>f1_list<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ğŸš€è¯„ä¼°è„šæœ¬"><a href="#ğŸš€è¯„ä¼°è„šæœ¬" class="headerlink" title="ğŸš€è¯„ä¼°è„šæœ¬"></a>ğŸš€è¯„ä¼°è„šæœ¬</h2><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms
<span class="token keyword">import</span> sys

<span class="token keyword">from</span> sam2<span class="token punctuation">.</span>build_sam <span class="token keyword">import</span> build_sam2
<span class="token keyword">from</span> sam2<span class="token punctuation">.</span>sam2_image_predictor <span class="token keyword">import</span> SAM2ImagePredictor
<span class="token keyword">from</span> training<span class="token punctuation">.</span>metric <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> training<span class="token punctuation">.</span>dataset <span class="token keyword">import</span> LabPicsDataset

os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span><span class="token punctuation">)</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span>
batch_size <span class="token operator">=</span> <span class="token number">16</span>
model_scale_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"b+"</span><span class="token punctuation">:</span> <span class="token string">"base_plus"</span><span class="token punctuation">,</span> <span class="token string">"l"</span><span class="token punctuation">:</span> <span class="token string">"large"</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">:</span> <span class="token string">"small"</span><span class="token punctuation">}</span>
model_scale <span class="token operator">=</span> <span class="token string">"s"</span>

<span class="token comment" spellcheck="true"># æ•°æ®é›†å’Œæ•°æ®åŠ è½½å™¨</span>
dataset <span class="token operator">=</span> LabPicsDataset<span class="token punctuation">(</span><span class="token string">"../assets/LabPicsV1/Simple/Test"</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
dataloader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># åŠ è½½æ¨¡å‹</span>
sam2_checkpoint <span class="token operator">=</span> f<span class="token string">"../checkpoints/sam2_hiera_{model_scale_dict[model_scale]}.pt"</span>
model_cfg <span class="token operator">=</span> f<span class="token string">"../sam2_configs/sam2_hiera_{model_scale}.yaml"</span>
sam2_model <span class="token operator">=</span> build_sam2<span class="token punctuation">(</span>model_cfg<span class="token punctuation">,</span> sam2_checkpoint<span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">"cuda"</span><span class="token punctuation">)</span>
predictor <span class="token operator">=</span> SAM2ImagePredictor<span class="token punctuation">(</span>sam2_model<span class="token punctuation">)</span>
predictor<span class="token punctuation">.</span>model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token string">"./output/exp{4}/model_epoch_{120}.pt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

use_prompt <span class="token operator">=</span> <span class="token boolean">False</span>

iou_scores <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
dice_scores <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
pixel_acc_scores <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
boundary_f1_scores <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> batch_idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>image<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> input_point<span class="token punctuation">,</span> input_label<span class="token punctuation">)</span> <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span><span class="token punctuation">:</span>    
    gt_mask <span class="token operator">=</span> mask<span class="token punctuation">.</span>float<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    gt_mask <span class="token operator">=</span> <span class="token punctuation">[</span>gt_mask<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>gt_mask<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    predictor<span class="token punctuation">.</span>set_image_batch<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    masks<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> logits <span class="token operator">=</span> predictor<span class="token punctuation">.</span>predict_batch<span class="token punctuation">(</span>
        multimask_output<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    num_objects <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token keyword">for</span> output<span class="token punctuation">,</span> target <span class="token keyword">in</span> zip<span class="token punctuation">(</span>masks<span class="token punctuation">,</span> gt_mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
        iou_scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span>iou<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">,</span> num_objects<span class="token punctuation">)</span><span class="token punctuation">)</span>
        dice_scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dice<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">,</span> num_objects<span class="token punctuation">)</span><span class="token punctuation">)</span>
        pixel_acc_scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pixel_accuracy<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">,</span> num_objects<span class="token punctuation">)</span><span class="token punctuation">)</span>
        boundary_f1_scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span>boundary_f1_score<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">,</span> num_objects<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Average IoU:"</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>iou_scores<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Average Dice:"</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>dice_scores<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Average Pixel Accuracy:"</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>pixel_acc_scores<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Average Boundary F1 Score:"</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>boundary_f1_scores<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æµç¨‹å¾ˆç®€å•ï¼Œå°±æ˜¯æ‰¹é‡é¢„æµ‹åè®¡ç®—æŒ‡æ ‡å¾—åˆ†ã€‚</p>
<h1 id="ğŸ”¥å®éªŒ"><a href="#ğŸ”¥å®éªŒ" class="headerlink" title="ğŸ”¥å®éªŒ"></a>ğŸ”¥å®éªŒ</h1><h2 id="ğŸš€è·‘é€šè®­ç»ƒ"><a href="#ğŸš€è·‘é€šè®­ç»ƒ" class="headerlink" title="ğŸš€è·‘é€šè®­ç»ƒ"></a>ğŸš€è·‘é€šè®­ç»ƒ</h2><p>å…ˆ<strong>è·‘äº†40ä»£</strong>è¯•äº†ä¸€ä¸‹ï¼Œæ˜¯å¯ä»¥æ”¶æ•›çš„ï¼Œå„ä¸ªæŸå¤±éƒ½æ˜¯åˆç†çš„æ”¶æ•›æ›²çº¿ã€‚</p>
<p><img src="/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/40%E4%BB%A3large%E8%AE%AD%E7%BB%83%E6%9B%B2%E7%BA%BF.png" alt="40ä»£largeè®­ç»ƒæ›²çº¿"></p>
<p><img src="/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/%E5%BE%AE%E8%B0%83%E5%89%8D%E5%90%8E%E5%AF%B9%E6%AF%94.png" alt="å¾®è°ƒå‰åå¯¹æ¯”"></p>
<p>å·¦è¾¹çš„å›¾æ˜¯è®­ç»ƒå‰ï¼Œå³å›¾æ˜¯è®­ç»ƒçš„åçš„é¢„æµ‹æ•ˆæœï¼ˆéƒ½æ˜¯æ— promptï¼‰ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ä¸ç»™æç¤ºçš„æƒ…å†µä¸‹ï¼ŒåŸSAM2åˆ†å‰²æ•ˆæœä¸å¥½ï¼Œè®­ç»ƒåæœ‰å¾ˆå¥½çš„æ”¹å–„ã€‚è¿™åªæ˜¯è®­ç»ƒè¿‡ç¨‹çš„åˆæ­¥å®Œå–„ï¼Œåç»­è¿˜è¦åšæ›´å¤šçš„æ”¹è¿›ã€‚æ¨ç†æ—¶é—´ä¸ºã€‚æœ€å¤§çš„largeæ¨¡å‹æ¨ç†æ—¶é—´ä¸º0.1sé‡çº§ã€‚</p>
<p><strong>è·‘500ä»£</strong>è§‚å¯Ÿæ›²çº¿ï¼Œå¯ä»¥çœ‹åˆ°åœ¨120ä»£å·¦å³éªŒè¯æŸå¤±è¾¾åˆ°æœ€ä½ï¼Œæ­¤åè®­ç»ƒæŸå¤±è¿˜æ˜¯ä¼šä¸‹é™ï¼Œè¯´æ˜åé¢å·²ç»å‘ç”Ÿè¿‡æ‹Ÿåˆäº†ã€‚åˆé€‚çš„è®­ç»ƒè¿­ä»£æ•°å°±æ˜¯150ä»¥å†…ã€‚</p>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>å‚æ•°å€¼</th>
<th>å‚æ•°</th>
<th>å‚æ•°å€¼</th>
</tr>
</thead>
<tbody><tr>
<td>epoch</td>
<td>500</td>
<td>model_scale</td>
<td>largeï¼ˆ224Mï¼‰</td>
</tr>
<tr>
<td>froze_image_encoder</td>
<td>True</td>
<td>froze_prompt_encoder</td>
<td>True</td>
</tr>
<tr>
<td>batchÂ size</td>
<td>32</td>
<td>lr_max</td>
<td>1e-5</td>
</tr>
<tr>
<td>weightÂ decay</td>
<td>4e-5</td>
<td>lr_min</td>
<td>1e-8</td>
</tr>
<tr>
<td>dice_weight</td>
<td>0.4</td>
<td>T_max</td>
<td>50</td>
</tr>
<tr>
<td>focal_weight</td>
<td>12.0</td>
<td>diou_weight</td>
<td>5.0</td>
</tr>
<tr>
<td>iou_weight</td>
<td>2.0</td>
<td>use_prompt</td>
<td>False</td>
</tr>
<tr>
<td>è®­ç»ƒç²¾åº¦</td>
<td>FP16</td>
<td>accumulation_steps</td>
<td>1</td>
</tr>
</tbody></table>
<p><img src="/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/500%E4%BB%A3large%E8%AE%AD%E7%BB%83%E6%9B%B2%E7%BA%BF.png" alt="500ä»£largeè®­ç»ƒæ›²çº¿"></p>
<h2 id="ğŸš€å†»ç»“å¯¹ç…§"><a href="#ğŸš€å†»ç»“å¯¹ç…§" class="headerlink" title="ğŸš€å†»ç»“å¯¹ç…§"></a>ğŸš€å†»ç»“å¯¹ç…§</h2><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>å‚æ•°å€¼</th>
<th>å‚æ•°</th>
<th>å‚æ•°å€¼</th>
</tr>
</thead>
<tbody><tr>
<td>epoch</td>
<td>300</td>
<td>model_scale</td>
<td>base_plusï¼ˆ80.8Mï¼‰</td>
</tr>
<tr>
<td>froze_image_encoder</td>
<td>True&#x2F;False</td>
<td>froze_prompt_encoder</td>
<td>True</td>
</tr>
<tr>
<td>batchÂ size</td>
<td>32</td>
<td>lr_max</td>
<td>1e-5</td>
</tr>
<tr>
<td>weightÂ decay</td>
<td>4e-5</td>
<td>lr_min</td>
<td>1e-8</td>
</tr>
<tr>
<td>dice_weight</td>
<td>0.4</td>
<td>T_max</td>
<td>50</td>
</tr>
<tr>
<td>focal_weight</td>
<td>12.0</td>
<td>diou_weight</td>
<td>5.0</td>
</tr>
<tr>
<td>iou_weight</td>
<td>2.0</td>
<td>use_prompt</td>
<td>False</td>
</tr>
<tr>
<td>è®­ç»ƒç²¾åº¦</td>
<td>FP16</td>
<td>accumulation_steps</td>
<td>1</td>
</tr>
</tbody></table>
<p><img src="/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/%E5%86%BB%E7%BB%93%E5%AF%B9%E7%85%A7.png" alt="å†»ç»“å¯¹ç…§"></p>
<p>exp3å’Œexp5åˆ†åˆ«è¡¨ç¤ºb+æ¨¡å‹å†»ç»“&#x2F;æœªå†»ç»“<strong>å›¾åƒç¼–ç å™¨</strong>çš„æƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°å†»ç»“å›¾åƒç¼–ç å™¨èƒ½å¾—åˆ°æ›´å¥½çš„æ•ˆæœï¼Œè¯´æ˜ç¼–ç å™¨ç»è¿‡åäº¿çº§åˆ«çš„æ•°æ®é›†é¢„è®­ç»ƒå·²ç»èƒ½å¾ˆå¥½åœ°å¯¹å›¾åƒæŠ½å–ç‰¹å¾äº†ï¼Œä¸éœ€è¦åœ¨ä¸‹æ¸¸æ•°æ®é›†è¿›è¡Œå‚æ•°æ›´æ–°ï¼Œé‚£æ ·åè€Œä¼šä¸¢å¤±ä¹‹å‰çš„èƒ½åŠ›ã€‚</p>
<h2 id="ğŸš€promptå¯¹ç…§"><a href="#ğŸš€promptå¯¹ç…§" class="headerlink" title="ğŸš€promptå¯¹ç…§"></a>ğŸš€promptå¯¹ç…§</h2><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>å‚æ•°å€¼</th>
<th>å‚æ•°</th>
<th>å‚æ•°å€¼</th>
</tr>
</thead>
<tbody><tr>
<td>epoch</td>
<td>300</td>
<td>model_scale</td>
<td>base_plusï¼ˆ80.8Mï¼‰</td>
</tr>
<tr>
<td>froze_image_encoder</td>
<td>True</td>
<td>froze_prompt_encoder</td>
<td>True</td>
</tr>
<tr>
<td>batchÂ size</td>
<td>32</td>
<td>lr_max</td>
<td>1e-5</td>
</tr>
<tr>
<td>weightÂ decay</td>
<td>4e-5</td>
<td>lr_min</td>
<td>1e-8</td>
</tr>
<tr>
<td>dice_weight</td>
<td>0.4</td>
<td>T_max</td>
<td>50</td>
</tr>
<tr>
<td>focal_weight</td>
<td>12.0</td>
<td>diou_weight</td>
<td>5.0</td>
</tr>
<tr>
<td>iou_weight</td>
<td>2.0</td>
<td>use_prompt</td>
<td>False&#x2F;True</td>
</tr>
<tr>
<td>è®­ç»ƒç²¾åº¦</td>
<td>FP16</td>
<td>accumulation_steps</td>
<td>1</td>
</tr>
</tbody></table>
<p><img src="/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/prompt%E5%AF%B9%E7%85%A7.png" alt="promptå¯¹ç…§"></p>
<p>exp3æœªä½¿ç”¨promptï¼Œexp6è¡¨ç¤ºä½¿ç”¨promptï¼Œå³å¯¹maskæ ‡æ³¨å†…éšæœºé€‰ç‚¹ä½œä¸ºæç¤ºè¾“å…¥æ¨¡å‹ï¼ŒåŒæ—¶éªŒè¯æ—¶ä¹Ÿä½¿ç”¨promptï¼Œæ¨¡å‹çš„æŸå¤±æ˜æ˜¾é™ä½ï¼Œè¯´æ˜promptçš„ä½¿ç”¨ä¼šæ˜æ˜¾æœ‰æ•ˆæå‡æ¨¡å‹åœ¨è¯¥ä»»åŠ¡å’Œæ•°æ®é›†çš„åˆ†å‰²èƒ½åŠ›ã€‚</p>
<p><img src="/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/prompt%E5%AF%B9%E7%85%A72.png" alt="promptå¯¹ç…§2"></p>
<p>exp7åˆ™æ˜¯åœ¨éªŒè¯æ—¶ä¸ä½¿ç”¨promptè¾“å…¥ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœç”¨æç¤ºè®­ç»ƒçš„SAM2åœ¨ä½¿ç”¨æ—¶ä¸ä½¿ç”¨æç¤ºï¼Œå…¶æ•ˆæœä¼šå¾ˆå·®ï¼Œæ‰€ä»¥æ˜¯å¦ä½¿ç”¨æç¤ºè®­ç»ƒå–å†³äºä½¿ç”¨åœºæ™¯çš„éœ€æ±‚ã€‚</p>
<h2 id="ğŸš€è®­ç»ƒç²¾åº¦å¯¹ç…§"><a href="#ğŸš€è®­ç»ƒç²¾åº¦å¯¹ç…§" class="headerlink" title="ğŸš€è®­ç»ƒç²¾åº¦å¯¹ç…§"></a>ğŸš€è®­ç»ƒç²¾åº¦å¯¹ç…§</h2><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>å‚æ•°å€¼</th>
<th>å‚æ•°</th>
<th>å‚æ•°å€¼</th>
</tr>
</thead>
<tbody><tr>
<td>epoch</td>
<td>500</td>
<td>model_scale</td>
<td>base_plusï¼ˆ80.8Mï¼‰</td>
</tr>
<tr>
<td>froze_image_encoder</td>
<td>True</td>
<td>froze_prompt_encoder</td>
<td>True</td>
</tr>
<tr>
<td>batchÂ size</td>
<td>32&#x2F;32&#x2F;16</td>
<td>lr_max</td>
<td>1e-5</td>
</tr>
<tr>
<td>weightÂ decay</td>
<td>4e-5</td>
<td>lr_min</td>
<td>1e-8</td>
</tr>
<tr>
<td>dice_weight</td>
<td>0.4</td>
<td>T_max</td>
<td>50</td>
</tr>
<tr>
<td>focal_weight</td>
<td>12.0</td>
<td>diou_weight</td>
<td>5.0</td>
</tr>
<tr>
<td>iou_weight</td>
<td>2.0</td>
<td>use_prompt</td>
<td>False</td>
</tr>
<tr>
<td>è®­ç»ƒç²¾åº¦</td>
<td>FP16&#x2F;BF16&#x2F;FP32</td>
<td>accumulation_steps</td>
<td>1</td>
</tr>
</tbody></table>
<p>åœ¨è¿›è¡Œå‰å‘ä¼ æ’­æ—¶æ¨¡å‹ä½¿ç”¨åŠç²¾åº¦è¿›è¡Œè®¡ç®—ä¼šé™ä½æ˜¾å­˜å‹åŠ›ã€æå‡è¿ç®—é€Ÿåº¦ï¼ŒåŒæ—¶ä¹Ÿä¸ä¼šå¾ˆæ˜¾è‘—åœ°é™ä½æ¨¡å‹èƒ½åŠ›ã€‚</p>
<p><img src="/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/%E8%AE%AD%E7%BB%83%E7%B2%BE%E5%BA%A6%E5%AF%B9%E7%85%A7.png" alt="è®­ç»ƒç²¾åº¦å¯¹ç…§"></p>
<p>exp8ã€exp9å’Œexp10è¡¨ç¤ºfloat16ã€bfloat16å’Œfloat32ç²¾åº¦ä¸‹è¿›è¡Œè®­ç»ƒçš„æ•ˆæœï¼Œç”±äºfloat32å¢åŠ äº†æ˜¾å­˜å‹åŠ›ï¼Œåªèƒ½ç”¨æ›´å°çš„batchÂ sizeï¼Œå¯ä»¥çœ‹åˆ°float32ç”šè‡³ä¸ä¼šæœ‰æ›´å¥½çš„æ•ˆæœã€‚</p>
<h2 id="ğŸš€æ¢¯åº¦ç´¯ç§¯å¯¹ç…§"><a href="#ğŸš€æ¢¯åº¦ç´¯ç§¯å¯¹ç…§" class="headerlink" title="ğŸš€æ¢¯åº¦ç´¯ç§¯å¯¹ç…§"></a>ğŸš€æ¢¯åº¦ç´¯ç§¯å¯¹ç…§</h2><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>å‚æ•°å€¼</th>
<th>å‚æ•°</th>
<th>å‚æ•°å€¼</th>
</tr>
</thead>
<tbody><tr>
<td>epoch</td>
<td>500</td>
<td>model_scale</td>
<td>base_plusï¼ˆ80.8Mï¼‰</td>
</tr>
<tr>
<td>froze_image_encoder</td>
<td>True</td>
<td>froze_prompt_encoder</td>
<td>True</td>
</tr>
<tr>
<td>batchÂ size</td>
<td>32</td>
<td>lr_max</td>
<td>1e-5</td>
</tr>
<tr>
<td>weightÂ decay</td>
<td>4e-5</td>
<td>lr_min</td>
<td>1e-8</td>
</tr>
<tr>
<td>dice_weight</td>
<td>0.4</td>
<td>T_max</td>
<td>50</td>
</tr>
<tr>
<td>focal_weight</td>
<td>12.0</td>
<td>diou_weight</td>
<td>5.0</td>
</tr>
<tr>
<td>iou_weight</td>
<td>2.0</td>
<td>use_prompt</td>
<td>False</td>
</tr>
<tr>
<td>è®­ç»ƒç²¾åº¦</td>
<td>BF16</td>
<td>accumulation_steps</td>
<td>1&#x2F;4</td>
</tr>
</tbody></table>
<p>exp8ä¸ä½¿ç”¨æ¢¯åº¦ç´¯ç§¯ï¼Œexp11è®¾ç½®4æ­¥çš„æ¢¯åº¦ç´¯ç§¯æ¨¡æ‹Ÿ32*4çš„è™šæ‹ŸbatchÂ sizeï¼Œåœ¨ä¿æŒæ•ˆæœå·®åˆ«ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œè¿‡æ‹Ÿåˆç¨‹åº¦æ˜¾è‘—é™ä½ï¼Œå¯èƒ½ä½¿ç”¨æ›´å¤§çš„å­¦ä¹ ç‡ä¼šæœ‰æ›´å¥½çš„æ•ˆæœã€‚</p>
<p><img src="/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/%E6%A2%AF%E5%BA%A6%E7%B4%AF%E7%A7%AF%E5%AF%B9%E7%85%A7.png" alt="æ¢¯åº¦ç´¯ç§¯å¯¹ç…§"></p>
<h2 id="ğŸš€è¯„ä¼°"><a href="#ğŸš€è¯„ä¼°" class="headerlink" title="ğŸš€è¯„ä¼°"></a>ğŸš€è¯„ä¼°</h2><p>ä½¿ç”¨ä¸‰ä¸ªä¸åŒè§„æ¨¡çš„æ¨¡å‹è¿›è¡Œå¦‚ä¸‹è®­ç»ƒï¼Œå–éªŒè¯æŸå¤±æœ€ä½çš„æ¨¡å‹è¿›è¡Œè¯„ä¼°æµ‹è¯•ï¼ˆå¹¶ä¸ä¸€å®šæ˜¯æœ€ä¼˜æ¨¡å‹ï¼Œä½†æ˜¯æ˜¯è¯¥è®­ç»ƒæ¡ä»¶ä¸‹æš‚æ—¶æœ€ä¼˜ï¼‰ã€‚</p>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>å‚æ•°å€¼</th>
<th>å‚æ•°</th>
<th>å‚æ•°å€¼</th>
</tr>
</thead>
<tbody><tr>
<td>epoch</td>
<td>500</td>
<td>model_scale</td>
<td>s&#x2F;b+&#x2F;l</td>
</tr>
<tr>
<td>froze_image_encoder</td>
<td>True</td>
<td>froze_prompt_encoder</td>
<td>True</td>
</tr>
<tr>
<td>batchÂ size</td>
<td>32</td>
<td>lr_max</td>
<td>1e-5</td>
</tr>
<tr>
<td>weightÂ decay</td>
<td>4e-5</td>
<td>lr_min</td>
<td>1e-8</td>
</tr>
<tr>
<td>dice_weight</td>
<td>0.4</td>
<td>T_max</td>
<td>50</td>
</tr>
<tr>
<td>focal_weight</td>
<td>12.0</td>
<td>diou_weight</td>
<td>5.0</td>
</tr>
<tr>
<td>iou_weight</td>
<td>2.0</td>
<td>use_prompt</td>
<td>False</td>
</tr>
<tr>
<td>è®­ç»ƒç²¾åº¦</td>
<td>FP16</td>
<td>accumulation_steps</td>
<td>1</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>è§„æ¨¡</th>
<th>IoU</th>
<th>Dice</th>
<th>PixelÂ Accuracy</th>
<th>BoundaryÂ F1Â Score</th>
</tr>
</thead>
<tbody><tr>
<td>s</td>
<td>0.867</td>
<td>0.918</td>
<td>0.984</td>
<td>0.276</td>
</tr>
<tr>
<td>b+</td>
<td>0.875</td>
<td>0.922</td>
<td>0.984</td>
<td>0.283</td>
</tr>
<tr>
<td>l</td>
<td>0.876</td>
<td>0.925</td>
<td>0.985</td>
<td>0.288</td>
</tr>
</tbody></table>
<p>å¯ä»¥çœ‹åˆ°æ¨¡å‹è§„æ¨¡è¶Šå¤§æµ‹è¯•çš„æ•ˆæœè¶Šå¥½ï¼ŒPAæŒ‡æ ‡çš„åŒºåˆ†åº¦ä¸æ˜¯å¾ˆå¤§ã€‚</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        åˆ†äº«
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://legendleochen.top/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LISA/" rel="tag">LISA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LLM/" rel="tag">LLM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LORA/" rel="tag">LORA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PEFT/" rel="tag">PEFT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SAM2/" rel="tag">SAM2</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/VLLM/" rel="tag">VLLM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/" rel="tag">å›¾åƒåˆ†å‰²</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2025/05/21/LISA%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8A%E6%89%8B%E5%92%8C%E5%BE%AE%E8%B0%83/" class="article-nav-link">
        <strong class="article-nav-caption">ä¸Šä¸€ç¯‡</strong>
        <div class="article-nav-title">
          
            LISAå›¾åƒåˆ†å‰²æ¨¡å‹çš„ä¸Šæ‰‹å’Œå¾®è°ƒ
          
        </div>
      </a>
    
    
      <a href="/2025/03/25/%E8%A7%86%E8%A7%89%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/" class="article-nav-link">
        <strong class="article-nav-caption">ä¸‹ä¸€ç¯‡</strong>
        <div class="article-nav-title">è§†è§‰ç”Ÿæˆæ¨¡å‹åŸç†åŠå®ç°</div>
      </a>
    
  </nav>

  
   
  
    
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2023-2025
        <i class="ri-heart-fill heart_icon"></i> LegendLeo Chen
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>è®¿é—®äººæ•°:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>æµè§ˆæ¬¡æ•°:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzzç»Ÿè®¡ -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/mylogo.png" alt="LegendLeo Chen çš„ç©ºé—´"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">ğŸš€ä¸»é¡µ</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">ğŸ’¾å½’æ¡£</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">ğŸ§­åˆ†ç±»</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">ğŸ·ï¸æ ‡ç­¾</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">ğŸ›¸å…³äº</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/analytics">ğŸ“Šç»Ÿè®¡</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="æœç´¢">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>è¯·æˆ‘å–æ¯å’–å•¡å§~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">æ”¯ä»˜å®</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">å¾®ä¿¡</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // sliderå±•å¼€çŠ¶æ€
                // todo: è¿™æ ·ä¸å¥½ï¼Œåé¢æ”¹æˆçŠ¶æ€
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // è·å¾—åŸå›¾å°ºå¯¸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // ç­‰å¾…ä¸¤ç§’é’Ÿåæ¢å¤
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // ç­‰å¾…ä¸¤ç§’é’Ÿåæ¢å¤
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=1491212&auto=1&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    

  </div>
  <!-- èƒŒæ™¯æ°”æ³¡ -->
  <!--
  <div class="balls-container">
    <div class="balls-particles">
      <span style="--i:11;"></span>
      <span style="--i:12;"></span>
      <span style="--i:24;"></span>
      <span style="--i:10;"></span>
      <span style="--i:14;"></span>
      <span style="--i:23;"></span>
      <span style="--i:18;"></span>
      <span style="--i:16;"></span>
      <span style="--i:19;"></span>
      <span style="--i:20;"></span>
      <span style="--i:22;"></span>
      <span style="--i:25;"></span>
      <span style="--i:18;"></span>
      <span style="--i:21;"></span>
      <span style="--i:13;"></span>
      <span style="--i:15;"></span>
      <span style="--i:26;"></span>
      <span style="--i:17;"></span>
      <span style="--i:13;"></span>
      <span style="--i:26;"></span>
      <span style="--i:28;"></span>
      <span style="--i:11;"></span>
      <span style="--i:12;"></span>
      <span style="--i:24;"></span>
      <span style="--i:10;"></span>
      <span style="--i:14;"></span>
      <span style="--i:23;"></span>
      <span style="--i:18;"></span>
      <span style="--i:16;"></span>
      <span style="--i:19;"></span>
      <span style="--i:20;"></span>
      <span style="--i:22;"></span>
      <span style="--i:25;"></span>
      <span style="--i:18;"></span>
      <span style="--i:21;"></span>
      <span style="--i:13;"></span>
      <span style="--i:15;"></span>
      <span style="--i:26;"></span>
      <span style="--i:17;"></span>
      <span style="--i:13;"></span>
      <span style="--i:26;"></span>
      <span style="--i:28;"></span>
    </div>
  </div>
  <style>
    *
    {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    .balls-container
    { 
      position: fixed;
      top: 0px;
      left: 0px;
      width: 100%;
      height: 100vh;
      overflow: hidden;
      opacity: 0.3;
    }
    
    .balls-particles
    {
      position: fixed;
      display: flex;
      z-index: 3;
      padding: 0 20px;
    }
    
    .balls-particles span
    {
      position: relative;
      bottom: 30px;
      width: 30px;
      height: 30px;
      background-color: #4fc3dc;
      box-shadow: 0 0 0 10px #4fc3dc44,
      0 0 50px #4fc3dc,
      -100px 0 #4fc3dc99,
      100px 0 #ff2d7599;
      margin: 0 4px;
      border-radius: 50%;
      animation: animate 15s ease infinite;
      animation-delay: calc(125s / var(--i));
      transform: translateY(120vh);
    }
    .balls-particles span:nth-child(even) {
      background-color: #ff2d75;
      box-shadow: 0 0 0 10px #ff267544,
      0 0 50px #ff2d75,
      -100px 0 #4fc3dc99,
      100px 0 #4fc3dc99;
      ;
    }
    
    @keyframes animate {
      0%
      {
        transform: translateY(120vh) scale(0) rotate(0deg);
      }
      20%
      {
        transform: translateY(100vh) scale(1) rotate(0deg);
      }
      100%
      {
        transform: translateY(-50vh) scale(0.5) rotate(360deg);
      }
    }
  </style> -->
  <!-- åœ°æœˆç³»ç»Ÿ -->
  <!-- <div class="earth-container" >
    <div class="planet"></div>
    <div class="satellite"></div>
   </div>
   <style>
    *{
      padding: 0;
      margin: 0;
      }
      .earth-container {
        width: 36.25em;
        height: 36.25em;
        position: absolute;
        top:5%;
        left: 93%;
        transform: translate(-50%, -50%);
        opacity: 0.3;
      }
      
      .planet{
        width: 15.62*3em;
        height: 15.62*3em;
        background-color: #02c0f5;
        border-radius: 50%;
        position: absolute;
        margin: auto;
        top:0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1;
      }
      
      .planet::before{
        content: '';
        width: 4em;
        height: 4em;
        background-color: #008fd6;
        position: absolute;
        top:10em;
        left: 8em;
        border-radius: 50%; 
        box-shadow: 15em 15em 0 2em #00d68b, 5em 8em 0 3em #10ade1;
      }
      
      .satellite{
        width: 5em;
        height: 5em;
        background-color: #dee517;
        border-radius: 50%;
        position: relative;
        left: -5em;
        bottom: -30em;
        animation: spin 5s infinite;
        z-index: 1;
      }
      
      @keyframes spin {
        49%{
          z-index: 1;
        }
        50%{
          bottom: 3em;
          left: 35em;
          z-index: -1;
        }
        100%{
          z-index: -1;
        }
      }
    </style> -->
<!-- ä¸‰è§’å½©å¸¦èƒŒæ™¯ -->
  <canvas id="evanyou-canvas" style="opacity: 0.3; position: fixed; top: 0px; left: 0px; z-index: -1; width: 100%; height: 100%; pointer-events: none;"></canvas>
  <script src="https://cdn.jsdelivr.net/gh/XXXZhy/Blog_Image/js/evanyou_canvas.js"></script>
</body>

</html>