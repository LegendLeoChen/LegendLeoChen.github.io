<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="ä¸€ä¸ªç§˜å¯†ç©ºé—´" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>LISAå›¾åƒåˆ†å‰²æ¨¡å‹çš„ä¸Šæ‰‹å’Œå¾®è°ƒ |  LegendLeo Chen çš„ç©ºé—´</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/mylogo.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
<!-- å°é¢æ ‡é—ªçƒ -->
<link rel="stylesheet" href="/css/zhyBlogTitle.css">
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<!-- jqueryï¼Œæ‡’åŠ è½½ã€ç»Ÿè®¡ã€è¯´è¯´éœ€è¦çš„jquery -->
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-LISAå›¾åƒåˆ†å‰²æ¨¡å‹çš„ä¸Šæ‰‹å’Œå¾®è°ƒ"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  LISAå›¾åƒåˆ†å‰²æ¨¡å‹çš„ä¸Šæ‰‹å’Œå¾®è°ƒ
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2025/05/21/LISA%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8A%E6%89%8B%E5%92%8C%E5%BE%AE%E8%B0%83/" class="article-date">
  <time datetime="2025-05-21T10:46:28.000Z" itemprop="datePublished">2025-05-21</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">æ·±åº¦å­¦ä¹ </a> / <a class="article-category-link" href="/categories/%E7%BC%96%E7%A8%8B/">ç¼–ç¨‹</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> å­—æ•°ç»Ÿè®¡:</span>
            <span class="post-count">5.4k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> é˜…è¯»æ—¶é•¿â‰ˆ</span>
            <span class="post-count">25 åˆ†é’Ÿ</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p>æœ¬æ–‡è®°å½•LISAç³»åˆ—çš„ç›¸å…³å†…å®¹ï¼Œä»»åŠ¡ä¸ºå›¾åƒåˆ†å‰²ã€‚LISAã€LISA++ä»“åº“å¦‚ä¸‹ï¼ˆä¸¤ä¸ªåˆ†æ”¯ï¼‰ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://github.com/dvlab-research/LISA">LISA</a></p>
<p>LISAçš„è¿™ä¸ªä»“åº“ç»™äº†å¾ˆå®Œæ•´çš„ä¸Šæ‰‹ä»‹ç»ï¼Œä»¥åŠä¸ç®—å¤ªå¤æ‚çš„è®­ç»ƒã€é¢„æµ‹è„šæœ¬ï¼ŒåŸºæœ¬å¯ä»¥åœ¨å…¶åŸºç¡€ä¸Šåšé€‚é…ï¼Œè€Œä¸ç”¨ä»å¤´æã€‚</p>
<span id="more"></span>
<p><img src="/2025/05/21/LISA%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8A%E6%89%8B%E5%92%8C%E5%BE%AE%E8%B0%83/LISA%E6%9E%B6%E6%9E%84.png" alt="LISAæ¶æ„"></p>
<p>LISAç”¨çš„æ˜¯å¤šæ¨¡æ€æ¨¡å‹è¿›è¡Œåˆ†å‰²ï¼ŒLISAæ¶æ„å¦‚ä¸Šï¼Œå›¾æ–‡éƒ½è¾“å…¥åˆ°å¤šæ¨¡æ€å¤§æ¨¡å‹ä¸­ï¼Œä»¥LoRAçš„æ–¹å¼è®­ç»ƒï¼Œè¾“å‡ºåµŒå…¥è¡¨è¾¾<SEG>ï¼›åŸå›¾ç»è¿‡ä¸€ä¸ªè§†è§‰ç½‘ç»œåå’ŒLLMè¾“å‡ºä¸€èµ·è¾“å…¥åˆ°è§£ç å™¨ï¼Œå¾—åˆ°æœ€åçš„maskã€‚</SEG></p>
<p>å¤šæ¨¡æ€LLMç”¨çš„LLaVAï¼Œè§†è§‰ç½‘ç»œæ˜¯ç”¨çš„SAMçš„ç¼–ç å™¨ï¼ˆæœ¬è´¨æ˜¯ViTï¼‰ã€‚</p>
<p><img src="/2025/05/21/LISA%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8A%E6%89%8B%E5%92%8C%E5%BE%AE%E8%B0%83/LISAplus%E6%9E%B6%E6%9E%84.png" alt="LISA++æ¶æ„"></p>
<p>LISA++åˆ™æ˜¯å¢åŠ äº†å®ä¾‹åˆ†å‰²èƒ½åŠ›ï¼ŒLISAåªèƒ½ä¸€æ¬¡è¾“å‡ºå•ä¸ªæ©ç ï¼Œè¿™ä¸ªæ©ç ä¼šåŒ…å«æ‰€æœ‰éœ€è¦çš„å¯¹è±¡ï¼Œè€ŒLISA++ä¼šä¸ºæ¯ä¸ªç¬¦åˆè¦æ±‚çš„ç›®æ ‡ç”Ÿæˆä¸€ä¸ªæ©ç ã€‚</p>
<h1 id="ğŸ”¥å‡†å¤‡å·¥ä½œ"><a href="#ğŸ”¥å‡†å¤‡å·¥ä½œ" class="headerlink" title="ğŸ”¥å‡†å¤‡å·¥ä½œ"></a>ğŸ”¥å‡†å¤‡å·¥ä½œ</h1><h2 id="ğŸš€é…ç½®"><a href="#ğŸš€é…ç½®" class="headerlink" title="ğŸš€é…ç½®"></a>ğŸš€é…ç½®</h2><p><strong>å®‰è£…åº“</strong>ï¼ˆå¯ä»¥å…ˆæ•´ä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒï¼‰ï¼Œå¤§éƒ¨åˆ†åº“ç‰ˆæœ¬è¦å¯¹ï¼Œè¦ä¸ç„¶å¾ˆå®¹æ˜“æŠ¥é”™ï¼Œç‰¹åˆ«æ˜¯transformersã€gradioã€numpyè¿™äº›ï¼Œå…¶ä»–åº“å®åœ¨ä¸è¡Œè£…æ–°ç‰ˆè¯•è¯•ã€‚</p>
<pre class="line-numbers language-bash"><code class="language-bash">pip <span class="token function">install</span> -r requirements.txt
pip <span class="token function">install</span> flash-attn --no-build-isolation
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="ğŸš€ä¸‹è½½æƒé‡"><a href="#ğŸš€ä¸‹è½½æƒé‡" class="headerlink" title="ğŸš€ä¸‹è½½æƒé‡"></a>ğŸš€ä¸‹è½½æƒé‡</h2><p><strong>ä¸‹è½½æƒé‡</strong>ï¼Œä»¥ä¸‹æ˜¯æ¯”è¾ƒæ–°çš„ï¼Œå¯ä»¥é€‰7Bæˆ–è€…13Bï¼ˆæœ¬æ–‡ç”¨çš„7Bï¼Œå› ä¸º4090Dæ˜¾å­˜<strong>åˆšå¥½ä¸å¤Ÿ</strong>è·‘bf16çš„13Bï¼‰ï¼Œæ”¾åˆ°è‡ªå®šä¹‰çš„ä½ç½®ã€‚å…¶ä¸­LISAåº”è¯¥æ˜¯ç›´æ¥åŒ…å«LLaVAå’ŒSAMçš„ï¼Œä¹Ÿå°±æ˜¯ç½‘ç»œç»“æ„å½“ä¸­çš„å…¨éƒ¨ã€‚å¦‚æœåªæ˜¯<strong>é¢„æµ‹å’Œè¯„ä¼°</strong>å°±åªéœ€è¦ä¸‹è½½LISAå’ŒLLaVAè§†è§‰ä¸»å¹²ï¼ˆç†è®ºä¸Šç¬¬äºŒä¸ªä¸ç”¨ä¸‹ï¼Œä½†æ˜¯ä»£ç é‡Œé¢ä¼¼ä¹æ˜¯å•ç‹¬è¯»å–æƒé‡çš„ï¼‰ï¼›å¦‚æœè¦<strong>å¾®è°ƒ</strong>å°±éœ€è¦LISAï¼ˆæˆ–LLaVAï¼‰ã€LLaVAè§†è§‰ä¸»å¹²ã€SAM-VIT-Hã€‚</p>
<ul>
<li><p>LISAï¼š<a target="_blank" rel="noopener" href="https://huggingface.co/xinlai/LISA-7B-v1">https://huggingface.co/xinlai/LISA-7B-v1</a></p>
</li>
<li><p>LLaVAè§†è§‰ä¸»å¹²ï¼š<a target="_blank" rel="noopener" href="https://huggingface.co/openai/clip-vit-large-patch14">https://huggingface.co/openai/clip-vit-large-patch14</a></p>
</li>
<li><p>LLaVAï¼š<a target="_blank" rel="noopener" href="https://huggingface.co/liuhaotian/LLaVA-Lightning-7B-delta-v1-1">https://huggingface.co/liuhaotian/LLaVA-Lightning-7B-delta-v1-1</a></p>
</li>
<li><p>SAM-VIT-Hï¼š<a target="_blank" rel="noopener" href="https://dl.fbaipublicfiles.com/segment_anything/sam_vit_h_4b8939.pth">https://dl.fbaipublicfiles.com/segment_anything&#x2F;sam_vit_h_4b8939.pth</a></p>
</li>
</ul>
<p>ä¸‹è½½å®Œæˆåï¼Œæ‰“å¼€LISAæƒé‡æ–‡ä»¶å¤¹ä¸­çš„config.jsonæ–‡ä»¶ï¼Œé‡Œé¢çš„<strong>vision_tower</strong>çš„è·¯å¾„åº”å½“æ”¹æˆ<strong>è§†è§‰ä¸»å¹²æ–‡ä»¶å¤¹</strong>çš„è·¯å¾„ã€‚</p>
<h2 id="ğŸš€æ•°æ®é›†"><a href="#ğŸš€æ•°æ®é›†" class="headerlink" title="ğŸš€æ•°æ®é›†"></a>ğŸš€æ•°æ®é›†</h2><p>æ•°æ®é›†ç”¨çš„è¿˜æ˜¯<a target="_blank" rel="noopener" href="https://zenodo.org/records/3697452/files/LabPicsV1.zip?download=1">LabPicsV1</a>ï¼Œæ˜¯ä¸€ä¸ªç›¸å¯¹ä¸å¤§æ•°æ®é›†ï¼Œç”¨äºè·‘é€šä»£ç å’Œè°ƒä¼˜æ–¹æ³•çš„å°è¯•ã€‚ä¸»è¦æ˜¯å¯¹å®¹å™¨åŠå…¶å†…éƒ¨çš„ææ–™ï¼ˆå›ºã€æ¶²ä½“ï¼‰è¿›è¡Œåˆ†å‰²ï¼Œå®ƒå…·æœ‰ä¸€å®šéš¾åº¦ä¸”ä½“é‡ä¸å¤§ï¼Œå¾ˆé€‚åˆåˆæ­¥å®éªŒã€‚</p>
<h1 id="ğŸ”¥LISAé¢„æµ‹"><a href="#ğŸ”¥LISAé¢„æµ‹" class="headerlink" title="ğŸ”¥LISAé¢„æµ‹"></a>ğŸ”¥LISAé¢„æµ‹</h1><h2 id="ğŸš€é¢„æµ‹è„šæœ¬"><a href="#ğŸš€é¢„æµ‹è„šæœ¬" class="headerlink" title="ğŸš€é¢„æµ‹è„šæœ¬"></a>ğŸš€é¢„æµ‹è„šæœ¬</h2><p>LISAæä¾›çš„è„šæœ¬å¯ä»¥ç›´æ¥å®Œæˆå¯¹è¯é¢„æµ‹ï¼Œåªéœ€è¦è¿è¡Œå…¶ä¸­çš„<strong>chat.py</strong>è„šæœ¬ã€‚</p>
<p>å‚æ•°å¦‚ä¸‹ï¼Œæœ€ä¸»è¦æ˜¯LLMçš„è·¯å¾„versionã€ç²¾åº¦precisionã€åŠ è½½4&#x2F;8bitæ¨¡å‹ã€è§†è§‰ä¸»å¹²çš„è·¯å¾„vision-towerã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse_args</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"LISA chat"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--version"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"./weight/lisa"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--vis_save_path"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"./vis_output/my"</span><span class="token punctuation">,</span> type<span class="token operator">=</span>str<span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span>
        <span class="token string">"--precision"</span><span class="token punctuation">,</span>
        default<span class="token operator">=</span><span class="token string">"bf16"</span><span class="token punctuation">,</span>
        type<span class="token operator">=</span>str<span class="token punctuation">,</span>
        choices<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"fp32"</span><span class="token punctuation">,</span> <span class="token string">"bf16"</span><span class="token punctuation">,</span> <span class="token string">"fp16"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        help<span class="token operator">=</span><span class="token string">"precision for inference"</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--image_size"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span> type<span class="token operator">=</span>int<span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">"image size"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--model_max_length"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span> type<span class="token operator">=</span>int<span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--lora_r"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> type<span class="token operator">=</span>int<span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span>
        <span class="token string">"--vision-tower"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"./weight/clip-vit-large-patch14"</span><span class="token punctuation">,</span> type<span class="token operator">=</span>str
    <span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--local-rank"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> type<span class="token operator">=</span>int<span class="token punctuation">,</span> help<span class="token operator">=</span><span class="token string">"node rank"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--load_in_8bit"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store_true"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--load_in_4bit"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store_true"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--use_mm_start_end"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">"store_true"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span>
        <span class="token string">"--conv_type"</span><span class="token punctuation">,</span>
        default<span class="token operator">=</span><span class="token string">"llava_v1"</span><span class="token punctuation">,</span>
        type<span class="token operator">=</span>str<span class="token punctuation">,</span>
        choices<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"llava_v1"</span><span class="token punctuation">,</span> <span class="token string">"llava_llama_2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span>args<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸»è¦æµç¨‹å’Œå¤§æ¨¡å‹çš„é¢„æµ‹å·®ä¸å¤šï¼š</p>
<ol>
<li><p>å‡†å¤‡ï¼šåŠ è½½åˆ†è¯å™¨ã€é…ç½®æ¨¡å‹å‚æ•°ã€åŠ è½½æ¨¡å‹ï¼ˆLLMå’Œè§†è§‰ä¸»å¹²ï¼‰ï¼›</p>
</li>
<li><p>å¯¹è¯ï¼šæ–‡æœ¬æ„å»ºã€è¯»å–å›¾ç‰‡å¹¶åµŒå…¥ã€æ–‡æœ¬åµŒå…¥ã€å›¾æ–‡è¾“å…¥åˆ°æ¨¡å‹ã€ç»˜åˆ¶å›¾ç‰‡å¹¶ä¿å­˜ã€‚</p>
</li>
</ol>
<p><img src="/2025/05/21/LISA%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8A%E6%89%8B%E5%92%8C%E5%BE%AE%E8%B0%83/%E5%AF%B9%E8%AF%9D%E5%92%8C%E9%A2%84%E6%B5%8B.png" alt="å¯¹è¯å’Œé¢„æµ‹"></p>
<p>è¿è¡Œè„šæœ¬åï¼Œè¾“å…¥æ–‡æœ¬å’Œå›¾ç‰‡è·¯å¾„å³å¯ï¼Œè‹±æ–‡æ•ˆæœå¥½ã€‚</p>
<h2 id="ğŸš€é¢„æµ‹æ•ˆæœ"><a href="#ğŸš€é¢„æµ‹æ•ˆæœ" class="headerlink" title="ğŸš€é¢„æµ‹æ•ˆæœ"></a>ğŸš€é¢„æµ‹æ•ˆæœ</h2><p>7Bæ¨¡å‹åœ¨4090Dä¸Šè¿è¡Œé€Ÿåº¦æœ€å¿«åº”è¯¥èƒ½åˆ°0.5så·¦å³ï¼Œæ…¢çš„ä¼š2sä»¥ä¸Šï¼ˆä¸€èˆ¬å°±æ˜¯0.5-1sï¼‰ï¼Œç®—æ˜¯ç›¸å½“å¿«äº†ï¼ˆSAM2å¯èƒ½éƒ½å¾—0.12sï¼‰ã€‚</p>
<p><img src="/2025/05/21/LISA%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8A%E6%89%8B%E5%92%8C%E5%BE%AE%E8%B0%83/%E5%AF%B9%E8%AF%9D%E6%95%88%E6%9E%9C.png" alt="å¯¹è¯æ•ˆæœ"></p>
<p><img src="/2025/05/21/LISA%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8A%E6%89%8B%E5%92%8C%E5%BE%AE%E8%B0%83/%E5%AF%B9%E8%AF%9D%E6%95%88%E6%9E%9C2.png" alt="å¯¹è¯æ•ˆæœ2"></p>
<p><img src="/2025/05/21/LISA%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8A%E6%89%8B%E5%92%8C%E5%BE%AE%E8%B0%83/%E5%AF%B9%E8%AF%9D%E6%95%88%E6%9E%9C3.jpeg" alt="whoÂ isÂ controllingÂ theÂ uav?"></p>
<p>å¯ä»¥çœ‹åˆ°æ¨¡å‹å¯¹æ–‡æœ¬çš„ç†è§£èƒ½åŠ›æ¯”è¾ƒå¥½åœ°åº”ç”¨åˆ°äº†å›¾åƒé¢†åŸŸï¼Œè¿™ç§æŠ½è±¡çš„ç†è§£èƒ½åŠ›æ˜¯ä¼ ç»Ÿæ¨¡å‹ä¸å¯èƒ½åšåˆ°çš„ã€‚</p>
<p><img src="/2025/05/21/LISA%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8A%E6%89%8B%E5%92%8C%E5%BE%AE%E8%B0%83/%E5%AF%B9%E8%AF%9D%E6%95%88%E6%9E%9C4.png" alt="findÂ theÂ usb-a"></p>
<p>å¯¹äºæ¯”è¾ƒä¸å¸¸è§çš„éœ€æ±‚ï¼Œæ¨¡å‹æ²¡æœ‰åŠæ³•è®¤è¯†ï¼Œè¿™è·Ÿæ•°æ®é›†çš„å¹¿åº¦æœ‰å…³ç³»ï¼Œå¦‚æœæœ‰éœ€æ±‚å¯ä»¥è¿›è¡ŒLoRAå¾®è°ƒï¼Œæœ‰æä¾›åˆå¹¶æƒé‡çš„è„šæœ¬ã€‚</p>
<h2 id="ğŸš€gradioå¯è§†åŒ–UI"><a href="#ğŸš€gradioå¯è§†åŒ–UI" class="headerlink" title="ğŸš€gradioå¯è§†åŒ–UI"></a>ğŸš€gradioå¯è§†åŒ–UI</h2><p><strong>app.py</strong>è„šæœ¬ä½¿ç”¨gradioè¿™ä¸ªwebUIåº“å®ç°äº†å¯è§†åŒ–é¢„æµ‹ï¼Œgr.Interfaceæ˜¯æŒ‰ç…§gradioå®˜æ–¹é¢„è®¾çš„é¡ºåºæ¸²æŸ“è¿™äº›ç»„ä»¶ï¼š</p>
<pre class="line-numbers language-python"><code class="language-python">demo <span class="token operator">=</span> gr<span class="token punctuation">.</span>Interface<span class="token punctuation">(</span>
    inference<span class="token punctuation">,</span>
    inputs<span class="token operator">=</span><span class="token punctuation">[</span>
        gr<span class="token punctuation">.</span>Textbox<span class="token punctuation">(</span>lines<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> placeholder<span class="token operator">=</span>None<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Text Instruction"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        gr<span class="token punctuation">.</span>Image<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">"filepath"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Input Image"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    outputs<span class="token operator">=</span><span class="token punctuation">[</span>
        gr<span class="token punctuation">.</span>Image<span class="token punctuation">(</span>type<span class="token operator">=</span><span class="token string">"pil"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Segmentation Output"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        gr<span class="token punctuation">.</span>Textbox<span class="token punctuation">(</span>lines<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> placeholder<span class="token operator">=</span>None<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Text Output"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    title<span class="token operator">=</span>title<span class="token punctuation">,</span>
    description<span class="token operator">=</span>description<span class="token punctuation">,</span>
    article<span class="token operator">=</span>article<span class="token punctuation">,</span>
    examples<span class="token operator">=</span>examples<span class="token punctuation">,</span>
    allow_flagging<span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2025/05/21/LISA%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8A%E6%89%8B%E5%92%8C%E5%BE%AE%E8%B0%83/gradio%E7%95%8C%E9%9D%A2.png" alt="gradioç•Œé¢"></p>
<p>å¯ä»¥çœ‹åˆ°æœ‰é¢„è®¾å¥½çš„æ ‡é¢˜ã€æè¿°ï¼Œä¸­é—´æ˜¯äº¤äº’ç•Œé¢ï¼Œåº•ä¸‹æœ‰ä¸€äº›æ ·ä¾‹ï¼Œç‚¹å‡»å¯ä»¥ç›´æ¥è£…å¡«åˆ°äº¤äº’åŒºåŸŸï¼Œgradioå¾ˆé€‚åˆä½œä¸ºéƒ¨ç½²çš„ä¸€ç§æ–¹æ¡ˆã€‚</p>
<h1 id="ğŸ”¥LISAè¯„ä¼°"><a href="#ğŸ”¥LISAè¯„ä¼°" class="headerlink" title="ğŸ”¥LISAè¯„ä¼°"></a>ğŸ”¥LISAè¯„ä¼°</h1><h2 id="ğŸš€datasetå’Œmetric"><a href="#ğŸš€datasetå’Œmetric" class="headerlink" title="ğŸš€datasetå’Œmetric"></a>ğŸš€datasetå’Œmetric</h2><p>ä¸‹é¢æ˜¯æ•°æ®é›†çš„ç±»ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> random
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset<span class="token punctuation">,</span> DataLoader
<span class="token keyword">import</span> os
<span class="token keyword">from</span> transformers <span class="token keyword">import</span> CLIPImageProcessor

<span class="token keyword">from</span> utils<span class="token punctuation">.</span>utils <span class="token keyword">import</span> <span class="token punctuation">(</span>DEFAULT_IM_END_TOKEN<span class="token punctuation">,</span> DEFAULT_IM_START_TOKEN<span class="token punctuation">,</span>
                         DEFAULT_IMAGE_TOKEN<span class="token punctuation">,</span> IMAGE_TOKEN_INDEX<span class="token punctuation">)</span>
<span class="token keyword">from</span> model<span class="token punctuation">.</span>llava <span class="token keyword">import</span> conversation <span class="token keyword">as</span> conversation_lib
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>utils <span class="token keyword">import</span> ANSWER_LIST<span class="token punctuation">,</span> SHORT_QUESTION_LIST

<span class="token comment" spellcheck="true"># å®šä¹‰ Dataset ç±»</span>
<span class="token keyword">class</span> <span class="token class-name">LabPicsDataset</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_dir<span class="token punctuation">,</span> transform<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>data_dir <span class="token operator">=</span> data_dir
        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transform
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_data<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_load_data</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        image_folder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_dir<span class="token punctuation">,</span> <span class="token string">"Image"</span><span class="token punctuation">)</span>
        annotation_folder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_dir<span class="token punctuation">,</span> <span class="token string">"Instance"</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>image_folder<span class="token punctuation">)</span><span class="token punctuation">:</span>
            image_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>image_folder<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
            annotation_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>annotation_folder<span class="token punctuation">,</span> name<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".png"</span><span class="token punctuation">)</span>
            data<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"image"</span><span class="token punctuation">:</span> image_path<span class="token punctuation">,</span> <span class="token string">"annotation"</span><span class="token punctuation">:</span> annotation_path<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> data

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        entry <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>entry<span class="token punctuation">[</span><span class="token string">"image"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># è¯»å–å›¾åƒå¹¶è½¬æ¢ä¸º RGB æ ¼å¼</span>
        annotation <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>entry<span class="token punctuation">[</span><span class="token string">"annotation"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># è¯»å–æ ‡æ³¨</span>

        <span class="token comment" spellcheck="true"># è°ƒæ•´å›¾åƒå¤§å°</span>
        r <span class="token operator">=</span> np<span class="token punctuation">.</span>min<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ç¼©æ”¾å› å­</span>
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token punctuation">(</span>int<span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        annotation <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>annotation<span class="token punctuation">,</span> <span class="token punctuation">(</span>int<span class="token punctuation">(</span>annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_NEAREST<span class="token punctuation">)</span>

        <span class="token keyword">if</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">:</span>
            image <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">-</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            annotation <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>annotation<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">-</span> annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">:</span>
            image <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">-</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            annotation <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>annotation<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">-</span> annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># åˆå¹¶ææ–™å’Œå®¹å™¨æ ‡æ³¨</span>
        mat_map <span class="token operator">=</span> annotation<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
        ves_map <span class="token operator">=</span> annotation<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
        mat_map<span class="token punctuation">[</span>mat_map <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> ves_map<span class="token punctuation">[</span>mat_map <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span>mat_map<span class="token punctuation">.</span>max<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># è·å–äºŒå€¼æ©ç å’Œç‚¹</span>
        inds <span class="token operator">=</span> np<span class="token punctuation">.</span>unique<span class="token punctuation">(</span>mat_map<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> len<span class="token punctuation">(</span>inds<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            ind <span class="token operator">=</span> inds<span class="token punctuation">[</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>len<span class="token punctuation">(</span>inds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token comment" spellcheck="true"># mask = (mat_map == ind).astype(np.uint8)</span>
            mask <span class="token operator">=</span> <span class="token punctuation">(</span>mat_map <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>           <span class="token comment" spellcheck="true"># å…¨éƒ¨maskåˆæˆä¸€ä¸ªï¼ˆå…¨éƒ¨é¢„æµ‹å‡ºæ¥ï¼‰</span>
            coords <span class="token operator">=</span> np<span class="token punctuation">.</span>argwhere<span class="token punctuation">(</span>mask <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            yx <span class="token operator">=</span> coords<span class="token punctuation">[</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>len<span class="token punctuation">(</span>coords<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            point <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>yx<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> yx<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># å¦‚æœæ²¡æœ‰æœ‰æ•ˆæ ‡æ³¨ï¼Œè¿”å›å…¨é›¶æ©ç å’Œéšæœºç‚¹</span>
            mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
            point <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">:</span>
            image <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span>

        <span class="token keyword">return</span> image<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>point<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯„ä¼°æŒ‡æ ‡å’ŒSAM2æ–‡æ¡£é‡Œé¢çš„ä¸€æ ·ï¼Œæœ‰IoUã€GIoUã€CIoUã€Diceã€PAã€BoundaryÂ F1ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>ndimage <span class="token keyword">import</span> binary_dilation<span class="token punctuation">,</span> binary_erosion
<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>spatial <span class="token keyword">import</span> ConvexHull

<span class="token keyword">def</span> <span class="token function">iou</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    è®¡ç®—äº¤å¹¶æ¯”ï¼ˆIoUï¼‰
    :param inputs: é¢„æµ‹çš„åˆ†å‰²ç»“æœï¼Œå½¢çŠ¶ä¸º [H, W]
    :param targets: çœŸå®çš„åˆ†å‰²æ ‡ç­¾ï¼Œå½¢çŠ¶ä¸º [H, W]
    :param num_objects: mask ä¸ªæ•°ï¼ˆç±»åˆ«æ•°ï¼‰
    :return: IoU å€¼
    """</span>
    iou_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_objects <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># å‡è®¾èƒŒæ™¯æ˜¯ 0ï¼Œä» 1 å¼€å§‹è®¡ç®—å„ä¸ªå¯¹è±¡çš„ IoU</span>
        pred_mask <span class="token operator">=</span> <span class="token punctuation">(</span>inputs <span class="token operator">==</span> i<span class="token punctuation">)</span>
        true_mask <span class="token operator">=</span> <span class="token punctuation">(</span>targets <span class="token operator">==</span> i<span class="token punctuation">)</span>
        intersection <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_and<span class="token punctuation">(</span>pred_mask<span class="token punctuation">,</span> true_mask<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
        union <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_or<span class="token punctuation">(</span>pred_mask<span class="token punctuation">,</span> true_mask<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> union <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            iou_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># å¦‚æœ union ä¸º 0ï¼ŒIoU å®šä¹‰ä¸º 1ï¼ˆç‰¹æ®Šæƒ…å†µå¤„ç†ï¼‰</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            iou_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>intersection <span class="token operator">/</span> union<span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>iou_list<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">giou</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    è®¡ç®— GIoU
    :param inputs: é¢„æµ‹çš„åˆ†å‰²ç»“æœï¼Œå½¢çŠ¶ä¸º [H, W]
    :param targets: çœŸå®çš„åˆ†å‰²æ ‡ç­¾ï¼Œå½¢çŠ¶ä¸º [H, W]
    :param num_objects: mask ä¸ªæ•°ï¼ˆç±»åˆ«æ•°ï¼‰
    :return: GIoU å€¼
    """</span>
    giou_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_objects <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># å‡è®¾èƒŒæ™¯æ˜¯ 0ï¼Œä» 1 å¼€å§‹è®¡ç®—å„ä¸ªå¯¹è±¡çš„ GIoU</span>
        pred_mask <span class="token operator">=</span> <span class="token punctuation">(</span>inputs <span class="token operator">==</span> i<span class="token punctuation">)</span>
        true_mask <span class="token operator">=</span> <span class="token punctuation">(</span>targets <span class="token operator">==</span> i<span class="token punctuation">)</span>
        
        <span class="token comment" spellcheck="true"># è®¡ç®—äº¤é›†å’Œå¹¶é›†</span>
        intersection <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_and<span class="token punctuation">(</span>pred_mask<span class="token punctuation">,</span> true_mask<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
        union <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_or<span class="token punctuation">(</span>pred_mask<span class="token punctuation">,</span> true_mask<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment" spellcheck="true"># å¦‚æœ union ä¸º 0ï¼Œç›´æ¥è¿”å› 1.0ï¼ˆç‰¹æ®Šæƒ…å†µå¤„ç†ï¼‰</span>
        <span class="token keyword">if</span> union <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            giou_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>

        pred_coords <span class="token operator">=</span> np<span class="token punctuation">.</span>argwhere<span class="token punctuation">(</span>pred_mask<span class="token punctuation">)</span>
        true_coords <span class="token operator">=</span> np<span class="token punctuation">.</span>argwhere<span class="token punctuation">(</span>true_mask<span class="token punctuation">)</span>
        all_coords <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>pred_coords<span class="token punctuation">,</span> true_coords<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> len<span class="token punctuation">(</span>all_coords<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            giou_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>

        <span class="token comment" spellcheck="true"># ä½¿ç”¨å‡¸åŒ…ä»£æ›¿ç›®æ ‡æ£€æµ‹ä¸­çš„æœ€å°å¤–æ¥çŸ©å½¢</span>
        hull <span class="token operator">=</span> ConvexHull<span class="token punctuation">(</span>all_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        hull_area <span class="token operator">=</span> hull<span class="token punctuation">.</span>volume  <span class="token comment" spellcheck="true"># 2D convex hull volume is the area</span>
        
        <span class="token comment" spellcheck="true"># è®¡ç®— GIoU</span>
        giou <span class="token operator">=</span> intersection <span class="token operator">/</span> union <span class="token operator">-</span> <span class="token punctuation">(</span>hull_area <span class="token operator">-</span> union<span class="token punctuation">)</span> <span class="token operator">/</span> hull_area
        giou_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>giou<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>giou_list<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">ciou</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    è®¡ç®— CIoU
    :param inputs: é¢„æµ‹çš„åˆ†å‰²ç»“æœï¼Œå½¢çŠ¶ä¸º [H, W]
    :param targets: çœŸå®çš„åˆ†å‰²æ ‡ç­¾ï¼Œå½¢çŠ¶ä¸º [H, W]
    :param num_objects: mask ä¸ªæ•°ï¼ˆç±»åˆ«æ•°ï¼‰
    :return: CIoU å€¼
    """</span>
    ciou_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_objects <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        pred_mask <span class="token operator">=</span> <span class="token punctuation">(</span>inputs <span class="token operator">==</span> i<span class="token punctuation">)</span>
        true_mask <span class="token operator">=</span> <span class="token punctuation">(</span>targets <span class="token operator">==</span> i<span class="token punctuation">)</span>
        
        <span class="token comment" spellcheck="true"># Iå’ŒU</span>
        intersection <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_and<span class="token punctuation">(</span>pred_mask<span class="token punctuation">,</span> true_mask<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
        union <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_or<span class="token punctuation">(</span>pred_mask<span class="token punctuation">,</span> true_mask<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> union <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            ciou_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        
        pred_coords <span class="token operator">=</span> np<span class="token punctuation">.</span>argwhere<span class="token punctuation">(</span>pred_mask<span class="token punctuation">)</span>
        true_coords <span class="token operator">=</span> np<span class="token punctuation">.</span>argwhere<span class="token punctuation">(</span>true_mask<span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> len<span class="token punctuation">(</span>pred_coords<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">or</span> len<span class="token punctuation">(</span>true_coords<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            ciou_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        
        <span class="token comment" spellcheck="true"># å¤–æ¥çŸ©å½¢</span>
        x_coords <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>pred_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> true_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        y_coords <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>pred_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> true_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        min_x<span class="token punctuation">,</span> max_x <span class="token operator">=</span> np<span class="token punctuation">.</span>min<span class="token punctuation">(</span>x_coords<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>max<span class="token punctuation">(</span>x_coords<span class="token punctuation">)</span>
        min_y<span class="token punctuation">,</span> max_y <span class="token operator">=</span> np<span class="token punctuation">.</span>min<span class="token punctuation">(</span>y_coords<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>max<span class="token punctuation">(</span>y_coords<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># è¾¹ç•Œæ¡†</span>
        pred_bbox <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>min<span class="token punctuation">(</span>pred_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>min<span class="token punctuation">(</span>pred_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                              <span class="token punctuation">[</span>np<span class="token punctuation">.</span>max<span class="token punctuation">(</span>pred_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>max<span class="token punctuation">(</span>pred_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        true_bbox <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>min<span class="token punctuation">(</span>true_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>min<span class="token punctuation">(</span>true_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                              <span class="token punctuation">[</span>np<span class="token punctuation">.</span>max<span class="token punctuation">(</span>true_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>max<span class="token punctuation">(</span>true_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># è¾¹ç•Œæ¡†å®½/é«˜</span>
        w_pred <span class="token operator">=</span> pred_bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> pred_bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
        h_pred <span class="token operator">=</span> pred_bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> pred_bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
        w_true <span class="token operator">=</span> true_bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> true_bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
        h_true <span class="token operator">=</span> true_bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> true_bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token comment" spellcheck="true"># ä¸¤æ¡†çš„ä¸­å¿ƒè·ç¦»</span>
        center_distance <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pred_bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> pred_bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token punctuation">(</span>true_bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> true_bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span>
                                  <span class="token punctuation">(</span><span class="token punctuation">(</span>pred_bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> pred_bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token punctuation">(</span>true_bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> true_bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># å¤–æ¥çŸ©å½¢é¢ç§¯</span>
        c <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>max_x <span class="token operator">-</span> min_x<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>max_y <span class="token operator">-</span> min_y<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">/</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>pi <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>arctan<span class="token punctuation">(</span>w_true <span class="token operator">/</span> h_true<span class="token punctuation">)</span> <span class="token operator">-</span> np<span class="token punctuation">.</span>arctan<span class="token punctuation">(</span>w_pred <span class="token operator">/</span> h_pred<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span>
        
        alpha <span class="token operator">=</span> v <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> intersection <span class="token operator">/</span> union <span class="token operator">+</span> v<span class="token punctuation">)</span>
        
        ciou <span class="token operator">=</span> intersection <span class="token operator">/</span> union <span class="token operator">-</span> <span class="token punctuation">(</span>center_distance <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> c <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">-</span> alpha <span class="token operator">*</span> v
        ciou_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ciou<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>ciou_list<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">dice</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    è®¡ç®— Dice ç³»æ•°
    :param inputs: é¢„æµ‹çš„åˆ†å‰²ç»“æœï¼Œå½¢çŠ¶ä¸º [H, W]
    :param targets: çœŸå®çš„åˆ†å‰²æ ‡ç­¾ï¼Œå½¢çŠ¶ä¸º [H, W]
    :param num_objects: mask ä¸ªæ•°ï¼ˆç±»åˆ«æ•°ï¼‰
    :return: Dice ç³»æ•°
    """</span>
    dice_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_objects <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># å‡è®¾èƒŒæ™¯æ˜¯ 0ï¼Œä» 1 å¼€å§‹è®¡ç®—å„ä¸ªå¯¹è±¡çš„ Dice</span>
        pred_mask <span class="token operator">=</span> <span class="token punctuation">(</span>inputs <span class="token operator">==</span> i<span class="token punctuation">)</span>
        true_mask <span class="token operator">=</span> <span class="token punctuation">(</span>targets <span class="token operator">==</span> i<span class="token punctuation">)</span>
        intersection <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_and<span class="token punctuation">(</span>pred_mask<span class="token punctuation">,</span> true_mask<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
        dice_value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">.</span> <span class="token operator">*</span> intersection<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pred_mask<span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> true_mask<span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        dice_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dice_value<span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>dice_list<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">pixel_accuracy</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    è®¡ç®—åƒç´ å‡†ç¡®åº¦
    :param inputs: é¢„æµ‹çš„åˆ†å‰²ç»“æœï¼Œå½¢çŠ¶ä¸º [H, W]
    :param targets: çœŸå®çš„åˆ†å‰²æ ‡ç­¾ï¼Œå½¢çŠ¶ä¸º [H, W]
    :param num_objects: mask ä¸ªæ•°ï¼ˆç±»åˆ«æ•°ï¼‰ï¼ˆè™½ç„¶è¿™é‡Œç”¨ä¸åˆ°ï¼Œä½†ä¿æŒæ¥å£ä¸€è‡´ï¼‰
    :return: åƒç´ å‡†ç¡®åº¦
    """</span>
    correct <span class="token operator">=</span> <span class="token punctuation">(</span>inputs <span class="token operator">==</span> targets<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
    total <span class="token operator">=</span> inputs<span class="token punctuation">.</span>size
    <span class="token keyword">return</span> correct <span class="token operator">/</span> total

<span class="token keyword">def</span> <span class="token function">boundary_f1_score</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    è®¡ç®—è¾¹ç•Œ F1 åˆ†æ•°
    :param inputs: é¢„æµ‹çš„åˆ†å‰²ç»“æœï¼Œå½¢çŠ¶ä¸º [H, W]
    :param targets: çœŸå®çš„åˆ†å‰²æ ‡ç­¾ï¼Œå½¢çŠ¶ä¸º [H, W]
    :param num_objects: mask ä¸ªæ•°ï¼ˆç±»åˆ«æ•°ï¼‰
    :return: è¾¹ç•Œ F1 åˆ†æ•°
    """</span>
    <span class="token comment" spellcheck="true"># åˆ›å»ºä¸€ä¸ªç»“æ„å…ƒç´ ç”¨äºè¾¹ç•Œæ£€æµ‹ï¼ˆè¿™é‡Œä½¿ç”¨ 3x3 çš„åå­—ç»“æ„ï¼‰</span>
    struct <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                       <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                       <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    f1_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_objects <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># å¯¹æ¯ä¸ªå¯¹è±¡è®¡ç®—è¾¹ç•Œ F1 åˆ†æ•°</span>
        <span class="token comment" spellcheck="true"># è·å–é¢„æµ‹å’ŒçœŸå®çš„ç›®æ ‡æ©ç </span>
        pred_mask <span class="token operator">=</span> <span class="token punctuation">(</span>inputs <span class="token operator">==</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        true_mask <span class="token operator">=</span> <span class="token punctuation">(</span>targets <span class="token operator">==</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

        <span class="token comment" spellcheck="true"># è®¡ç®—è¾¹ç•Œ</span>
        pred_boundary <span class="token operator">=</span> binary_dilation<span class="token punctuation">(</span>pred_mask<span class="token punctuation">,</span> struct<span class="token punctuation">)</span> <span class="token operator">^</span> binary_erosion<span class="token punctuation">(</span>pred_mask<span class="token punctuation">,</span> struct<span class="token punctuation">)</span>
        true_boundary <span class="token operator">=</span> binary_dilation<span class="token punctuation">(</span>true_mask<span class="token punctuation">,</span> struct<span class="token punctuation">)</span> <span class="token operator">^</span> binary_erosion<span class="token punctuation">(</span>true_mask<span class="token punctuation">,</span> struct<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># è®¡ç®— TPã€FPã€FN</span>
        tp <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_and<span class="token punctuation">(</span>pred_boundary<span class="token punctuation">,</span> true_boundary<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
        fp <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_and<span class="token punctuation">(</span>pred_boundary<span class="token punctuation">,</span> np<span class="token punctuation">.</span>logical_not<span class="token punctuation">(</span>true_boundary<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>
        fn <span class="token operator">=</span> np<span class="token punctuation">.</span>logical_and<span class="token punctuation">(</span>np<span class="token punctuation">.</span>logical_not<span class="token punctuation">(</span>pred_boundary<span class="token punctuation">)</span><span class="token punctuation">,</span> true_boundary<span class="token punctuation">)</span><span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># è®¡ç®—ç²¾ç¡®åº¦å’Œå¬å›ç‡</span>
        <span class="token keyword">if</span> tp <span class="token operator">+</span> fp <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            precision <span class="token operator">=</span> <span class="token number">0.0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            precision <span class="token operator">=</span> tp <span class="token operator">/</span> <span class="token punctuation">(</span>tp <span class="token operator">+</span> fp<span class="token punctuation">)</span>

        <span class="token keyword">if</span> tp <span class="token operator">+</span> fn <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            recall <span class="token operator">=</span> <span class="token number">0.0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            recall <span class="token operator">=</span> tp <span class="token operator">/</span> <span class="token punctuation">(</span>tp <span class="token operator">+</span> fn<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># è®¡ç®— F1 åˆ†æ•°</span>
        <span class="token keyword">if</span> precision <span class="token operator">+</span> recall <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            f1 <span class="token operator">=</span> <span class="token number">0.0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            f1 <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>precision <span class="token operator">*</span> recall<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>precision <span class="token operator">+</span> recall<span class="token punctuation">)</span>

        f1_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>f1<span class="token punctuation">)</span>

    <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>f1_list<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">estimate</span><span class="token punctuation">(</span>inputs_list<span class="token punctuation">,</span> targets_list<span class="token punctuation">,</span> num_objects<span class="token punctuation">,</span> metric_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> inputs<span class="token punctuation">,</span> targets <span class="token keyword">in</span> zip<span class="token punctuation">(</span>inputs_list<span class="token punctuation">,</span> targets_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>metric_name<span class="token punctuation">,</span> metric_func<span class="token punctuation">)</span><span class="token punctuation">,</span> score_list <span class="token keyword">in</span> metric_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            score_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>metric_func<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> num_objects<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> metric_dict
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ğŸš€è¯„ä¼°è„šæœ¬"><a href="#ğŸš€è¯„ä¼°è„šæœ¬" class="headerlink" title="ğŸš€è¯„ä¼°è„šæœ¬"></a>ğŸš€è¯„ä¼°è„šæœ¬</h2><p>è¯„ä¼°è„šæœ¬éœ€è¦æ ¹æ®chat.pyè¿›è¡Œä¿®æ”¹ï¼ŒæŠŠå®ƒæ”¹æˆå¯¹batchæ•°æ®çš„é¢„æµ‹å¹¶å¢åŠ è¯„ä¼°ç¯èŠ‚ã€‚ä»¥ä¸‹å±•ç¤ºä¸»è¦ä¿®æ”¹çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯batchå¾ªç¯é‡Œé¢çš„éƒ¨åˆ†ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python">    model<span class="token punctuation">.</span>eval<span class="token punctuation">(</span><span class="token punctuation">)</span>
    dataset <span class="token operator">=</span> LabPicsDataset<span class="token punctuation">(</span><span class="token string">"/media/zigaa/leofile/leosam2/assets/LabPicsV1/Simple/Test"</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    dataloader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
    
    metric_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token string">"IoU"</span><span class="token punctuation">,</span> iou<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"GIoU"</span><span class="token punctuation">,</span> giou<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"CIoU"</span><span class="token punctuation">,</span> ciou<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Dice"</span><span class="token punctuation">,</span> dice<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Pixel Accuracy"</span><span class="token punctuation">,</span> pixel_accuracy<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Boundary F1 Score"</span><span class="token punctuation">,</span> boundary_f1_score<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

    <span class="token keyword">for</span> batch_idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>image<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> input_point<span class="token punctuation">,</span> input_label<span class="token punctuation">)</span> <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        gt_masks <span class="token operator">=</span> mask<span class="token punctuation">.</span>float<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        gt_masks <span class="token operator">=</span> <span class="token punctuation">[</span>gt_masks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>gt_masks<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        conv <span class="token operator">=</span> conversation_lib<span class="token punctuation">.</span>conv_templates<span class="token punctuation">[</span>args<span class="token punctuation">.</span>conv_type<span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        conv<span class="token punctuation">.</span>messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        prompt <span class="token operator">=</span> <span class="token string">"show me all the vessels."</span>
        prompt <span class="token operator">=</span> DEFAULT_IMAGE_TOKEN <span class="token operator">+</span> <span class="token string">"\n"</span> <span class="token operator">+</span> prompt
        <span class="token keyword">if</span> args<span class="token punctuation">.</span>use_mm_start_end<span class="token punctuation">:</span>
            replace_token <span class="token operator">=</span> <span class="token punctuation">(</span>
                DEFAULT_IM_START_TOKEN <span class="token operator">+</span> DEFAULT_IMAGE_TOKEN <span class="token operator">+</span> DEFAULT_IM_END_TOKEN
            <span class="token punctuation">)</span>
            prompt <span class="token operator">=</span> prompt<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>DEFAULT_IMAGE_TOKEN<span class="token punctuation">,</span> replace_token<span class="token punctuation">)</span>

        conv<span class="token punctuation">.</span>append_message<span class="token punctuation">(</span>conv<span class="token punctuation">.</span>roles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> prompt<span class="token punctuation">)</span>
        conv<span class="token punctuation">.</span>append_message<span class="token punctuation">(</span>conv<span class="token punctuation">.</span>roles<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
        prompt <span class="token operator">=</span> conv<span class="token punctuation">.</span>get_prompt<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        t1 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        original_size_list <span class="token operator">=</span> <span class="token punctuation">[</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        image_clip <span class="token operator">=</span> <span class="token punctuation">(</span>
            clip_image_processor<span class="token punctuation">.</span>preprocess<span class="token punctuation">(</span>image<span class="token punctuation">,</span> return_tensors<span class="token operator">=</span><span class="token string">"pt"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>
                <span class="token string">"pixel_values"</span>
            <span class="token punctuation">]</span>
            <span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">if</span> args<span class="token punctuation">.</span>precision <span class="token operator">==</span> <span class="token string">"bf16"</span><span class="token punctuation">:</span>
            image_clip <span class="token operator">=</span> image_clip<span class="token punctuation">.</span>bfloat16<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> args<span class="token punctuation">.</span>precision <span class="token operator">==</span> <span class="token string">"fp16"</span><span class="token punctuation">:</span>
            image_clip <span class="token operator">=</span> image_clip<span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            image_clip <span class="token operator">=</span> image_clip<span class="token punctuation">.</span>float<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># image = transform.apply_image(image)</span>
        resize_list <span class="token operator">=</span> <span class="token punctuation">[</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        image <span class="token operator">=</span> image<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> args<span class="token punctuation">.</span>precision <span class="token operator">==</span> <span class="token string">"bf16"</span><span class="token punctuation">:</span>
            image <span class="token operator">=</span> image<span class="token punctuation">.</span>bfloat16<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> args<span class="token punctuation">.</span>precision <span class="token operator">==</span> <span class="token string">"fp16"</span><span class="token punctuation">:</span>
            image <span class="token operator">=</span> image<span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            image <span class="token operator">=</span> image<span class="token punctuation">.</span>float<span class="token punctuation">(</span><span class="token punctuation">)</span>

        input_ids <span class="token operator">=</span> tokenizer_image_token<span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> tokenizer<span class="token punctuation">,</span> return_tensors<span class="token operator">=</span><span class="token string">"pt"</span><span class="token punctuation">)</span>
        input_ids <span class="token operator">=</span> input_ids<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>

        output_ids<span class="token punctuation">,</span> pred_masks <span class="token operator">=</span> model<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>
            image_clip<span class="token punctuation">,</span>
            image<span class="token punctuation">,</span>
            input_ids<span class="token punctuation">,</span>
            resize_list<span class="token punctuation">,</span>
            original_size_list<span class="token punctuation">,</span>
            max_new_tokens<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>
            tokenizer<span class="token operator">=</span>tokenizer<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        output_ids <span class="token operator">=</span> <span class="token punctuation">[</span>row<span class="token punctuation">[</span>row <span class="token operator">!=</span> IMAGE_TOKEN_INDEX<span class="token punctuation">]</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> output_ids<span class="token punctuation">]</span>
        text_output <span class="token operator">=</span> <span class="token punctuation">[</span>tokenizer<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>o<span class="token punctuation">,</span> skip_special_tokens<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token keyword">for</span> o <span class="token keyword">in</span> output_ids<span class="token punctuation">]</span>
        text_output <span class="token operator">=</span> <span class="token punctuation">[</span>t<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"  "</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span> <span class="token keyword">for</span> t <span class="token keyword">in</span> text_output<span class="token punctuation">]</span>

        pred_masks <span class="token operator">=</span> <span class="token punctuation">[</span>p<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> pred_masks<span class="token punctuation">]</span>

        num_objects <span class="token operator">=</span> <span class="token number">1</span>
        metric_dict <span class="token operator">=</span> estimate<span class="token punctuation">(</span>pred_masks<span class="token punctuation">,</span> gt_masks<span class="token punctuation">,</span> num_objects<span class="token punctuation">,</span> metric_dict<span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>metric_name<span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">,</span> score_list <span class="token keyword">in</span> metric_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Average {metric_name}:"</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>score_list<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç»™å®šçš„æ–‡æœ¬æ˜¯â€ç³»ç»Ÿï¼šPleaseÂ findsÂ outÂ allÂ theÂ vesselsÂ inÂ theÂ picture.â€â€ç”¨æˆ·ï¼šshowÂ meÂ allÂ theÂ vessels.â€ï¼Œç¬¦åˆSAM2ä¹‹å‰çš„è®­ç»ƒä»»åŠ¡ï¼Œå°±æ˜¯åªåˆ†å‰²ä¸€ä¸ªmaskï¼Œåˆ†å‰²å‡ºæ‰€æœ‰å®¹å™¨å³å¯ã€‚ç²¾åº¦ç”¨çš„bf16ï¼Œfp32ä¼šè¶…4090Dæ˜¾å­˜ã€‚</p>
<h2 id="ğŸš€è¯„ä¼°ç»“æœ"><a href="#ğŸš€è¯„ä¼°ç»“æœ" class="headerlink" title="ğŸš€è¯„ä¼°ç»“æœ"></a>ğŸš€è¯„ä¼°ç»“æœ</h2><table>
<thead>
<tr>
<th>è§„æ¨¡</th>
<th>IoU</th>
<th>GIoU</th>
<th>CIoU</th>
<th>Dice</th>
<th>PA</th>
<th>F1</th>
</tr>
</thead>
<tbody><tr>
<td>LISA</td>
<td>0.784</td>
<td>0.438</td>
<td>0.766</td>
<td>0.857</td>
<td>0.967</td>
<td>0.276</td>
</tr>
<tr>
<td>SAM2(l) æ— å¾®è°ƒï¼Œ æ— æç¤º</td>
<td>0.516</td>
<td>0.071</td>
<td>0.477</td>
<td>0.588</td>
<td>0.921</td>
<td>0.130</td>
</tr>
<tr>
<td>SAM2(l) æ— å¾®è°ƒï¼Œæœ‰æç¤º</td>
<td>0.734</td>
<td>0.556</td>
<td>0.710</td>
<td>0.798</td>
<td>0.961</td>
<td>0.221</td>
</tr>
<tr>
<td>SAM2(l) å¾®è°ƒï¼Œ æ— æç¤º</td>
<td>0.895</td>
<td>0.632</td>
<td>0.884</td>
<td>0.938</td>
<td>0.988</td>
<td>0.291</td>
</tr>
</tbody></table>
<p>å¯ä»¥çœ‹åˆ°åœ¨æ²¡æœ‰å¾®è°ƒçš„æƒ…å†µä¸‹åŠç²¾åº¦çš„LISAçš„æ•ˆæœè¶…è¿‡äº†ä½¿ç”¨æç¤ºçš„SAM2ï¼Œå’Œé’ˆå¯¹è¯¥æ•°æ®é›†å¾®è°ƒçš„SAM2çš„largeæ¨¡å‹ï¼ˆæ— æç¤ºï¼‰ç›¸æ¯”è¿˜æœ‰å·®è·ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯è¿™é‡ŒSAM2ç”¨çš„æç¤ºæ˜¯ç›´æ¥æä¾›ç›®æ ‡maskä¸­çš„ä¸€ä¸ªç‚¹ï¼Œæ˜¯ä¸ç›®æ ‡é«˜åº¦ç›¸å…³çš„æå…¶æœ‰ç”¨çš„ä¿¡æ¯ï¼Œè€ŒLISAçš„æç¤ºè¯å¹¶æ²¡æœ‰è¿™ç§ä½œç”¨ã€‚</p>
<h1 id="ğŸ”¥LISAå¾®è°ƒ"><a href="#ğŸ”¥LISAå¾®è°ƒ" class="headerlink" title="ğŸ”¥LISAå¾®è°ƒ"></a>ğŸ”¥LISAå¾®è°ƒ</h1><p>ä¸ºäº†çœ‹çœ‹LISAçš„ä¸‹æ¸¸æ•°æ®é›†è®­ç»ƒæ•ˆæœå¦‚ä½•ï¼Œæ˜¯å¦èƒ½é€šè¿‡å¾®è°ƒæå‡å¯¹ç‰¹å®šå°æ•°æ®é›†çš„åˆ†å‰²æ•ˆæœï¼Œæˆ‘ä»¬å¯ä»¥å€Ÿç”¨<strong>train_ds.py</strong>è„šæœ¬è¿›è¡ŒLoRAå¾®è°ƒã€‚è¯¥è„šæœ¬æä¾›äº†å¾ˆå¤šä»»åŠ¡çš„è®­ç»ƒï¼Œæˆ‘ä»¬å°±åšæœ€ç®€å•çš„ä¸€æ¬¡åˆ†å‰²ä¸€ä¸ªmaskçš„ä»»åŠ¡å³å¯ã€‚</p>
<h2 id="ğŸš€dataset"><a href="#ğŸš€dataset" class="headerlink" title="ğŸš€dataset"></a>ğŸš€dataset</h2><p>è§‚å¯Ÿutilsä¸‹çš„HybridDatasetï¼ˆç®¡ç†æ‰€æœ‰ç›‘ç£ä»»åŠ¡çš„datasetï¼‰å’ŒSemSegDatasetï¼ˆå®˜æ–¹å…¶ä¸­ä¸€ä¸ªç›‘ç£ä»»åŠ¡çš„datasetï¼‰ï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ªæ ·æœ¬åº”å½“æœ‰åä¸ªæ•°æ®ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># SemSegDatasetçš„æ ·æœ¬</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> image<span class="token punctuation">,</span> image_clip<span class="token punctuation">,</span> conversations<span class="token punctuation">,</span>
        masks<span class="token punctuation">,</span> label<span class="token punctuation">,</span> resize<span class="token punctuation">,</span> questions<span class="token punctuation">,</span> sampled_classes<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># HybridDatasetçš„æ ·æœ¬ï¼Œå‰è€…åŒ…å«äº†ä¸Šé¢è¿™ä¹ä¸ªå˜é‡</span>
<span class="token keyword">return</span> <span class="token operator">*</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inference
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<table>
<thead>
<tr>
<th>å˜é‡</th>
<th>æè¿°</th>
<th>å˜é‡</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>image_path</td>
<td>å›¾åƒè·¯å¾„</td>
<td>label</td>
<td>æ•´å¼ å›¾çš„æ ‡æ³¨(å¼ é‡ï¼Œæ¯ä¸ªåƒç´ å±äºå“ªä¸€ç±»)</td>
</tr>
<tr>
<td>image</td>
<td>åŸå›¾åƒï¼ˆå¼ é‡ï¼‰</td>
<td>resize</td>
<td>å˜æ¢åçš„å›¾åƒå°ºå¯¸</td>
</tr>
<tr>
<td>image_clip</td>
<td>é¢„å¤„ç†åçš„å›¾åƒï¼ˆå„ç§å˜æ¢ï¼‰</td>
<td>questions</td>
<td>é—®é¢˜ï¼ˆå­—ç¬¦ä¸²ï¼‰</td>
</tr>
<tr>
<td>conversations</td>
<td>å¯¹è¯åˆ—è¡¨</td>
<td>sampled_classes</td>
<td>åˆ†ç±»åï¼ˆå­—ç¬¦ä¸²ï¼‰åˆ—è¡¨</td>
</tr>
<tr>
<td>masks</td>
<td>labelæ‹†åˆ†å‡ºæ¥çš„è‹¥å¹²ä¸ªæ©ç ï¼ˆå¼ é‡ï¼ŒåŒä¸€ç±»æ”¾åœ¨ä¸€ä¸ªmaskï¼‰</td>
<td>inference</td>
<td>æ˜¯å¦åšæ¨ç†ä»»åŠ¡</td>
</tr>
</tbody></table>
<p>æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æŠŠè‡ªå·±çš„datasetæ”¹å†™æˆè¿™ç§è¾“å‡ºå½¢å¼å°±å¯ä»¥é€‚é…å…¶è®­ç»ƒè„šæœ¬ï¼Œäºæ˜¯æˆ‘å†™äº†ä¸ªLabPicsDatasetForTrainç±»ä¸“é—¨ç”¨äºè®­ç»ƒï¼Œå¯ä¸è¯„ä¼°ç”¨çš„é‚£ä¸ªåˆ†å¼€ï¼ˆå¦‚ä¸‹ï¼‰ã€‚</p>
<ul>
<li><p>è¿™ä¸ªæ•°æ®é›†labelå…¶å®å°±æ˜¯maskäº†ï¼Œåªéœ€è¦é™ä¸€ä¸ªç»´åº¦ï¼›</p>
</li>
<li><p>åˆ†ç±»åè‡ªå·±è®¾è®¡ï¼Œæˆ‘ä»¬åˆ†å‰²çš„æ˜¯å®¹å™¨vesselsï¼Œè¿™ä¸ªåå­—ä¹Ÿå°±æ˜¯ç”¨äºç”Ÿæˆé—®é¢˜çš„è€Œå·²ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯ä»å®˜æ–¹é¢„è®¾çš„ä¸€äº›æ¨¡æ¿æŠ½å–çš„ã€‚</p>
</li>
</ul>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> random
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset<span class="token punctuation">,</span> DataLoader
<span class="token keyword">import</span> os
<span class="token keyword">from</span> transformers <span class="token keyword">import</span> CLIPImageProcessor

<span class="token keyword">from</span> utils<span class="token punctuation">.</span>utils <span class="token keyword">import</span> <span class="token punctuation">(</span>DEFAULT_IM_END_TOKEN<span class="token punctuation">,</span> DEFAULT_IM_START_TOKEN<span class="token punctuation">,</span>
                         DEFAULT_IMAGE_TOKEN<span class="token punctuation">,</span> IMAGE_TOKEN_INDEX<span class="token punctuation">)</span>
<span class="token keyword">from</span> model<span class="token punctuation">.</span>llava <span class="token keyword">import</span> conversation <span class="token keyword">as</span> conversation_lib
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>utils <span class="token keyword">import</span> ANSWER_LIST<span class="token punctuation">,</span> SHORT_QUESTION_LIST

<span class="token keyword">class</span> <span class="token class-name">LabPicsDatasetForTrain</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_dir<span class="token punctuation">,</span> tokenizer<span class="token punctuation">,</span> vision_tower<span class="token punctuation">,</span> transform<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>data_dir <span class="token operator">=</span> data_dir
        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transform
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>tokenizer <span class="token operator">=</span> tokenizer
        self<span class="token punctuation">.</span>clip_image_processor <span class="token operator">=</span> CLIPImageProcessor<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>vision_tower<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>short_question_list <span class="token operator">=</span> SHORT_QUESTION_LIST
        self<span class="token punctuation">.</span>answer_list <span class="token operator">=</span> ANSWER_LIST

    <span class="token keyword">def</span> <span class="token function">_load_data</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        image_folder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_dir<span class="token punctuation">,</span> <span class="token string">"Image"</span><span class="token punctuation">)</span>
        annotation_folder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_dir<span class="token punctuation">,</span> <span class="token string">"Instance"</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>image_folder<span class="token punctuation">)</span><span class="token punctuation">:</span>
            image_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>image_folder<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
            annotation_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>annotation_folder<span class="token punctuation">,</span> name<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".png"</span><span class="token punctuation">)</span>
            data<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"image"</span><span class="token punctuation">:</span> image_path<span class="token punctuation">,</span> <span class="token string">"annotation"</span><span class="token punctuation">:</span> annotation_path<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> data

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        entry <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>entry<span class="token punctuation">[</span><span class="token string">"image"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># è¯»å–å›¾åƒå¹¶è½¬æ¢ä¸º RGB æ ¼å¼</span>
        annotation <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>entry<span class="token punctuation">[</span><span class="token string">"annotation"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># è¯»å–æ ‡æ³¨</span>

        image_clip <span class="token operator">=</span> self<span class="token punctuation">.</span>clip_image_processor<span class="token punctuation">.</span>preprocess<span class="token punctuation">(</span>
                image<span class="token punctuation">,</span> return_tensors<span class="token operator">=</span><span class="token string">"pt"</span>
            <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"pixel_values"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true"># è°ƒæ•´å›¾åƒå¤§å°</span>
        r <span class="token operator">=</span> np<span class="token punctuation">.</span>min<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ç¼©æ”¾å› å­</span>
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token punctuation">(</span>int<span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        annotation <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>annotation<span class="token punctuation">,</span> <span class="token punctuation">(</span>int<span class="token punctuation">(</span>annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_NEAREST<span class="token punctuation">)</span>

        <span class="token keyword">if</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">:</span>
            image <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">-</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            annotation <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>annotation<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">-</span> annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">:</span>
            image <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">-</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            annotation <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>annotation<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">-</span> annotation<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># åˆå¹¶ææ–™å’Œå®¹å™¨æ ‡æ³¨</span>
        mat_map <span class="token operator">=</span> annotation<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
        ves_map <span class="token operator">=</span> annotation<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
        mat_map<span class="token punctuation">[</span>mat_map <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> ves_map<span class="token punctuation">[</span>mat_map <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span>mat_map<span class="token punctuation">.</span>max<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># è·å–äºŒå€¼æ©ç å’Œç‚¹</span>
        inds <span class="token operator">=</span> np<span class="token punctuation">.</span>unique<span class="token punctuation">(</span>mat_map<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> len<span class="token punctuation">(</span>inds<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            ind <span class="token operator">=</span> inds<span class="token punctuation">[</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>len<span class="token punctuation">(</span>inds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token comment" spellcheck="true"># mask = (mat_map == ind).astype(np.uint8)</span>
            mask <span class="token operator">=</span> <span class="token punctuation">(</span>mat_map <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>           <span class="token comment" spellcheck="true"># å…¨éƒ¨maskåˆæˆä¸€ä¸ªï¼ˆå…¨éƒ¨é¢„æµ‹å‡ºæ¥ï¼‰</span>
            coords <span class="token operator">=</span> np<span class="token punctuation">.</span>argwhere<span class="token punctuation">(</span>mask <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            yx <span class="token operator">=</span> coords<span class="token punctuation">[</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>len<span class="token punctuation">(</span>coords<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            point <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>yx<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> yx<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># å¦‚æœæ²¡æœ‰æœ‰æ•ˆæ ‡æ³¨ï¼Œè¿”å›å…¨é›¶æ©ç å’Œéšæœºç‚¹</span>
            mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
            point <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">.</span>float<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">:</span>
            image <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        resize <span class="token operator">=</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

        <span class="token comment" spellcheck="true"># æ–‡æœ¬</span>
        questions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        answers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        class_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        sampled_classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"vessels"</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> sampled_cls <span class="token keyword">in</span> sampled_classes<span class="token punctuation">:</span>
            text <span class="token operator">=</span> sampled_cls

            <span class="token keyword">assert</span> len<span class="token punctuation">(</span>text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"||"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>
            question_template <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>self<span class="token punctuation">.</span>short_question_list<span class="token punctuation">)</span>
            questions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>question_template<span class="token punctuation">.</span>format<span class="token punctuation">(</span>class_name<span class="token operator">=</span>text<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            answers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>self<span class="token punctuation">.</span>answer_list<span class="token punctuation">)</span><span class="token punctuation">)</span>

        conversations <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        conv <span class="token operator">=</span> conversation_lib<span class="token punctuation">.</span>default_conversation<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>

        i <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">(</span>questions<span class="token punctuation">)</span><span class="token punctuation">:</span>
            conv<span class="token punctuation">.</span>messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            conv<span class="token punctuation">.</span>append_message<span class="token punctuation">(</span>conv<span class="token punctuation">.</span>roles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> questions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            conv<span class="token punctuation">.</span>append_message<span class="token punctuation">(</span>conv<span class="token punctuation">.</span>roles<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> answers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            conversations<span class="token punctuation">.</span>append<span class="token punctuation">(</span>conv<span class="token punctuation">.</span>get_prompt<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            i <span class="token operator">+=</span> <span class="token number">1</span>

        <span class="token keyword">return</span> entry<span class="token punctuation">,</span> image<span class="token punctuation">,</span> image_clip<span class="token punctuation">,</span> conversations<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> mask<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> resize<span class="token punctuation">,</span> questions<span class="token punctuation">,</span> sampled_classes<span class="token punctuation">,</span> <span class="token boolean">False</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ğŸš€è®­ç»ƒè„šæœ¬"><a href="#ğŸš€è®­ç»ƒè„šæœ¬" class="headerlink" title="ğŸš€è®­ç»ƒè„šæœ¬"></a>ğŸš€è®­ç»ƒè„šæœ¬</h2><p>æœ‰äº†è¿™ä¸ªåªéœ€è¦æŠŠtrain_ds.pyçš„<strong>HybridDataset</strong>æ”¹æˆ<strong>LabPicsDatasetForTrain</strong>ï¼ˆ233è¡Œé™„è¿‘ï¼‰å°±å¯ä»¥è®­ç»ƒäº†ï¼Œä¸€äº›éœ€è¦æ”¹çš„è¶…å‚æ•°å¦‚ä¸‹è¡¨ï¼ˆæ˜¾å¡æ¡Œé¢4090Dï¼‰ï¼Œå…¶å®ƒå‚æ•°åŒ…æ‹¬æŸå¤±æƒé‡ã€loraè®­ç»ƒçš„å‚æ•°å°±ä¸ç”¨å¤ªå»æ”¹äº†ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python">    train_dataset <span class="token operator">=</span> LabPicsDatasetForTrain<span class="token punctuation">(</span><span class="token string">"/media/zigaa/leofile/leosam2/assets/LabPicsV1/Simple/Train"</span><span class="token punctuation">,</span> 
                                           tokenizer<span class="token operator">=</span>tokenizer<span class="token punctuation">,</span>
                                           vision_tower<span class="token operator">=</span>args<span class="token punctuation">.</span>vision_tower<span class="token punctuation">,</span>
                                           transform<span class="token operator">=</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<table>
<thead>
<tr>
<th>å‚æ•°å</th>
<th>æè¿°</th>
<th>å‚æ•°å€¼</th>
</tr>
</thead>
<tbody><tr>
<td>version</td>
<td>é¢„è®­ç»ƒLLaVAæƒé‡è·¯å¾„ï¼Œå¯ä»¥æ˜¯LISAå®Œæ•´æƒé‡</td>
<td>.&#x2F;weight&#x2F;lisa</td>
</tr>
<tr>
<td>precision</td>
<td>ç²¾åº¦ï¼ˆå‰å‘ä¼ æ’­ç­‰æ“ä½œï¼‰</td>
<td>bf16</td>
</tr>
<tr>
<td>image_size</td>
<td>å›¾åƒå°ºå¯¸</td>
<td>1024</td>
</tr>
<tr>
<td>vision-tower</td>
<td>LLaVAè§†è§‰ä¸»å¹²æƒé‡è·¯å¾„</td>
<td>.&#x2F;weight&#x2F;clip-vit-large-patch14</td>
</tr>
<tr>
<td>log_base_dir</td>
<td>è®°å½•æ¯æ¬¡è®­ç»ƒç”¨çš„æ–‡ä»¶å¤¹ï¼Œæ¯æ¬¡è®­ç»ƒçš„tensorboardå’Œæƒé‡éƒ½åœ¨é‡Œé¢</td>
<td>.&#x2F;runs</td>
</tr>
<tr>
<td>exp_name</td>
<td>è¿™æ¬¡è®­ç»ƒçš„åç§°ï¼Œlog_base_dirä¸‹ç”Ÿæˆè¯¥åç§°çš„æ–‡ä»¶å¤¹</td>
<td>lisa</td>
</tr>
<tr>
<td>epochs</td>
<td>è¿­ä»£æ•°</td>
<td>10</td>
</tr>
<tr>
<td>steps_per_epoch</td>
<td>æ¯ä¸€ä»£å¤šå°‘æ­¥</td>
<td>1500</td>
</tr>
<tr>
<td>batch_size</td>
<td>æ‰¹æ¬¡å¤§å°ï¼ˆä¹˜ä»¥steps_per_epochå°±æ˜¯ä¸€ä»£é‡‡æ ·æ•°ï¼‰ï¼Œæ˜¾å­˜ä¸å¤Ÿåªèƒ½1</td>
<td>1</td>
</tr>
<tr>
<td>grad_accumulation_steps</td>
<td>æ¢¯åº¦ç§¯ç´¯</td>
<td>20</td>
</tr>
<tr>
<td>lr</td>
<td>å­¦ä¹ ç‡ï¼ˆå¯ä»¥å¤§ç‚¹ï¼Œæœ‰å­¦ä¹ ç‡ä¸‹é™è°ƒåº¦å™¨ï¼‰</td>
<td>0.0008</td>
</tr>
<tr>
<td>ce_loss_weight</td>
<td>æ–‡æœ¬äº¤å‰ç†µæŸå¤±æƒé‡ï¼ˆè¿™æ¬¡ä¸»è¦è€ƒè™‘å›¾åƒï¼‰</td>
<td>0.2</td>
</tr>
<tr>
<td>no_eval</td>
<td>ä¸åšéªŒè¯ï¼ˆè®­ç»ƒä¸ä¹…æ²¡å¿…è¦åšï¼‰</td>
<td>True</td>
</tr>
<tr>
<td>vision_pretrained</td>
<td>SAMé¢„è®­ç»ƒæƒé‡è·¯å¾„</td>
<td>.&#x2F;weight&#x2F;sam_vit_h_4b8939.pth</td>
</tr>
</tbody></table>
<p>è®­ç»ƒè„šæœ¬å¾ˆé•¿ï¼Œä¸»è¦å› ä¸ºæ˜¯æ²¡æœ‰åšæ¨¡å—åŒ–è®¾è®¡çš„ï¼ˆä¸€ä¸ªè€é•¿çš„mainåŠ ä¸¤ä¸‰ä¸ªå‡½æ•°å°±æå®šäº†ï¼‰ï¼Œæ˜¯ä¸€ä¸ªLoRAå¾®è°ƒVLLMâ€”â€”ç‰¹åˆ«è¿˜æ˜¯èƒ½è¾“å‡ºå›¾åƒçš„VLLMçš„ä¸€ä¸ªä¸é”™çš„èŒƒæœ¬ã€‚</p>
<ul>
<li>mainå‡½æ•°ä¸»è¦æµç¨‹å°±æ˜¯ï¼š</li>
</ul>
<ol>
<li><p>åŠ è½½è¶…å‚æ•°ï¼Œåˆå§‹åŒ–æ¨¡å‹ï¼ˆåˆ†è¯å™¨ã€LISAã€LLaVAè§†è§‰ä¸»å¹²ï¼‰ï¼Œé…ç½®LoRAå‚æ•°ï¼›</p>
</li>
<li><p>åŠ è½½æ•°æ®é›†ï¼›</p>
</li>
<li><p>é…ç½®deepspeedå‚æ•°å¹¶åˆå§‹åŒ–ï¼›</p>
</li>
<li><p>è®­ç»ƒå¾ªç¯ï¼ˆè®­ç»ƒã€éªŒè¯ã€ä¿å­˜ï¼‰ã€‚</p>
</li>
</ol>
<ul>
<li><p>è®­ç»ƒå‡½æ•°å’Œä¸€èˆ¬æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒä¸€æ ·ï¼Œç”¨çš„æŸå¤±æ˜¯MaskBCELossï¼ˆåƒç´ çº§äº¤å‰ç†µï¼‰ã€MaskDICELossï¼ˆå’ŒIoUå·®ä¸å¤šï¼‰ã€CELossï¼ˆæ–‡æœ¬çš„äº¤å‰ç†µï¼‰ï¼Œå‰ä¸¤ä¸ªåŠ æƒåˆæˆMaskLossã€‚</p>
</li>
<li><p>éªŒè¯å‡½æ•°ä¹Ÿä¸å¤æ‚ï¼Œç”¨çš„æ˜¯GIOUå’ŒCIOUè¯„ä¼°æŒ‡æ ‡ï¼Œè€Œä¸æ˜¯æŸå¤±ã€‚</p>
</li>
</ul>
<h2 id="ğŸš€å¾®è°ƒ"><a href="#ğŸš€å¾®è°ƒ" class="headerlink" title="ğŸš€å¾®è°ƒ"></a>ğŸš€å¾®è°ƒ</h2><p>æ•°æ®é›†æ¥å…¥äº†è®­ç»ƒè„šæœ¬ï¼Œæ”¹å®Œäº†è¶…å‚æ•°ï¼Œå°±å¯ä»¥è®­ç»ƒï¼Œç”»é¢å¦‚ä¸‹ï¼ˆå‰é¢è¿˜ä¼šåŠ è½½ä¸€å †ä¸œè¥¿ï¼‰ï¼Œä¸­é—´å¯ä»¥ç”¨tensorboardçœ‹æŸå¤±ã€è¯„ä¼°ç­‰æ›²çº¿ã€‚</p>
<p><img src="/2025/05/21/LISA%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8A%E6%89%8B%E5%92%8C%E5%BE%AE%E8%B0%83/%E8%AE%AD%E7%BB%83%E7%95%8C%E9%9D%A2.png" alt="è®­ç»ƒç•Œé¢"></p>
<p><strong>è·å¾—å¾®è°ƒæƒé‡</strong>ï¼Œè®­ç»ƒå®Œæˆååœ¨ç»ˆç«¯è·‘ä»¥ä¸‹æŒ‡ä»¤ï¼Œå°±ä¼šåœ¨.&#x2F;runs&#x2F;lisaä¸‹ç”Ÿæˆpytorch_model.binæ–‡ä»¶å¤¹ï¼Œé‡Œé¢æ˜¯å®Œæ•´çš„LISAæƒé‡ï¼Œé‡Œé¢æ—¢æœ‰åŸæ¨¡å‹å†»ç»“çš„éƒ¨åˆ†ï¼Œä¹Ÿæœ‰LoRAæƒé‡ã€‚</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">cd</span> ./runs/lisa/ckpt_model <span class="token operator">&amp;&amp;</span> python zero_to_fp32.py <span class="token keyword">.</span> <span class="token punctuation">..</span>/pytorch_model.bin
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æˆåŠŸä¼šè¾“å‡ºå¦‚ä¸‹å†…å®¹ï¼Œ.&#x2F;runs&#x2F;lisa&#x2F;pytorch_model.biné‡Œé¢å°±æœ‰binç±»å‹çš„åˆ†ç‰‡æƒé‡æ–‡ä»¶ã€‚</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>2025-05-21 11:12:18,671<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span>real_accelerator.py:239:get_accelerator<span class="token punctuation">]</span> Setting ds_accelerator to cuda <span class="token punctuation">(</span>auto detect<span class="token punctuation">)</span>
Processing zero checkpoint <span class="token string">'./global_step300'</span>
Loading checkpoint shards: 100%<span class="token operator">|</span>â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ<span class="token operator">|</span> 1/1 <span class="token punctuation">[</span>00:00<span class="token operator">&lt;</span>00:00, 98.66it/s<span class="token punctuation">]</span>
Detected checkpoint of <span class="token function">type</span> zero stage 2, world_size: 1
Parsing checkpoint created by deepspeed<span class="token operator">==</span>0.16.7
Reconstructed Frozen fp32 state dict with 1155 params 7420682060 elements
Reconstructed fp32 state dict with 254 params 288259556 elements
Saving checkpoint shards: 100%<span class="token operator">|</span>â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ<span class="token operator">|</span> 4/4 <span class="token punctuation">[</span>00:13<span class="token operator">&lt;</span>00:00,  3.46s/it<span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>åˆå¹¶æƒé‡</strong>ï¼Œ<strong>merge_lora_weights_and_save_hf_model.py</strong>è„šæœ¬æä¾›äº†å°†ç”Ÿæˆçš„binæƒé‡å’ŒåŸæ¨¡å‹åˆå¹¶çš„åŠŸèƒ½ï¼Œå‚æ•°è¦æ”¹çš„å¦‚ä¸‹ã€‚</p>
<pre class="line-numbers language-python"><code class="language-python">  <span class="token operator">-</span><span class="token operator">-</span>version<span class="token operator">=</span><span class="token string">"./weight/lisa"</span> \
  <span class="token operator">-</span><span class="token operator">-</span>weight<span class="token operator">=</span><span class="token string">"./runs/lisa/pytorch_model.bin"</span> \
  <span class="token operator">-</span><span class="token operator">-</span>save_path<span class="token operator">=</span><span class="token string">"./weight/lisa_model_finetuned"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ä½†æ˜¯è„šæœ¬é‡Œé¢æœ‰ä¸€äº›é—®é¢˜ï¼Œå¦‚ä¸‹ï¼Œéœ€è¦æŠŠè„šæœ¬150è¡Œé™„è¿‘çš„torch.loadå‡½æ•°ï¼ˆæ³¨é‡Šéƒ¨åˆ†ï¼‰æ”¹æˆå‰é¢è¿™éƒ¨åˆ†ï¼Œä¹Ÿå°±è¦é€æ­¥è¯»å–4ä¸ªåˆ†ç‰‡æ–‡ä»¶åæ”¾åˆ°åŒä¸€ä¸ªstate_dicté‡Œé¢ï¼Œå†è¿›è¡Œåˆå¹¶ã€‚è¿è¡Œå®Œæˆæ²¡æŠ¥é”™å°±è¡Œã€‚åœ¨save_pathè·¯å¾„ä¸‹ä¼šç”ŸæˆHuggingÂ Faceæ ¼å¼çš„æƒé‡ï¼ˆå’ŒHFä¸‹è½½çš„æƒé‡ä¸€æ ·ï¼‰</p>
<pre class="line-numbers language-python"><code class="language-python">    state_dict <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># éå†æ‰€æœ‰åˆ†å‰²çš„æƒé‡æ–‡ä»¶</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        file_path <span class="token operator">=</span> f<span class="token string">'{args.weight}/pytorch_model-0000{i}-of-00004.bin'</span>
        state_dict_part <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> map_location<span class="token operator">=</span>torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cpu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        state_dict<span class="token punctuation">.</span>update<span class="token punctuation">(</span>state_dict_part<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># state_dict = torch.load(args.weight, map_location="cpu")</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ğŸš€è¯„ä¼°"><a href="#ğŸš€è¯„ä¼°" class="headerlink" title="ğŸš€è¯„ä¼°"></a>ğŸš€è¯„ä¼°</h2><table>
<thead>
<tr>
<th>è§„æ¨¡</th>
<th>IoU</th>
<th>GIoU</th>
<th>CIoU</th>
<th>Dice</th>
<th>PA</th>
<th>F1</th>
</tr>
</thead>
<tbody><tr>
<td>LISA-7B</td>
<td>0.784</td>
<td>0.438</td>
<td>0.766</td>
<td>0.857</td>
<td>0.967</td>
<td>0.276</td>
</tr>
<tr>
<td>LISA-7B å¾®è°ƒ</td>
<td>0.871</td>
<td>0.580</td>
<td>0.857</td>
<td>0.922</td>
<td>0.984</td>
<td>0.300</td>
</tr>
<tr>
<td>SAM2(l) å¾®è°ƒï¼Œ æ— æç¤º</td>
<td>0.895</td>
<td>0.632</td>
<td>0.884</td>
<td>0.938</td>
<td>0.988</td>
<td>0.291</td>
</tr>
</tbody></table>
<p>å¯ä»¥çœ‹åˆ°å¾®è°ƒåæœ‰å¾ˆæ˜æ˜¾çš„æå‡ï¼Œå’ŒSAM2å·®è·ä¹Ÿä¸å¤§ï¼Œè¿™ä¸ªä¹Ÿæš‚æ—¶ä¸æ˜¯æœ€ä¼˜çš„è®­ç»ƒç»“æœã€‚</p>
<h1 id="ğŸ”¥LISA-é¢„æµ‹"><a href="#ğŸ”¥LISA-é¢„æµ‹" class="headerlink" title="ğŸ”¥LISA++é¢„æµ‹"></a>ğŸ”¥LISA++é¢„æµ‹</h1><p>LISA++é¡¹ç›®æ•´ä½“ç»“æ„ä¸å˜ï¼Œå°±å¤šäº†ä¸ªchat_instance.pyç”¨äºé¢„æµ‹ï¼Œæ²¡æœ‰æä¾›æ–°çš„app.pyï¼Œé…ç½®æ–¹æ³•å’ŒLISAä¸€æ ·ã€‚</p>
<p><img src="/2025/05/21/LISA%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8A%E6%89%8B%E5%92%8C%E5%BE%AE%E8%B0%83/LISAplus%E5%AF%B9%E8%AF%9D%E6%95%88%E6%9E%9C.png" alt="LISApluså¯¹è¯æ•ˆæœ"></p>
<p><img src="/2025/05/21/LISA%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8A%E6%89%8B%E5%92%8C%E5%BE%AE%E8%B0%83/LISAplus%E5%AF%B9%E8%AF%9D%E6%95%88%E6%9E%9C2.jpeg" alt="LISApluså¯¹è¯æ•ˆæœ2"></p>
<p>whereÂ isÂ theÂ vesselÂ andÂ theÂ liquid?Â outputÂ theÂ segmentationÂ ofÂ them.</p>
<p>LISA++å¯¹å¤šç›®æ ‡éœ€æ±‚çš„ç†è§£èƒ½åŠ›å’Œå®é™…åˆ†å‰²æ•ˆæœéƒ½æ¯”LISAè¦å¼ºä¸€äº›ã€‚</p>
<p>ä½†æ˜¯ä¼¼ä¹æä¾›çš„æƒé‡ä¼¼ä¹å¹¶ä¸èƒ½åƒè®ºæ–‡ä¸­çš„é‚£æ ·å®Œæ•´æè¿°å›¾ç‰‡çš„åŒæ—¶è¾“å‡º[SEG]ï¼Œå¹¶ä¸”æš‚æ—¶æ²¡æœ‰æ‰¾åˆ°å¦‚ä½•æ ¹æ®ä¸€å¼ å›¾è¿›è¡Œå¤šè½®å¯¹è¯ï¼Œç›®å‰çœ‹æ¥å¯èƒ½æ˜¯ç”Ÿæˆæ•°æ®é›†æ—¶ç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œè¦å¤šè½®å¯¹è¯ä¼°è®¡å¾—åœ¨chat_instance.pyæ”¹ã€‚</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        åˆ†äº«
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://legendleochen.top/2025/05/21/LISA%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%B8%8A%E6%89%8B%E5%92%8C%E5%BE%AE%E8%B0%83/" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LISA/" rel="tag">LISA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LLM/" rel="tag">LLM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LORA/" rel="tag">LORA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PEFT/" rel="tag">PEFT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SAM2/" rel="tag">SAM2</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/VLLM/" rel="tag">VLLM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/" rel="tag">å›¾åƒåˆ†å‰²</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2025/06/12/SAM2%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88%E5%92%8C%E8%AF%A6%E7%BB%86%E8%A7%A3%E8%AF%BB/" class="article-nav-link">
        <strong class="article-nav-caption">ä¸Šä¸€ç¯‡</strong>
        <div class="article-nav-title">
          
            SAM2æ¶æ„æ¦‚è§ˆå’Œè¯¦ç»†è§£è¯»
          
        </div>
      </a>
    
    
      <a href="/2025/05/07/SAM2%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%BE%AE%E8%B0%83/" class="article-nav-link">
        <strong class="article-nav-caption">ä¸‹ä¸€ç¯‡</strong>
        <div class="article-nav-title">SAM2å›¾åƒåˆ†å‰²æ¨¡å‹çš„å¾®è°ƒ</div>
      </a>
    
  </nav>

  
   
  
    
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2023-2025
        <i class="ri-heart-fill heart_icon"></i> LegendLeo Chen
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>è®¿é—®äººæ•°:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>æµè§ˆæ¬¡æ•°:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzzç»Ÿè®¡ -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/mylogo.png" alt="LegendLeo Chen çš„ç©ºé—´"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">ğŸš€ä¸»é¡µ</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">ğŸ’¾å½’æ¡£</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">ğŸ§­åˆ†ç±»</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">ğŸ·ï¸æ ‡ç­¾</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">ğŸ›¸å…³äº</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/analytics">ğŸ“Šç»Ÿè®¡</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="æœç´¢">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>è¯·æˆ‘å–æ¯å’–å•¡å§~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">æ”¯ä»˜å®</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">å¾®ä¿¡</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // sliderå±•å¼€çŠ¶æ€
                // todo: è¿™æ ·ä¸å¥½ï¼Œåé¢æ”¹æˆçŠ¶æ€
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // è·å¾—åŸå›¾å°ºå¯¸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // ç­‰å¾…ä¸¤ç§’é’Ÿåæ¢å¤
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // ç­‰å¾…ä¸¤ç§’é’Ÿåæ¢å¤
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=1491212&auto=1&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    

  </div>
  <!-- èƒŒæ™¯æ°”æ³¡ -->
  <!--
  <div class="balls-container">
    <div class="balls-particles">
      <span style="--i:11;"></span>
      <span style="--i:12;"></span>
      <span style="--i:24;"></span>
      <span style="--i:10;"></span>
      <span style="--i:14;"></span>
      <span style="--i:23;"></span>
      <span style="--i:18;"></span>
      <span style="--i:16;"></span>
      <span style="--i:19;"></span>
      <span style="--i:20;"></span>
      <span style="--i:22;"></span>
      <span style="--i:25;"></span>
      <span style="--i:18;"></span>
      <span style="--i:21;"></span>
      <span style="--i:13;"></span>
      <span style="--i:15;"></span>
      <span style="--i:26;"></span>
      <span style="--i:17;"></span>
      <span style="--i:13;"></span>
      <span style="--i:26;"></span>
      <span style="--i:28;"></span>
      <span style="--i:11;"></span>
      <span style="--i:12;"></span>
      <span style="--i:24;"></span>
      <span style="--i:10;"></span>
      <span style="--i:14;"></span>
      <span style="--i:23;"></span>
      <span style="--i:18;"></span>
      <span style="--i:16;"></span>
      <span style="--i:19;"></span>
      <span style="--i:20;"></span>
      <span style="--i:22;"></span>
      <span style="--i:25;"></span>
      <span style="--i:18;"></span>
      <span style="--i:21;"></span>
      <span style="--i:13;"></span>
      <span style="--i:15;"></span>
      <span style="--i:26;"></span>
      <span style="--i:17;"></span>
      <span style="--i:13;"></span>
      <span style="--i:26;"></span>
      <span style="--i:28;"></span>
    </div>
  </div>
  <style>
    *
    {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    .balls-container
    { 
      position: fixed;
      top: 0px;
      left: 0px;
      width: 100%;
      height: 100vh;
      overflow: hidden;
      opacity: 0.3;
    }
    
    .balls-particles
    {
      position: fixed;
      display: flex;
      z-index: 3;
      padding: 0 20px;
    }
    
    .balls-particles span
    {
      position: relative;
      bottom: 30px;
      width: 30px;
      height: 30px;
      background-color: #4fc3dc;
      box-shadow: 0 0 0 10px #4fc3dc44,
      0 0 50px #4fc3dc,
      -100px 0 #4fc3dc99,
      100px 0 #ff2d7599;
      margin: 0 4px;
      border-radius: 50%;
      animation: animate 15s ease infinite;
      animation-delay: calc(125s / var(--i));
      transform: translateY(120vh);
    }
    .balls-particles span:nth-child(even) {
      background-color: #ff2d75;
      box-shadow: 0 0 0 10px #ff267544,
      0 0 50px #ff2d75,
      -100px 0 #4fc3dc99,
      100px 0 #4fc3dc99;
      ;
    }
    
    @keyframes animate {
      0%
      {
        transform: translateY(120vh) scale(0) rotate(0deg);
      }
      20%
      {
        transform: translateY(100vh) scale(1) rotate(0deg);
      }
      100%
      {
        transform: translateY(-50vh) scale(0.5) rotate(360deg);
      }
    }
  </style> -->
  <!-- åœ°æœˆç³»ç»Ÿ -->
  <!-- <div class="earth-container" >
    <div class="planet"></div>
    <div class="satellite"></div>
   </div>
   <style>
    *{
      padding: 0;
      margin: 0;
      }
      .earth-container {
        width: 36.25em;
        height: 36.25em;
        position: absolute;
        top:5%;
        left: 93%;
        transform: translate(-50%, -50%);
        opacity: 0.3;
      }
      
      .planet{
        width: 15.62*3em;
        height: 15.62*3em;
        background-color: #02c0f5;
        border-radius: 50%;
        position: absolute;
        margin: auto;
        top:0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1;
      }
      
      .planet::before{
        content: '';
        width: 4em;
        height: 4em;
        background-color: #008fd6;
        position: absolute;
        top:10em;
        left: 8em;
        border-radius: 50%; 
        box-shadow: 15em 15em 0 2em #00d68b, 5em 8em 0 3em #10ade1;
      }
      
      .satellite{
        width: 5em;
        height: 5em;
        background-color: #dee517;
        border-radius: 50%;
        position: relative;
        left: -5em;
        bottom: -30em;
        animation: spin 5s infinite;
        z-index: 1;
      }
      
      @keyframes spin {
        49%{
          z-index: 1;
        }
        50%{
          bottom: 3em;
          left: 35em;
          z-index: -1;
        }
        100%{
          z-index: -1;
        }
      }
    </style> -->
<!-- ä¸‰è§’å½©å¸¦èƒŒæ™¯ -->
  <canvas id="evanyou-canvas" style="opacity: 0.3; position: fixed; top: 0px; left: 0px; z-index: -1; width: 100%; height: 100%; pointer-events: none;"></canvas>
  <script src="https://cdn.jsdelivr.net/gh/XXXZhy/Blog_Image/js/evanyou_canvas.js"></script>
</body>

</html>